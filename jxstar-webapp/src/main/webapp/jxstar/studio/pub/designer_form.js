/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Jxstar.currentPage={parentEl:null,layoutEl:null,nodeId:"",compnum:0,colnums:2,designItems:null,designDDs:[],designResizes:[],initpos:{formx:10,formy:35,formi:10,colx:5,coly:5,coli:20,fieldx:5,fieldy:5,fieldi:8},initsize:{formw:720,formh:380,colw:220,colh:360,fieldw:200,fieldh:22},bgsize:{cols:6,rows:50,width:120,height:30},destroy:function(){var a=this;Ext.each(a.designDDs,function(b){b.unreg();b=null});Ext.each(a.designResizes,function(b){b.destroy(true);b=null});a.designDDs=null;a.designResizes=null},initWidth:function(b){var a=this;a.colnums=b;if(a.colnums==2){a.initsize.colw=340;a.initsize.fieldw=320}else{a.initsize.colw=220;a.initsize.fieldw=200}},render:function(d,p){var q=this;q.nodeId=d;q.initWidth(q.colnums);var f=p.getTopToolbar();var l=p.getComponent(0);if(l){l.removeAll(true);l.destroy();l=null;f.removeAll(true);f.add({text:" "})}l=new Ext.Panel({id:"des_form_panel",border:false});p.add(l);l.on("beforedestroy",function(){q.destroy();return true});var k=[{text:jx.fun.addrow,iconCls:"eb_add",handler:function(){q.createComponent("fdes-formitem")}},{text:jx.fun.addcol,iconCls:"eb_add",handler:function(){q.createComponent("fdes-columnitem")}},{text:jx.fun.addfld,iconCls:"eb_add",handler:function(){q.createComponent("fdes-fielditem")}}];var o=function(j){var i=j.text.split(" ")[0];q.initWidth(i)};var a=[{text:jx.fun.ctlprop,handler:function(){q.updateProp()}},{text:jx.fun.delctl,handler:function(){q.deleteComponent()}},{text:jx.fun.colnums,id:"menu_colnums",menu:{items:[{text:"2 cols",checked:true,group:"colsnum",checkHandler:o},{text:"3 cols",checked:false,group:"colsnum",checkHandler:o}]}},"-",{text:jx.wfx.exp,iconCls:"eb_exp",handler:function(){q.exportDesign()}}];f.add({text:jx.base.save,iconCls:"eb_save",handler:function(){q.saveDesign()}},{text:jx.fun.pub,iconCls:"eb_change",handler:function(){q.createPage()}},{text:jx.base.del,iconCls:"eb_delete",handler:function(){q.deleteDesign()}},{xtype:"tbseparator"},{text:jx.fun.synprop,iconCls:"eb_refresh",handler:function(){q.updateDesign()}},{text:jx.fun.setfld,iconCls:"eb_empty",handler:function(){q.selectField()}},{text:jx.fun.addlay,iconCls:"eb_form",handler:function(){q.createLayout(4,q.colnums)}},{text:jx.fun.setattr,iconCls:"eb_setattr",handler:function(){q.setattr()}},{xtype:"tbfill"},{xtype:"tbseparator"},{text:jx.fun.addctl,iconCls:"eb_menu",menu:k},{text:jx.wfx.extdo,iconCls:"eb_menu",menu:a});p.doLayout();q.parentEl=l.el;q.layoutEl=Ext.get(l.el.findParent("div.x-panel-body",2));var b=q.bgsize.height*q.bgsize.rows;q.parentEl.insertHtml("beforeEnd",'<div id="maincanvas" class="fdes-canvas x-unselectable" style="height:'+b+'px;"></div>');var c="";for(var h=0;h<q.bgsize.cols;h++){for(var g=0;g<q.bgsize.rows;g++){var n=10+g*q.bgsize.height;var e=10+h*q.bgsize.width;c+='<div class="fdes-grid x-unselectable" style="top:'+n+"px;left:"+e+'px;"></div>'}}q.parentEl.insertHtml("beforeEnd",c);var m=q.parentEl.getWidth();q.parentEl.insertHtml("beforeEnd",'<div id="maincanvas_tmp" class="fdes-canvas-bg x-unselectable" style="width:'+m+"px;height:"+b+'px;"></div>');q.initDd();q.readDesign()},createPage:function(){var a="funid=sys_fun_base&eventcode=createfd";a+="&selfunid="+this.nodeId+"&selpagetype=form&projectpath="+Jxstar.session.project_path;Request.postRequest(a,null)},setattr:function(){var a=this;var b={where_sql:"fun_attr.attr_type = ? and fun_attr.fun_id = ?",where_type:"string;string",where_value:"form;"+a.nodeId};var c=function(e){JxUtil.delay(500,function(){e.fkValue=a.nodeId;e.attr_type="form";Jxstar.loadData(e,b)})};var d=Jxstar.findNode("fun_attrdes");Jxstar.showData({filename:d.gridpage,title:d.nodetitle,width:760,height:350,nodedefine:d,callback:c})},saveDesign:function(){var a=this;a.clearSelectDivs();a.designItems=a.queryDesignItems();var g="";var b=Ext.get("maincanvas");var d=this.formItemToXML(b);if(d.length==0){return}if(a.hasNoSaveItem(a.designItems)){JxHint.alert(jx.fun.tip01);return}g="<?xml version='1.0' encoding='utf-8'?>\r";g+="<page state='design' colnums='"+a.colnums+"'>\r";g+=d;g+="</page>";var c=encodeURIComponent;var f="funid=sys_fun_base&eventcode=savefd";f+="&selfunid="+this.nodeId+"&selpagetype=form";f+="&content="+c(g);Request.postRequest(f,null)},exportDesign:function(){var a=Jxstar.path+"/jxstar/studio/pub/exp_form_design.jsp?funid="+this.nodeId;document.getElementById("frmhidden").src=a},reloadDesign:function(){var a=this;var b=function(){a.parentEl.select("div.fdes-fielditem, div.fdes-columnitem, div.fdes-formitem").remove();a.readDesign()};Ext.Msg.confirm(jx.base.hint,jx.fun.tip02,function(c){if(c=="yes"){b()}})},readDesign:function(){var b=(new Date()).getTime();var c=this;var d=function(j){if(j==null||j.length==0){JxHint.alert(jx.fun.tip03);return false}var f=Request.loadXML(j);var h=f.getElementsByTagName("page").item(0);var k=c.readAttrVal(h,"state","default");var g=c.readAttrVal(h,"colnums","2");c.initWidth(g);var i=Ext.getCmp("menu_colnums").menu;if(g=="3"){i.get(1).setChecked(true)}else{i.get(0).setChecked(true)}c.compnum=0;c.parseFormXML(h,k);c.insertCompHtml();var a=(new Date()).getTime();JxHint.hint("use time(ms): "+(a-b))};var e="funid=sys_fun_base&eventcode=query_formdes";e+="&selfunid="+this.nodeId+"&colnums="+this.colnums;Request.dataRequest(e,d,{type:"xml",wait:true})},deleteDesign:function(){var a=this;var b=function(){var c="funid=sys_fun_base&eventcode=deletefd";c+="&selfunid="+a.nodeId+"&selpagetype=form";Request.postRequest(c,function(){a.parentEl.select("div.fdes-fielditem, div.fdes-columnitem, div.fdes-formitem").remove();a.readDesign()})};Ext.Msg.confirm(jx.base.hint,jx.fun.tip04,function(c){if(c=="yes"){b()}})},updateDesign:function(){var a=this;var d=0;var b=function(j){var l=a.parentEl.query("div.fdes-fielditem");for(var k=0,e=l.length;k<e;k++){var p=l[k];var m=a.readAttrVal(p,"colcode","");if(m.length==0){continue}var h=j[m];if(h==null&&m.length>0){Ext.fly(p).remove();continue}var g=a.readAttrVal(p,"xtype","");if(h.xtype!=g&&g!="hidden"){if(!(h.xtype=="text"&&g=="area")){p.setAttribute("xtype",h.xtype);d++}}var o=a.readAttrVal(p,"title","");if(h.title!=o){p.setAttribute("title",h.title);p.innerHTML=h.title;d++}var f=a.readAttrVal(p,"visible","");if(h.visible=="false"&&f=="true"){p.setAttribute("visible",h.visible);Ext.fly(p).addClass("fdes-fieldhidden");d++}}JxHint.hint(String.format(jx.fun.syntip,d))};var c="funid=sys_fun_base&eventcode=query_field";c+="&selfunid="+a.nodeId;Request.dataRequest(c,b)},updateProp:function(){var j=this;if(j.selectDivs.length==0){JxHint.alert(jx.fun.tip05);return}if(j.selectDivs.length>1){JxHint.alert(jx.fun.tip06);return}var d=j.selectDivs[0];var c=Ext.fly(d);var e={};var g=jx.fun.setprop;var a=c.hasClass("fdes-formitem");if(a){g=jx.fun.setset;e={title:j.readAttrVal(d,"title",""),border:j.readAttrVal(d,"border","true")=="true",collapsible:j.readAttrVal(d,"collapsible","false")=="true",collapsed:j.readAttrVal(d,"collapsed","false")=="true"}}var h=c.hasClass("fdes-columnitem");if(h){return}var i=c.hasClass("fdes-fielditem");if(i){e={xtype:j.readAttrVal(d,"xtype",""),title:j.readAttrVal(d,"title",""),colcode:j.readAttrVal(d,"colcode",""),visible:j.readAttrVal(d,"visible","true")=="true"}}var f=new Ext.grid.PropertyGrid({border:false,width:300,source:e});f.getColumnModel().setColumnWidth(0,30);var b=new Ext.Window({title:g,layout:"fit",width:300,height:250,modal:true,closeAction:"close",items:[f],buttons:[{text:jx.base.ok,handler:function(){var k=f.getSource();if(i||a){d.setAttribute("title",k.title)}if(a){d.setAttribute("border",k.border.toString())}if(a){d.setAttribute("collapsible",k.collapsible.toString())}if(a){d.setAttribute("collapsed",k.collapsed.toString())}if(i){d.setAttribute("xtype",k.xtype)}if(i){d.setAttribute("colcode",k.colcode)}if(i){d.setAttribute("visible",k.visible.toString())}if(i){if(d.innerHTML!=k.title){d.innerHTML=k.title}if(k.visible==true||k.visible=="true"){Ext.fly(d).removeClass("fdes-fieldhidden")}else{Ext.fly(d).addClass("fdes-fieldhidden")}}b.close()}},{text:jx.base.cancel,handler:function(){b.close()}}]});b.show()},selectField:function(){var b=this;var a=function(j,i){var h=j.getStore();var g=h.getAt(i);var f=g.get("colcode");if(j.isSelected(i)){j.deselect(i);b.parentEl.select("div.fdes-fielditem[colcode="+f+"]").remove()}else{j.select(i);b.createComponent("fdes-fielditem",{colcode:f,xtype:g.get("xtype"),title:g.get("title"),visible:g.get("visible")})}};var e=function(k){var h=k.getStore();var g=b.parentEl.query("div.fdes-fielditem");for(var j=0,l=g.length;j<l;j++){var f=b.readAttrVal(g[j],"colcode");if(f.length>0){h.each(function(i){if(i.get("colcode")==f){k.select(i);return false}return true})}}};var c=function(h){var j=[];for(key in h){var g=h[key];if(g!==undefined){j[j.length]=[key,g.xtype,g.title,g.visible]}}var f=new Ext.data.ArrayStore({data:j,fields:["colcode","xtype","title","visible"]});var i=new Ext.ListView({store:f,style:"background-color:#fff;",hideHeaders:true,columns:[{header:jx.fun.name,dataIndex:"title",width:0.4},{header:jx.fun.code,dataIndex:"colcode",width:0.6}],listeners:{click:a,afterrender:e}});var k=new Ext.Window({title:jx.fun.selfld,layout:"fit",width:250,height:400,modal:true,closeAction:"close",items:[i]});k.show()};var d="funid=sys_fun_base&eventcode=query_field";d+="&selfunid="+b.nodeId;Request.dataRequest(d,c)},createLayout:function(m,k){var l=this;var e=l.initpos.formx;var c=l.getFormBottom()+10;var n=m*30+20;var g=l.initsize.formw;var b=l.createComponent("fdes-formitem",{left:e,top:c,width:g,height:n});for(var j=0;j<k;j++){var f=j*l.initsize.colw+j*20+e+5;var d=c+5;var h=l.initsize.colw;var a=m*30;var b=l.createComponent("fdes-columnitem",{left:f,top:d,width:h,height:a})}},getFormBottom:function(){var d=this;var b=d.parentEl.query("div.fdes-formitem");var a=0;for(var e=0,g=b.length;e<g;e++){var f=Ext.fly(b[e]);var c=f.getY()+f.getHeight();if(c>a){a=c}}if(a==0){a=25}else{a=a-d.parentEl.getY()}return a},createComponent:function(h,d){var g=this,d=d||{};var c="cust-comp"+g.compnum;var j=";top:"+(d.top||45)+"px;left:"+(d.left||750)+"px;";var b="",f="",a="",i=c;if(h=="fdes-formitem"){b="width:"+(d.width||g.initsize.formw)+";height:"+(d.height||g.initsize.formh)}else{if(h=="fdes-columnitem"){b="width:"+(d.width||g.initsize.colw)+";height:"+(d.height||g.initsize.colh)}else{if(d.title&&d.title.length>0){i=d.title;if(d.visible=="false"){f=" fdes-fieldhidden"}a+=' title="'+d.title+'"';a+=' colcode="'+d.colcode+'"';a+=' visible="'+d.visible+'"';a+=' xtype="'+d.xtype+'"'}b="width:"+g.initsize.fieldw+";height:"+g.initsize.fieldh}}var e="<div id="+c+' class="'+h+f+' x-unselectable" style="'+b+j+'"'+a+">"+i+"</div>";return g.createComponentByHtml(c,e)},createComponentByHtml:function(d,c){var a=this;a.compnum++;var b=a.parentEl.insertHtml("beforeEnd",c,true);a.addCompDD(b);return b},addCompHtml:function(b,a){this.compnum++;if(this.compHtml==undefined){this.compHtml=""}this.compHtml+=a},insertCompHtml:function(){var b=this;b.parentEl.insertHtml("beforeEnd",b.compHtml);var a="div.fdes-fielditem, div.fdes-columnitem, div.fdes-formitem";b.parentEl.select(a,true).each(b.addCompDD,b);b.compHtml=null;delete b.compHtml},addCompDD:function(c){var b=this;var a=new Ext.dd.DD(c.dom.id);a.setXConstraint(800,800,10);a.setYConstraint(1500,1500,10);b.designDDs.push(a);c.on("click",function(){var e=this,d=false;Ext.each(b.designResizes,function(g){if(g.getEl().id==e.id){d=true;return}});if(d){return}var f=new Ext.Resizable(e,{minWidth:120,minHeight:22});b.resizeForm(f);b.designResizes.push(f)});c.on("dblclick",function(){b.updateProp()});b.initClickEl(c)},resizeForm:function(c){var a=this;var b=c.getEl();if(b.hasClass("fdes-formitem")){c.on("beforeresize",function(e){var d=e.getEl();e.childCols=a.findChilds(d.dom,"div.fdes-columnitem");return true},a);c.on("resize",function(f,d,e){Ext.each(f.childCols,function(g){Ext.fly(g).setHeight(e-18)});f.childCols=null;return true},a)}},deleteComponent:function(){var a=this;if(a.selectDivs.length==0){JxHint.alert(jx.fun.tip07);return}Ext.each(a.selectDivs,function(b){Ext.fly(b).remove()});a.selectDivs=[]},parseFormXML:function(d,c){var k=this;var p=d.getElementsByTagName("formitem");var v=k.initpos.formx;var u=k.initpos.formy,a=u;for(var r=0,m=p.length;r<m;r++){if(c=="default"){u=(k.initsize.formh)*r+r*(k.initpos.formi)+a}var o=p.item(r);var f=k.readAttrVal(o,"x",v);var e=k.readAttrVal(o,"y",u);var j=k.readAttrVal(o,"width",k.initsize.formw);var t=k.readAttrVal(o,"height",k.initsize.formh);var l="form-comp"+k.compnum;var z=k.readAttrVal(o,"title","");var q=k.readAttrVal(o,"border","");var s=k.readAttrVal(o,"collapsible","");var b=k.readAttrVal(o,"collapsed","");var g='<div id="'+l+'" class="fdes-formitem x-unselectable" style="top:'+e+";left:"+f+";width:"+j+";height:"+t+';" title="'+z+'" border="'+q+'" collapsible="'+s+'" collapsed="'+b+'">F</div>';k.addCompHtml(l,g);k.parseColumnXML(o,c,f,e)}},parseColumnXML:function(r,e,b,a){var l=this;var d=r.getElementsByTagName("columnitem");var v=b+l.initpos.colx,c=v;var u=a+l.initpos.coly;for(var s=0,o=d.length;s<o;s++){if(e=="default"){v=(l.initsize.colw)*s+s*(l.initpos.coli)+c}var q=d.item(s);var g=l.readAttrVal(q,"x",v);var f=l.readAttrVal(q,"y",u);var k=l.readAttrVal(q,"width",l.initsize.colw);var t=l.readAttrVal(q,"height",l.initsize.colh);var m="col-comp"+l.compnum;var p=l.readAttrVal(q,"colwidth","0.33");var j='<div id="'+m+'" class="fdes-columnitem x-unselectable" style="top:'+f+";left:"+g+";width:"+k+";height:"+t+';" colwidth="'+p+'">C</div>';l.addCompHtml(m,j);l.parseFieldXML(q,e,g,f)}},parseFieldXML:function(d,f,k,j){var r=this;var a=d.getElementsByTagName("fielditem");var B=k+r.initpos.fieldx;var A=j+r.initpos.fieldy,b=A;for(var v=0,t=a.length;v<t;v++){if(f=="default"){A=(r.initsize.fieldh)*v+v*(r.initpos.fieldi)+b}var u=a.item(v);var o=r.readAttrVal(u,"x",B);var m=r.readAttrVal(u,"y",A);var q=r.readAttrVal(u,"width",r.initsize.fieldw);var z=r.readAttrVal(u,"height",r.initsize.fieldh);var s="field-comp"+r.compnum;var C=r.readAttrVal(u,"title");var l=r.readAttrVal(u,"colcode");var c=r.readAttrVal(u,"visible");var e=r.readAttrVal(u,"xtype");var g="";if(c=="false"){g="fdes-fieldhidden"}var p='<div id="'+s+'" class="fdes-fielditem x-unselectable '+g+'" style="top:'+m+";left:"+o+";width:"+q+";height:"+z+';" title="'+C+'" colcode="'+l+'" visible="'+c+'" xtype="'+e+'">'+C+"</div>";r.addCompHtml(s,p)}},queryDesignItems:function(){var c=this;var a=c.parentEl.query("div.fdes-formitem");var d=c.parentEl.query("div.fdes-columnitem");var b=c.parentEl.query("div.fdes-fielditem");return{form:a,column:d,field:b}},hasNoSaveItem:function(a){if(a.form.length>0){return true}if(a.column.length>0){return true}if(a.field.length>0){return true}return false},formItemToXML:function(r){var s=this;var k="";var a=s.findChilds(r,"div.fdes-formitem");if(a.length==0){JxHint.alert(jx.fun.tip08);return k}s.orderComponent(a,"y");if(!s.validCompRegion(a)){JxHint.alert(jx.fun.tip09);return k}for(var g=0,d=a.length;g<d;g++){var c=Ext.fly(a[g]);var p=c.getX()-s.parentEl.getX();var m=c.getY()-s.parentEl.getY();var q=c.getWidth();var j=c.getHeight();var b=s.readAttrVal(a[g],"id");var o=s.readAttrVal(a[g],"title");var e=s.readAttrVal(a[g],"border");var t=s.readAttrVal(a[g],"collapsible");var f=s.readAttrVal(a[g],"collapsed");var l=s.columnItemToXML(a[g]);if(l.length==0){return""}k+="\t<formitem x='"+p+"' y='"+m+"' width='"+q+"' height='"+j+"' id='"+b+"' title='"+o+"' border='"+e+"' collapsible='"+t+"' collapsed='"+f+"'>\r";k+=l;k+="\t</formitem>\r";s.designItems.form.remove(a[g])}return k},columnItemToXML:function(o){var p=this;var f="";var c=p.findChilds(o,"div.fdes-columnitem");if(c.length==0){JxHint.alert(jx.fun.tip10);return f}p.orderComponent(c,"x");if(!p.validCompRegion(c)){JxHint.alert(jx.fun.tip11);return f}for(var g=0,d=c.length;g<d;g++){var b=Ext.fly(c[g]);var l=b.getX()-p.parentEl.getX();var k=b.getY()-p.parentEl.getY();var m=b.getWidth();var j=b.getHeight();var a=p.readAttrVal(c[g],"id");var e=(m/(p.initsize.formw)).toFixed(2);if(e>=0.9){e=0.99}else{if(e>=0.6){e=0.66}else{if(e>0.45&&e<0.6){e=0.495}else{e=0.33}}}f+="\t\t<columnitem x='"+l+"' y='"+k+"' width='"+m+"' height='"+j+"' id='"+a+"' colwidth='"+e+"'>\r";f+=p.fieldItemToXML(c[g]);f+="\t\t</columnitem>\r";p.designItems.column.remove(c[g])}return f},fieldItemToXML:function(s){var t=this;var l="";var c=t.findChilds(s,"div.fdes-fielditem");t.orderComponent(c,"y");for(var j=0,d=c.length;j<d;j++){var b=Ext.fly(c[j]);var q=b.getX()-t.parentEl.getX();var o=b.getY()-t.parentEl.getY();var r=b.getWidth();var k=b.getHeight();var a=t.readAttrVal(c[j],"id");var p=t.readAttrVal(c[j],"title");var m=t.readAttrVal(c[j],"colcode");var f=t.readAttrVal(c[j],"visible","true");var e=t.readAttrVal(c[j],"xtype");var g=100;if(r<t.initsize.fieldw-30){g=parseInt(r*100/(t.initsize.fieldw))}if(k>(t.initsize.fieldh*1.5)){e="area"}if(f!="true"){e="hidden"}else{if(e=="hidden"){e="text"}}l+="\t\t\t<fielditem x='"+q+"' y='"+o+"' width='"+r+"' height='"+k+"' id='"+a+"' title='"+p+"' colcode='"+m+"' visible='"+f+"' xtype='"+e+"' anchor='"+g+"'/>\r";t.designItems.field.remove(c[j])}return l},readAttrVal:function(c,b,a){var d=c.getAttribute(b)||"";if(d.length==0){d=a||""}return d},orderComponent:function(a,h){var e,b,k=0;for(var g=0,c=a.length;g<c;g++){if(h=="x"){k=Ext.fly(a[g]).getX()}else{k=Ext.fly(a[g]).getY()}for(var f=g+1,d=a.length;f<d;f++){if(h=="x"){b=Ext.fly(a[f]).getX()}else{b=Ext.fly(a[f]).getY()}if(k>b){e=a[g];a[g]=a[f];a[f]=e;k=b}}}},validCompRegion:function(d){for(var l=0,e=d.length;l<e;l++){var s=Ext.fly(d[l]);var b=s.getX();var q=s.getY();var f=b+s.getWidth();var r=q+s.getHeight();for(var k=l+1,g=d.length;k<g;k++){var h=Ext.fly(d[k]);var a=h.getX();var p=h.getY();var c=a+h.getWidth();var o=p+h.getHeight();if((b<a&&f>a)&&(q<p&&r>p)){return false}if((q<p&&r>p)&&(b<c&&f>c)){return false}if((b<c&&f>c)&&(q<o&&r>o)){return false}if((q<o&&r>o)&&(b<a&&f>a)){return false}}}return true},findChilds:function(l,u){var r=this;var w=[],t=0;var j=Ext.fly(l);var o=j.getY();var q=o+j.getHeight();var a=j.getX();var b=a+j.getWidth();var h=r.parentEl.query(u);for(var v=0,s=h.length;v<s;v++){var f=Ext.fly(h[v]);var d=f.getX();var c=f.getY();var e=f.getWidth();var p=f.getHeight();var k=d+e/2;var g=c+p/2;if(k>=a&&k<=b&&g>=o&&g<=q){w[t++]=h[v]}}return w},selectDivs:[],selectDowned:false,selectOldXY:[],moveDowned:false,moveDownEl:null,moveOldX:0,moveOldY:0,moreDivPos:null,initDd:function(){var a=this;a.parentEl.on("mousedown",a.moreMouseDown,a);a.parentEl.on("mouseup",a.moreMouseUp,a);a.parentEl.on("mousemove",a.moreMouseMove,a)},moreMouseDown:function(f){var c=this;c.parentEl.select("#select_flag_div").remove();c.selectDowned=true;if(Ext.isIE){c.parentEl.dom.onselectstart=function(){return false}}var d=f.getXY();var b=c.parentEl.getXY();var a=d[0]-b[0];var g=d[1]-b[1];c.selectOldXY=[a,g];c.parentEl.insertHtml("afterBegin",'<div id="select_flag_div" class="fdes-selectdiv" style="left:'+a+"px;top:"+g+'px;"></div>')},moreMouseUp:function(d){var a=this;if(!a.selectDowned){return}a.clearSelectDivs();if(Ext.isIE){a.parentEl.dom.onselectstart=null}var c=a.parentEl.first("#select_flag_div");var b=a.findChilds(c,"div.fdes-fielditem, div.fdes-columnitem, div.fdes-formitem");a.flagSelectDivs(b);c.remove()},moreMouseMove:function(g){var l=this;if(!l.selectDowned){return}var c=l.parentEl.first("#select_flag_div");var m=g.getXY();var d=l.parentEl.getXY();var j=m[0]-d[0],i=m[1]-d[1];var b=l.selectOldXY[0],a=l.selectOldXY[1];var k=Math.abs(j-b);var f=Math.abs(i-a);c.setWidth(k);c.setHeight(f);if(j>b&&i<a){c.setTop(i)}else{if(j<b&&i<a){c.setTop(i);c.setLeft(j)}else{if(j<b&&i>a){c.setLeft(j)}}}},selectCss:function(d){var c=this.selectDivs;for(var b=0,e=c.length;b<e;b++){var a=Ext.fly(c[b]);if(d){a.addClass("fdes-selectcomp")}else{a.removeClass("fdes-selectcomp")}}},flagSelectDivs:function(b){if(b==null||b.length==0){return}var a=this;a.selectCss(false);a.selectDivs=b;a.selectCss(true);a.selectXY();a.moreDivPos=a.getMoreDivPos()},clearSelectDivs:function(){var a=this;a.selectCss(false);a.selectDivs=[];a.moreDivPos=null;a.selectDowned=false},isSelectDiv:function(c){var b=this.selectDivs;for(var a=0,e=b.length;a<e;a++){var d=b[a];if(c.id==d.id){return true}}return false},selectXY:function(){var a=this;var c=a.selectDivs;for(var b=0,d=c.length;b<d;b++){a.saveOldXY(c[b])}},saveOldXY:function(e){var b=Ext.fly(e);var a=this.layoutEl.getScroll();if(a.top!=0){var d=b.getX()+a.left;var c=b.getY()+a.top;e.oldXY=[d,c]}else{e.oldXY=b.getXY()}},initClickEl:function(b){var a=this;b.on("mousedown",function(c){a.oneMouseDown(b,c)});b.on("mousemove",function(c){a.oneMouseMove(c)});b.on("mouseup",function(c){a.oneMouseUp(c)})},oneMouseDown:function(d,c){var a=this;var b=a.isSelectDiv(d.dom,a.selectDivs);if(b){if(c.ctrlKey){d.removeClass("fdes-selectcomp");a.selectDivs.remove(d.dom);a.moreDivPos=a.getMoreDivPos()}else{if(a.selectDivs.length>1){a.moveOldX=d.getX();a.moveOldY=d.getY();a.moveDowned=true;a.moveDownEl=d}}}else{a.oneClickEl(d,c)}},oneMouseMove:function(d){var m=this;if(!m.moveDowned){return}var j=m.layoutEl.getScroll();var l=m.moveDownEl;var p=l.getX()-m.moveOldX-j.left;var o=l.getY()-m.moveOldY-j.top;var g=m.validMoreDivX(p);var f=m.validMoreDivY(o);for(var c=0,a=m.selectDivs.length;c<a;c++){var k=m.selectDivs[c];var h=Ext.fly(k);var b=k.oldXY;if(g){h.setX(b[0]+p)}if(f){h.setY(b[1]+o)}}},oneMouseUp:function(b){var a=this;if(!a.moveDowned){return}a.selectXY();a.moreDivPos=a.getMoreDivPos();a.moveOldX=0;a.moveOldY=0;a.moveDownEl=null;a.moveDowned=false},oneClickEl:function(d,c){var b=this;if(!c.ctrlKey){b.clearSelectDivs()}var a=b.selectDivs.length;b.selectDivs[a]=d.dom;d.addClass("fdes-selectcomp");b.saveOldXY(d.dom);b.moreDivPos=b.getMoreDivPos()},getMoreDivPos:function(){var q=this;var o=1000000;for(var e=0,c=q.selectDivs.length;e<c;e++){var j=Ext.fly(q.selectDivs[e]);if(j.getX()<o){o=j.getX()}}var l=1000000;for(var e=0,c=q.selectDivs.length;e<c;e++){var j=Ext.fly(q.selectDivs[e]);if(j.getY()<l){l=j.getY()}}var p=0;for(var e=0,c=q.selectDivs.length;e<c;e++){var j=Ext.fly(q.selectDivs[e]);var k=j.getX()+j.getWidth();if(k>p){p=k}}var f=0;for(var e=0,c=q.selectDivs.length;e<c;e++){var j=Ext.fly(q.selectDivs[e]);var a=j.getY()+j.getHeight();if(a>f){f=a}}var b=p-o;var m=f-l;var d=q.parentEl.getXY();var h=o-d[0];var g=l-d[1];return{x:h,y:g,width:b,height:m}},validMoreDivX:function(e){var b=this;var c=0;var d=b.parentEl.getWidth();var f=b.moreDivPos.x;var a=b.moreDivPos.width;if((f+e)<c){return false}if((f+a+e)>(c+d)){return false}return true},validMoreDivY:function(d){var a=this;var b=0;var f=a.parentEl.getHeight()-20;var e=a.moreDivPos.y;var c=a.moreDivPos.height;return true}};