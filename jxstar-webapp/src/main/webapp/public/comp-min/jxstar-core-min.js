/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
jdLang={};JxLang={};(function(){var a=function(){Ext.fly("label_company").dom.innerHTML=jx.index.company+" "+jx.index.right+" 2010";Ext.fly("label_usercode").dom.innerHTML=jx.index.usercode;Ext.fly("label_userpass").dom.innerHTML=jx.index.userpass;document.title=jx.index.proname+" V1.0"};Ext.apply(JxLang,{BASE:"zh",type:"zh",showLang:function(e,f){if(e.length>0){this.type=e}if(f.length==0){return}var d="";var c=f.split(";");for(var b=0,h=c.length;b<h;b++){var g=c[b].split("=");d+='<a href="#" onclick="JxLang.selectLang(\''+g[0]+"');\">"+g[1]+"</a>&nbsp;"}Ext.fly("td_language").insertHtml("beforeEnd",d)},selectLang:function(b){if(b==this.type){return}this.type=b;jx=null;jeLang=null;jfLang=null;jdLang=null;jdLang={};ComboData=null;if(Ext.isIE){CollectGarbage()}JxUtil.loadJS("public/lib/ext/locale/ext-lang-"+b+".js",true);JxUtil.loadJS("/public/locale/jxstar-lang-"+b+".js",true);JxUtil.loadJS("/public/locale/fun-lang-"+b+".js",true);JxUtil.loadJS("/public/locale/event-lang-"+b+".js",true);JxUtil.loadJS("/public/locale/combo-lang-"+b+".js",true);a()},eventLang:function(f,b){if(this.type==this.BASE){return}if(Ext.isEmpty(jeLang)){return}var e,c=b.eventCode;var d=jeLang[f];if(d){e=d[c]}if(Ext.isEmpty(e)){e=(jeLang.sysevent)[c]}if(!Ext.isEmpty(e)){b.text=e}},moduleText:function(b,d){if(this.type==this.BASE){return d}if(Ext.isEmpty(jfLang)){return d}var c=jfLang.module[b];return(c)?c:d},funText:function(d,c){if(this.type==this.BASE){return c}if(Ext.isEmpty(jfLang)){return c}var b=jfLang.fun[d];return(b)?b:c},fieldLang:function(d){var c=jdLang[d];if(c){return c}var b="/public/locale/field/"+d+"-lang-"+this.type+".js";JxUtil.loadJS(b,true);return jdLang[d]},formText:function(b,h){for(var e=0,j=b.length;e<j;e++){var d=b[e].name,c=b[e].fieldLabel;if(d&&c&&h){var g=h[d];if(g){b[e].fieldLabel=g}}var f=b[e].items;if(f&&f.length>0){JxLang.formText(f,h)}}},gridField:function(f,c){if(this.type==this.BASE){return}if(c==null||c.length==0){return}if(f==null||f.length==0){return}var e=this.fieldLang(f);if(e==null){return}for(var b=0,g=c.length;b<g;b++){if(c[b].col==null||c[b].field==null){continue}var d=e[c[b].field.name];if(d){c[b].col.header=d}}},formField:function(d,b){if(this.type==this.BASE){return}if(b==null||b.length==0){return}if(d==null||d.length==0){return}var c=this.fieldLang(d);JxLang.formText(b,c)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
SessionTimer={};(function(){Ext.apply(SessionTimer,{timeLogout:0,warnDialog:null,SESSION_TIMEOUT:30*60,resetTimer:function(){this.timeLogout=this.SESSION_TIMEOUT},startTimer:function(){var c=this.timeLogout;this.timeLogout=c-1;var a=1*60;if(c==0){this.signedOut()}else{if(c<=a){var b=this;var d=function(){b.warnDialog=null;b.resetTimer();var e="funid=queryevent&eventcode=cond_query";e+="&selfunid=login";Request.dataRequest(e,null)};if(this.warnDialog==null){window.focus();this.warnDialog=Ext.MessageBox.show({title:jx.base.hint,msg:c+jx.base.exitsys,buttons:Ext.MessageBox.OK,animEl:"mb9",fn:d,width:200,icon:Ext.MessageBox.INFO})}else{this.warnDialog.updateText(c+jx.base.exitsys)}}}window.setTimeout("SessionTimer.startTimer()",1000)},signedOut:function(){JxUtil.logout(true);JxUtil.isLogout=true;window.location.href=Jxstar.path}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");Jxstar.GridNode=function(a){this.config=a;this.param=a.param;this.selectModel=this.param.selectModel||"";this.nodeId=this.param.funid;this.pageType=this.param.isedit=="1"?"editgrid":"grid";this.define=Jxstar.findNode(this.nodeId);this.event=new Jxstar.GridEvent(this.define);this.page=null;this.parentNodeId="";this.state="0";this.right={edit:"1",print:"1",audit:"1",other:"1"};if(this.state=="0"){JxLang.gridField(this.nodeId,this.param.cols)}};Jxstar.GridNode.prototype={showPage:function(b,a){if(b!=null){this.pageType=b;if(b=="subgrid"&&this.param.isedit=="1"){this.pageType="subeditgrid"}if(b=="grid"&&this.param.isedit=="1"){this.pageType="editgrid"}if(b=="check"){this.pageType="chkgrid"}}if(a!=null){this.parentNodeId=a}if(!this.createPage()){return}this.extEvent();if(this.pageType.indexOf("notool")<0){this.createTool()}this.initPage();return this.page},createCmAndStore:function(j){if(j==null||j.length==0){JxHint.alert(jx.node.nofields);return false}var q=this;var f=[];var k=[];var b=0,l=0;if(!q.param.noRowNum){var g=new Ext.grid.RowNumberer({renderer:function(r,s,i,t){if(this.rowspan){s.cellAttr='rowspan="'+this.rowspan+'"'}return t+1+Jxstar.startNo}});k[b]=g;b++}var e=(q.pageType=="notoolgrid")||(q.pageType=="combogrid");var c=null;if(q.selectModel=="check"||(q.selectModel==""&&!e)){if(q.sm==null){c=new Ext.grid.CheckboxSelectionModel()}else{c=q.sm}k[b]=c;b++}if(q.param.plugins!=null){k[b]=q.param.plugins;b++}for(var d=0;d<j.length;d++){var n=j[d].col;if(n==null){continue}var h=j[d].field;if(h!=null){f[l++]=h;n.dataIndex=h.name;n.id=h.name}k[b++]=n}var p=new Ext.grid.ColumnModel(k);var a=Jxstar.path+"/commonAction.do?eventcode=query_data&funid=queryevent&pagetype="+q.pageType;a+="&query_funid="+q.nodeId+"&user_id="+Jxstar.session.user_id;if(q.param.queryurl){a=q.param.queryurl;if(a.indexOf("&user_id=")<0){a+="&user_id="+Jxstar.session.user_id}}var o=new Ext.data.Store({proxy:new Ext.data.HttpProxy({method:"POST",url:a,listeners:{exception:function(r,i,v,u,t,s){o.removeAll();JxUtil.errorResponse(t)}}}),reader:new Ext.data.JsonReader({root:"data.root",totalProperty:"data.total"},f),remoteSort:true,sortInfo:q.param.sorts,pruneModifiedRecords:true});o.on("beforeload",function(){Jxstar.startNo=0});var m=function(s,r){Jxstar.st=(new Date()).getTime();var i=s.getModifiedRecords();if(i.length>0){if(confirm(jx.node.reloaddata)){q.event.editSave();return false}}return true};o.on("beforeload",m);q.sm=c;q.cm=p;q.store=o;q.noCheck=e},storeLoad:function(d){var c=this;Jxstar.loadDataBc(c.page);var h=Jxstar.systemVar.show__use__time;if(Ext.isEmpty(h)||h=="1"){Jxstar.et=(new Date()).getTime();var e=Jxstar.et-Jxstar.st;JxHint.hint("use time(ms): "+e)}var b=c.param.autoHeight;var g=c.page.findParentByType("form");if(g&&(Ext.isEmpty(b)||b)){var f=d.getCount();if(f<5){f=5}var a=26*4+f*21;c.page.ownerCt.setHeight(a);g.doLayout()}},reconfigGrid:function(a){var b=this;var c=b.page;b.createCmAndStore(a);c.getBottomToolbar().bindStore(b.store);b.store.on("load",b.storeLoad,b);c.reconfigure(b.store,b.cm)},createPage:function(){var a=this;var d=null;a.createCmAndStore(a.param.cols);var f=true;if(a.state=="0"&&a.define.showInForm){f=false}var c={border:f,loadMask:true,columnLines:true,store:a.store,cm:a.cm,sm:a.sm,stripeRows:true,enableHdMenu:(a.state!="0"),enableColumnMove:(a.state!="0"),clicksToEdit:1};if(a.param.plugins!=null){c.plugins=a.param.plugins}if(a.pageType.indexOf("notool")<0){var b=new Ext.ux.ToolbarKeyMap();var e={deferHeight:true,plugins:b,items:[{text:" "}]};if(Ext.isIE){e.style="padding:1px;"}var h=new Ext.Toolbar(e);c.tbar=h}if(a.state=="0"&&a.pageType.indexOf("notool")<0&&!a.param.hidePageTool&&!a.define.showInForm){c.bbar=new Ext.PagingToolbar({deferHeight:true,pageSize:Jxstar.pageSize,store:a.store,plugins:(a.pageType!="combogrid")?new Ext.ux.JxPagerTool():null,displayInfo:(a.pageType!="combogrid"),displayMsg:"共 {2} 条",emptyMsg:jx.node.datano})}var g=a.param.pageConfig;if(!Ext.isEmpty(g)){Ext.apply(c,g)}if(a.pageType.indexOf("edit")>=0||(a.pageType=="chkgrid"&&a.param.isedit=="1")){d=new Ext.grid.EditorGridPanel(c)}else{d=new Ext.grid.GridPanel(c)}if(d.isXType("editorgrid")){d.on("beforeedit",function(j){var i=j.record;var o=a.define.auditcol;var t=i.get(o);var q="0",p="2",n="6";if(a.define.status){q=a.define.status.audit0;p=a.define.status.audit2}var k=j.grid.getTopToolbar();var m=JxUtil.getButton(k,"save_eg_chk");if(t==p&&m){return true}if(t==null||t.length==0){t=q}if(t!=q&&t!=n){return false}if(a.right.edit=="0"){return false}var l=JxUtil.getButton(k,"save_eg");if(l==null||l.disabled){return false}return true});d.on("keydown",function(k){if(k.getKey()==k.ENTER){var j=this;var l=JxUtil.getRowNum(j);var i=JxUtil.getEditCol(j);if(l<0){l=0}j.startEditing(l,i)}},d)}else{d.on("rowdblclick",function(i,k,j){if(a.pageType=="grid"||a.pageType=="chkgrid"){a.event.showForm()}else{if(a.pageType=="subgrid"){a.event.showSubForm()}else{if(a.pageType=="import"){a.event.imp()}else{if(a.pageType=="imptype"){a.event.impType()}}}}})}d.getSelectionModel().on("rowselect",function(i,k,j){d.selectKeyId=j.get(a.define.pkcol)});a.store.on("load",a.storeLoad,a);d.on("beforedestroy",function(i){a.sm=null;delete a.sm;a.cm=null;delete a.cm;a.store=null;delete a.store;a.noCheck=null;delete a.noCheck;i.pkName=null;delete i.pkName;i.fkName=null;delete i.fkName;i.fkValue=null;delete i.fkValue;i.pageType=null;delete i.pageType;i.isShow=null;delete i.isShow;i.selectKeyId=null;delete i.selectKeyId;i.jxstarParam=null;delete i.jxstarParam;i.gridNode.destroy();i.gridNode=null;delete i.gridNode;i.cmpTree=null;delete i.cmpTree;i.treeNodeAttr=null;delete i.treeNodeAttr;if(i.qryCt){Ext.destroy(i.qryCt,i.qryCt.el)}i.qryCt=null;delete i.qryCt;i=null;return true});if(a.selectModel=="row"||a.noCheck){d.getSelectionModel().singleSelect=true}d.jxstarParam={};d.pkName=a.define.pkcol;d.fkName=a.define.fkcol;d.isShow=a.param.isshow;d.pageType=a.pageType;d.gridNode=a;a.event.setPage(d);a.page=d;if(a.state=="0"&&(a.param.hasQuery==null||a.param.hasQuery==true)){if((Jxstar.systemVar.useCase=="1"||a.param.showQryCase)&&!a.param.showNotQryCase){d.on("render",function(i){if(Ext.isEmpty(i.tbar)){return}i.qryCt=new Ext.Container({renderTo:i.tbar,style:"padding:1px;",cls:"tool-query x-small-editor",height:26})})}}return true},createTool:function(){var c="funid=queryevent&eventcode=query_loadtb&selpfunid="+this.parentNodeId;if(this.state=="1"){c+="&selfunid=sys_fun_base&selpagetype=desgrid"}else{c+="&selfunid="+this.nodeId+"&selpagetype="+this.pageType}var a=this;var b=function(v){if(a.page==null||v==null){return}var q=v.buttons;var w=v.right;if(w){a.right=w}var g=a.event;var d=a.page.getTopToolbar();var k=0;var l=[];for(var t=0,r=q.length;t<r;t++){JxLang.eventLang(a.nodeId,q[t]);var f=q[t].accKey;if(!Ext.isEmpty(f)){q[t].text=q[t].text+"("+f.toUpperCase()+")";q[t].keyBinding={key:f,ctrl:true,alt:true};}var s=q[t].showType;if(q[t].method.length>0){var u=g[q[t].method];if(u==null){continue}var x=q[t].args;if(q[t].method=="customEvent"){x=[q[t].eventCode]}q[t].scope=g;if(x!=null&&x.length>0){q[t].handler=u.createDelegate(g,x)}else{u=u.createInterceptor(function(h){return !(h.disabled)});q[t].handler=u}}var o=Ext.util.CSS.getRule("."+q[t].iconCls);if(o==null&&s!="menu"){q[t].iconCls="eb_empty"}var p=q[t].eventIndex;if(p==null||p.length==0){p="0"}p=parseInt(parseInt(p)/100);if(p>k){if(t>0){if(l.length>0){l[l.length]="-"}else{d.add("-")}}k=p}if(s=="menu"){l[l.length]=q[t]}else{d.add(q[t])}}var m=a.config.toolext;if(a.state=="0"&&m&&typeof m=="function"){m(a,d,l)}if(l.length>0){var e=new Ext.menu.Menu({items:l});d.add({eventCode:"ext_menu",text:jx.node.extmenu,iconCls:"eb_menu",menu:e})}if(a.state=="0"&&(a.param.hasQuery==null||a.param.hasQuery==true)){d.add("->");if(Jxstar.systemVar.useCase=="1"){if(a.param.showNotQryCase){Jxstar.createSimpleQuery(a)}else{JxQueryExt.showCase(a);if(a.param.showStat){JxGroupExt.showCase(a)}}}else{if(a.param.showQryCase){JxQueryExt.showCase(a);if(a.param.showStat){JxGroupExt.showCase(a)}}else{Jxstar.createSimpleQuery(a)}}}if(a.state=="0"&&a.define.showInForm&&!a.param.hidePageTool){var j=new Ext.PagingToolbar({border:false,style:"padding:0;border-width:0;background:transparent repeat-x 0 -1px;",store:a.page.getStore(),pageSize:20});d.add("-",j);j.inputItem.setHeight(18);d.doLayout()}if(d.items!=null&&d.items.getCount()==1){d.hide()}else{d.doLayout()}};Request.dataRequest(c,b)},extEvent:function(){var b=this;var a=this.config.eventcfg;if(a){Ext.apply(this.event,a)}},initPage:function(){var b=this;var a=this.config.initpage;if(typeof a=="function"){a(b)}},setState:function(a){this.state=a},destroy:function(){this.config=null;delete this.config;this.param=null;delete this.param;this.selectModel=null;delete this.selectModel;this.nodeId=null;delete this.nodeId;this.pageType=null;delete this.pageType;this.id=null;delete this.id;this.define=null;delete this.define;this.event.myDestroy();this.event=null;delete this.event;this.page=null;delete this.page;this.parentNodeId=null;delete this.parentNodeId;this.state=null;delete this.state;this.right=null;delete this.right}};
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");Jxstar.FormNode=function(a){this.config=a;this.param=a.param;this.nodeId=this.param.funid;this.pageType="form";this.define=Jxstar.findNode(this.nodeId);this.event=new Jxstar.FormEvent(this.define);this.page=null;this.parentNodeId="";this.state="0";this.right={edit:"1",print:"1",audit:"1",other:"1"};if(this.state=="0"){JxLang.formField(this.nodeId,this.param.items)}};Jxstar.FormNode.prototype={showPage:function(b,a){if(b!=null){this.pageType=b}if(a!=null){this.parentNodeId=a}if(!this.createPage()){return}this.extEvent();this.createTool();this.initPage();return this.page},createPage:function(){var i=this,h=i.param;if(h==null||h.items==null||h.items.length==0){JxHint.alert(jx.node.nofields);return false}var d=new Ext.ux.ToolbarKeyMap();var e={deferHeight:true,plugins:d,items:[{text:" "}]};if(Ext.isIE){e.style="padding:1px;"}var f=new Ext.Toolbar(e);if(h.items[0]){var b=h.formWidth||800;if(typeof b=="string"){h.items[0].anchor=b}else{h.items[0].width=b}}var c={labelAlign:h.labelAlign||"right",labelWidth:h.labelWidth||120,border:true,autoScroll:true,frame:false,tbar:f,items:h.items};var g=i.param.pageConfig;if(!Ext.isEmpty(g)){Ext.apply(c,g)}var a=new Ext.form.FormPanel(c);a.on("afterrender",function(k){var j=k.getWidth();if(j<800){k.getComponent(0).setWidth(j-20)}JxUtil.focusFirst(k)});a.on("beforedestroy",function(j){var k=j.getForm();k.myGrid=null;delete k.myGrid;k.myRecord=null;delete k.myRecord;k.myStore=null;delete k.myStore;k.fkName=null;delete k.fkName;k.fkValue=null;delete k.fkValue;k.srcEvent=null;delete k.srcEvent;j.formNode.destroy();j.formNode=null;delete j.formNode;j=null;return true});a.formNode=i;i.event.setPage(a);i.page=a;return true},createTool:function(){var c="funid=queryevent&eventcode=query_loadtb&selpfunid="+this.parentNodeId;if(this.state=="1"){c+="&selfunid=sys_fun_base&selpagetype=desform"}else{c+="&selfunid="+this.nodeId+"&selpagetype="+this.pageType}var a=this;var b=function(w){if(a.page==null||w==null){return}var r=w.buttons;var v=w.right;if(v){a.right=v}var k=a.event;var l=a.page.getTopToolbar();var m=0;var f=[];for(var p=0,j=r.length;p<j;p++){JxLang.eventLang(a.nodeId,r[p]);var g=r[p].accKey;if(!Ext.isEmpty(g)){r[p].text=r[p].text+"("+g.toUpperCase()+")";r[p].keyBinding={key:g,ctrl:true,alt:true};}var o=r[p].showType;if(r[p].method.length>0){var q=k[r[p].method];if(q==null){continue}var t=r[p].args;if(r[p].method=="customEvent"){t=[r[p].eventCode]}r[p].scope=k;if(t!=null&&t.length>0){r[p].handler=q.createDelegate(k,t)}else{q=q.createInterceptor(function(h){return !(h.disabled)});r[p].handler=q}}var d=Ext.util.CSS.getRule("."+r[p].iconCls);if(d==null&&o!="menu"){r[p].iconCls="eb_empty"}var u=r[p].eventIndex;if(u==null||u.length==0){u="0"}u=parseInt(parseInt(u)/100);if(u>m){if(p>0){l.add("-")}m=u}if(o=="menu"){f[f.length]=r[p]}else{l.add(r[p])}}var s=a.config.toolext;if(s&&typeof s=="function"){s(a,l,f)}if(f.length>0){var e=new Ext.menu.Menu({items:f});l.add({text:jx.node.extmenu,iconCls:"eb_menu",menu:e})}if(l.items!=null&&l.items.getCount()==1){l.hide()}else{l.doLayout()}};Request.dataRequest(c,b)},extEvent:function(){var b=this;var a=this.config.eventcfg;if(a){Ext.apply(this.event,a)}},initPage:function(){var a=this;a.page.getForm().fieldItems().each(function(d){var c=d.name;if(c!=null&&c.length>0){d.on("change",JxUtil.changeValue);d.on("specialkey",JxUtil.specialKey)}});JxFormSub.formShowSub(a);var b=a.config.initpage;if(typeof b=="function"){b(a)}},setState:function(a){this.state=a},destroy:function(){this.config=null;delete this.config;this.param=null;delete this.param;this.nodeId=null;delete this.nodeId;this.pageType=null;delete this.pageType;this.id=null;delete this.id;this.define=null;delete this.define;this.event.myDestroy();this.event=null;delete this.event;this.page=null;delete this.page;this.parentNodeId=null;delete this.parentNodeId;this.state=null;delete this.state;this.right=null;delete this.right}};
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxUtil={};(function(){Ext.apply(JxUtil,{isLogout:false,logout:function(isF5){var hdcall=function(){var params="funid=login&pagetype=login&eventcode=logout";Request.postRequest(params,function(){JxUtil.isLogout=true;window.location.href=Jxstar.path})};if(isF5==true){hdcall();return}Ext.Msg.confirm(jx.base.hint,jx.base.logoutok,function(btn){if(btn=="yes"){hdcall()}})},putRightNodes:function(menuJson){for(var i=0;i<menuJson.length;i++){var oneModule=menuJson[i];for(var j=0;j<oneModule.children.length;j++){var towModule=oneModule.children[j];for(var k=0;k<towModule.children.length;k++){var threeModule=towModule.children[k];Jxstar.rightNodes.push(threeModule.id)}}}},onLineUser:function(){var hdcall=function(grid){Jxstar.loadInitData(grid)};var define=Jxstar.findNode("sys_user_login");Jxstar.showData({filename:define.gridpage,title:define.nodetitle,width:360,height:450,callback:hdcall})},loadJxData:function(){Ext.fly("loading").dom.innerHTML="正在加载功能数据文件...";Ext.fly("loading").show();JxUtil.loadJS("/public/data/NodeDefine.js",true);JxUtil.loadJS("/public/data/RuleData.js",true);JxUtil.loadJS("/public/locale/combo-lang-"+JxLang.type+".js",true);Ext.fly("loading").hide()},loadJxGraph:function(){if(!window.mxClient){var fileName="mxclient-ff.js";if(Ext.isIE){fileName="mxclient-ie.js"}else{if(Ext.isChrome){fileName="mxclient-ch.js"}}JxUtil.loadJS("/public/lib/graph/js/"+fileName);window.mxClient=mxClient}},loadJS:function(url,nocache){if(url.charAt(0)!="/"){url="/"+url}url=Jxstar.path+url;if(nocache===true){var dc="?dc="+(new Date()).getTime();url+=dc}var req=new XmlRequest("GET",url,false);req.send();var js=req.getText();if(window.execScript){window.execScript(js)}else{window.eval(js)}},isAdminUser:function(){var roleId=Jxstar.session.role_id;return(roleId.indexOf("admin")>=0)},validateGrid:function(grid){var isReqCheck=true,myForm=null;if(grid.isXType("editorgrid")==false){var f=JxUtil.getMyForm(grid);if(f){myForm=f.getForm()}else{isReqCheck=false}}if(isReqCheck==false){return true}var cm=grid.getColumnModel();var records=JxUtil.getSelectRows(grid);for(var i=0;i<records.length;i++){var record=records[i];var fields=record.fields.keys;for(var j=0;j<fields.length;j++){var name=fields[j];var value=record.data[name];if(value==null){value=""}var field=null;if(grid.isXType("editorgrid")){var colIndex=cm.findColumnIndex(name);var rowIndex=grid.getStore().indexOfId(record.id);var editor=cm.getCellEditor(colIndex,rowIndex);if(editor){field=editor.field}}else{if(myForm){field=myForm.findField(name)}}if(field!=null&&!field.validateValue(value)){var index=grid.getStore().indexOf(record);var label=cm.getColumnHeader(cm.findColumnIndex(name));var hint=String.format(jx.event.auditvalid,index+1,label);JxHint.alert(hint);return false}}}return true},addAttachCombo:function(grid,combocode,index){index=index||0;grid.attachTypeCombo=function(){var typedata=Jxstar.findComboData(combocode);return{anchor:"60%",xtype:"combo",name:"attach_type_combo",fieldLabel:"资料类型",store:new Ext.data.SimpleStore({fields:["value","text"],data:typedata}),emptyText:jx.star.select,mode:"local",triggerAction:"all",valueField:"value",displayField:"text",editable:false,value:typedata[index][0]}}},getMyForm:function(myGrid){var tabPanel=myGrid.findParentByType("tabpanel");if(tabPanel==null){return null}if(tabPanel.getComponent(1)==null){return null}var formPanel=tabPanel.getComponent(1).getComponent(0);if(formPanel==null||!formPanel.isXType("form")){return null}return formPanel},getParentGrid:function(childCmp){var tabPanel=childCmp.findParentByType("tabpanel");if(!tabPanel||tabPanel.isXType("tabpanel")==false){return childCmp.parentGrid}var grid=tabPanel.getComponent(0).getComponent(0);if(!grid||grid.isXType("grid")==false){return childCmp.parentGrid}return grid},getParentForm:function(subGrid){var form=subGrid.findParentByType("form");if(Ext.isEmpty(form)){var tabPanel=subGrid.findParentByType("tabpanel");if(!tabPanel){return null}var pform=tabPanel.getComponent(1);if(!pform){return null}form=pform.getComponent(0);if(!form||form.isXType("form")==false){return null}}return form.getForm()},getLayoutTree:function(childCmp){var tabPanel=childCmp.findParentByType("tabpanel");if(!tabPanel||tabPanel.isXType("tabpanel")==false){return null}var tree=tabPanel.ownerCt.ownerCt.getComponent(0).getComponent(0);if(!tree||tree.isXType("treepanel")==false){return null}return tree},treeAddCheck:function(tree){if(!tree){return}var tool=tree.getTopToolbar();var tools=tree.getTopToolbar().find("xtype","checkbox");if(tools.length>0){return}tool.insert(1,"->");tool.insert(2,{xtype:"checkbox",boxLabel:"本级"});tool.doLayout()},viewSumData:function(grid){var bbar=grid.getBottomToolbar();if(!bbar){return}var sumdata=grid.getStore().reader.jsonData.data.sum;if(Ext.isEmpty(sumdata)){return}sumdata=sumdata[0];var cm=grid.getColumnModel();var sumText="合计：";Ext.iterate(sumdata,function(key,value){var header=cm.getColumnById(key).header;sumText+=header+"："+value+" "});var sumItem=bbar.sumItem;if(Ext.isEmpty(sumItem)){var idx=bbar.items.indexOf(bbar.refresh);sumItem=new Ext.Toolbar.TextItem(sumText);bbar.insert(idx+1,new Ext.Toolbar.Separator());bbar.insert(idx+2,sumItem);bbar.sumItem=sumItem}else{sumItem.setText(sumText)}bbar.doLayout()},createReportTool:function(tabPanel,iframe,tbar,funId,keyid){var baseWf=function(fileName){JxUtil.myCheckIframe=iframe;var appData={funId:funId,dataId:keyid};JxUtil.showCheckWindow(appData,fileName)};tbar.add({text:"审批",iconCls:"eb_chkw",handler:function(){baseWf("check_work")}});if(tabPanel.isXType("tabpanel")){var tabForm=tabPanel.getComponent(1);var tabGrid=tabPanel.getComponent(0);tbar.add({text:"编辑",iconCls:"eb_form",handler:function(){tabPanel.activate(tabForm)}});tbar.add({text:"图文资料",iconCls:"eb_upload",handler:function(){tabGrid.getComponent(0).gridNode.event.upload()}})}tbar.add({text:"刷新",iconCls:"eb_refresh",handler:function(){var src=iframe.dom.src;iframe.dom.src=src}});var extMenu=new Ext.menu.Menu({items:[{text:"查看任务分配",handler:function(){baseWf("check_assign")}},{text:"查看历史审批",handler:function(){baseWf("check_his")}},{text:"查看流程图",handler:function(){baseWf("check_map")}},{text:"查看过程实例",handler:function(){baseWf("check_list")}}]});tbar.add({text:jx.node.extmenu,iconCls:"eb_menu",menu:extMenu})},createReportTab:function(tabPanel,href,nodetitle,nodeid,keyid){var frmid="frmHtmlReport_"+nodeid;var tabid="tab_"+frmid;var tabtitle="";if(tabPanel.isXType("tabpanel")){tabtitle=nodetitle+"-审批单"}var tbar;var reportTab=tabPanel.getComponent(tabid);if(reportTab==null){var tcfg={deferHeight:true,items:[{text:" "}]};if(Ext.isIE){tcfg.style="padding:1px;"}tbar=new Ext.Toolbar(tcfg);var reportTab=tabPanel.add({id:tabid,pagetype:"formrpt",title:tabtitle,autoScroll:true,layout:"fit",border:true,tbar:tbar,closable:true,iconCls:"tab_form",html:'<iframe id="'+frmid+'" frameborder="no" style="display:none;border-width:0;"></iframe>'});reportTab.on("beforedestroy",function(t){Ext.fly(frmid).remove();return true})}else{tbar=reportTab.getTopToolbar();tbar.removeAll(true);tbar.add({text:" "})}if(tabPanel.isXType("tabpanel")){tabPanel.activate(reportTab)}else{tabPanel.show()}var frm=Ext.get(frmid);frm.setWidth(800);frm.setHeight(reportTab.getHeight()-27);frm.dom.src=href+"&_dc="+(new Date()).getTime();frm.show();JxUtil.createReportTool(tabPanel,frm,tbar,nodeid,keyid);return reportTab},formWindow:function(config,okCall){var winForm=new Ext.form.FormPanel({layout:"form",labelAlign:"left",border:false,baseCls:"x-plain",autoHeight:true,frame:false,bodyStyle:"padding:10px;",items:config.items});var self=this;var win=new Ext.Window({title:jx.base.inputtext,layout:"fit",width:config.width||400,height:config.height||160,resizable:false,modal:true,closeAction:"close",items:[winForm],buttons:[{text:jx.base.ok,handler:function(){if(okCall(winForm.getForm())!=false){win.close()}}},{text:jx.base.cancel,handler:function(){win.close()}}]});win.show()},setPass:function(userId){var passForm=new Ext.form.FormPanel({layout:"form",labelAlign:"right",style:"padding:20 20 0 0px;",border:false,frame:false,baseCls:"x-plain",items:[{xtype:"textfield",fieldLabel:jx.sys.oldpwd,name:"modfiy_pass__old_pass",inputType:"password",allowBlank:false,labelSeparator:"*",labelStyle:"color:#0000ff;",anchor:"100%",maxLength:20},{xtype:"textfield",fieldLabel:jx.sys.newpwd,id:"modfiy_pass__new_pass",inputType:"password",allowBlank:false,labelSeparator:"*",labelStyle:"color:#0000ff;",anchor:"100%",maxLength:20},{xtype:"textfield",fieldLabel:jx.sys.conpwd,id:"modfiy_pass__confirm_pass",inputType:"password",allowBlank:false,labelSeparator:"*",labelStyle:"color:#0000ff;",anchor:"100%",maxLength:20}]});var win=new Ext.Window({title:jx.sys.modpwd,layout:"fit",width:300,height:180,resizable:false,modal:true,closeAction:"close",items:[passForm],buttons:[{text:jx.base.ok,handler:function(){if(!passForm.getForm().isValid()){JxHint.alert(jx.event.datavalid);return}var myform=passForm.getForm();var oldpass=myform.findField("modfiy_pass__old_pass").getValue();var newpass=myform.findField("modfiy_pass__new_pass").getValue();var confirmpass=myform.findField("modfiy_pass__confirm_pass").getValue();if(newpass!=confirmpass){JxHint.alert(jx.sys.twopwd);return}var params="funid=sys_user&oldpass="+oldpass+"&newpass="+newpass;params+="&keyid="+userId;params+="&pagetype=editgrid&eventcode=setpass";Request.postRequest(params,null);win.close()}},{text:jx.base.cancel,handler:function(){win.close()}}]});win.show()},showCheckEdit:function(nodeId,dataId,form,toolBar){var self=this;var hdCall=function(data){var editFields=data.editFields;if(editFields.length==0){return}var fields=editFields.split(";");for(var i=0;i<fields.length;i++){if(fields[i].length>0){var field=form.findField(fields[i].replace(".","__"));field.setReadOnly(false)}}};var params="funid=wf_assign&pagetype=chkgrid&eventcode=queryfield";params+="&check_funid="+nodeId+"&keyid="+dataId;Request.dataRequest(params,hdCall)},showCheckData:function(nodeId,dataId,userId){var define=Jxstar.findNode(nodeId);if(define==null){JxHint.alert(String.format(jx.star.nopage,nodeId));return false}if(Ext.isEmpty(define.showform)){define.showform="form"}var pkcol=define.pkcol.replace("__",".");var pageParam={pageType:"check",whereSql:" exists (select * from wf_assign where run_state = ? and assign_userid = ? and fun_id = ? and data_id = "+pkcol+")",whereValue:"0;"+userId+";"+nodeId,whereType:"string;string;string",showType:define.showform,updateId:dataId};Jxstar.createNode(nodeId,pageParam)},showCheckHisData:function(nodeId,dataId,userId){var define=Jxstar.findNode(nodeId);if(define==null){JxHint.alert(String.format(jx.star.nopage,nodeId));return false}var pkcol=define.pkcol.replace("__",".");var pageParam={pageType:"check",whereSql:" exists (select * from wf_assignhis where check_userid = ? and fun_id = ? and data_id = "+pkcol+")",whereValue:userId+";"+nodeId,whereType:"string;string",showType:"grid",updateId:dataId};Jxstar.createNode(nodeId,pageParam)},showCheckWindow:function(appData,fileName){var hdCall=function(f){f.showWindow(appData)};Request.loadJS("/jxstar/studio/pub/"+fileName+".js",hdCall)},showFormData:function(funId,dataId){var define=Jxstar.findNode(funId);var pkcol=define.pkcol.replace("__",".");var hdcall=function(page){var options={where_sql:pkcol+" = ?",where_type:"string",where_value:dataId,callback:function(data){if(data.length==0){JxHint.alert(jx.util.nodata)}else{var r=page.formNode.event.newRecord(data[0]);page.getForm().myRecord=r;page.getForm().loadRecord(r);page.formNode.event.initForm()}}};Jxstar.queryData(funId,options)};Jxstar.showData({filename:define.formpage,pagetype:"form",title:define.nodetitle,callback:hdcall})},getButton:function(toolBar,eventCode){return toolBar.find("eventCode",eventCode)[0]},getPageSize:function(grid){var pageSize=Jxstar.pageSize;var bbar=grid.getBottomToolbar();if(bbar&&bbar.isXType("paging")){pageSize=bbar.pageSize}else{var tbar=grid.getTopToolbar();if(tbar){var pbar=tbar.findByType("paging")[0];if(pbar){pageSize=pbar.pageSize}}}return pageSize},disableButton:function(toolBar,disable){var btns=toolBar.find("rightType","edit");Ext.each(btns,function(btn){btn.setDisabled(disable)})},readOnlyForm:function(form,readOnly){if(readOnly==true){form.fieldItems().each(function(f){if(f.isXType("field")){if(f.isXType("checkbox",true)||f.isXType("radio",true)){f.setDisabled(true)}else{f.setReadOnly(true)}}})}else{form.fieldItems().each(function(f){var initReadOnly=f.initialConfig.readOnly;var initDisabled=f.initialConfig.disabled;if(f.isXType("field")){if(f.isXType("checkbox",true)||f.isXType("radio",true)||f.isXType("fileuploadfield",true)){if(!initDisabled){f.setDisabled(false)}}else{if(!initReadOnly){f.setReadOnly(false)}}}})}},formatNumber:function(n){return function(v){if(n==null||isNaN(n)){n=2}return(v!==undefined&&v!==null&&v!=="")?parseFloat(parseFloat(v).toFixed(n)):""}},formatInt:function(){return function(v){return(v!==undefined&&v!==null&&v!=="")?parseInt(v):""}},gridToCSV:function(grid,includeHidden){var fileContent="";var title="";var cm=grid.getColumnModel();var colCount=cm.getColumnCount();for(var i=0;i<colCount;i++){if(cm.getDataIndex(i).length>0&&(includeHidden||!cm.isHidden(i))){title+=cm.getColumnHeader(i)+","}}if(title.length>0){title=title.substr(0,title.length-1)}var content="",row="",r;for(var i=0,it=grid.store.data.items,l=it.length;i<l;i++){r=it[i].data;var k=0;for(var j=0;j<colCount;j++){if((cm.getDataIndex(j).length>0)&&(includeHidden||!cm.isHidden(j))){var v=r[cm.getDataIndex(j)];v=Ext.isDate(v)?v.dateFormat("Y-m-d H:i:s"):v;k++;row+=v+","}}if(row.length>0){row=row.substr(0,row.length-1)}content+=row+"\n";row=""}fileContent+=title+"\n";fileContent+=content+"\n";return fileContent},newId:function(){var idval=Math.random()*10000000;idval=new String(idval).split(".");return idval[0]},emptyRecord:function(store){var record=new (store.reader.recordType)({});var cols=record.fields.keys;for(var i=0;i<cols.length;i++){record.set(cols[i],"")}return record},specialKey:function(field,event){if(event.ctrlKey&&event.keyCode==event.F1){var ft=field.name.split("__");var showField=function(data){var html='<div style="background-color:#fff;font-size:13px;line-height:22px;padding:2px;width:100%;height:100%;overflow:auto;">'+data.info+"</div>";var win=new Ext.Window({title:jx.util.seefield,layout:"fit",width:450,height:250,resizable:true,modal:true,style:"",closeAction:"close",html:html,buttons:[{text:jx.base.ok,handler:function(){win.close()}}]});win.show()};var params="funid=dm_fieldcfg&table_name="+ft[0]+"&field_name="+ft[1];params+="&eventcode=queryfield";Request.postRequest(params,showField)}},changeValue:function(field,newValue,oldValue){if(field.isDirty()){field.addClass("x-grid3-dirty-cell")}else{field.removeClass("x-grid3-dirty-cell")}},clearDirty:function(form){form.fieldItems().each(function(f){var name=f.name;if(name!=null&&name.length>0){f.removeClass("x-grid3-dirty-cell");f.originalValue=f.getValue()}})},getDirtyFields:function(form){var name,fields="";form.fieldItems().each(function(f){name=f.name;if(name!=null&&name.length>0&&f.isDirty()){fields+=name.replace("__",".")+";"}});if(fields.length>1){fields=fields.substr(0,fields.length-1)}return fields},getFormValues:function(form,dirtyOnly){var name,val,data="",e=encodeURIComponent;form.fieldItems().each(function(f){name=f.name;val=f.getValue();val=Ext.isDate(val)?val.dateFormat("Y-m-d H:i:s"):val;if(name!=null&&name.length>0&&(dirtyOnly!==true||f.isDirty())){data+="&"+e(name)+"="+e(val)}});return data},parseWhereValue:function(whereValue,tagRecord,isBig){if(whereValue==null||whereValue.length==0||tagRecord==null){return whereValue}var re=/\[[^\]]+\]/g;if(isBig){re=/\{[^\{]+\}/g}var fn=function(name,index,format,args){name=name.substr(1,name.length-2);name=name.replace(".","__");var v;if(tagRecord.get){v=tagRecord.get(name)}else{v=tagRecord[name]}return v||name};var value=whereValue.replace(re,fn);return value},getSelectRows:function(g){var records=[];var selModel=g.getSelectionModel();if(selModel.getSelections){records=selModel.getSelections()}else{var pos=selModel.getSelectedCell();if(pos==null){return records}var record=g.getStore().getAt(pos[0]);if(record){records=[record]}}return records},selected:function(records){if(records==null){JxHint.alert(jx.util.isnull);return false}if(records.length==0){JxHint.alert(jx.util.selectno);return false}return true},selectone:function(records){if(!this.selected(records)){return false}if(records.length>1){JxHint.alert(jx.util.selectone);return false}return true},checkResult:function(extData){if(!extData||extData.length==0){return}var cds=extData.checkMsg;for(var i=0,n=cds.length;i<n;i++){var data=cds[i];var faild=data.faildDesc;if(!data.result&&faild.length>0&&faild.indexOf("[")>-1){faild=faild.replace(/\[/g,"{");faild=faild.replace(/\]/g,"}");var tpl=new Ext.XTemplate(faild);data.faildDesc=tpl.apply(data.data)}}var tpl=new Ext.XTemplate('<div style="background-color:#fff;">','<table style="font-size:13px;width:100%;">','<tr style="font-weight:bold;background-color:#ccc;height:28px;"><td style="width:150px;">检查项</td><td style="width:40px;">结果</td><td style="width:190px;">失败提示</td></tr>','<tpl for="checkMsg">','<tr style="background-color:#eee;height:28px;">',"<td>{checkName}</td>",'<tpl if="result == false">','<td><span class="eb_audit_cancel">&nbsp;&nbsp;&nbsp;&nbsp;</span></td>',"</tpl>",'<tpl if="result == true">','<td><span class="eb_select">&nbsp;&nbsp;&nbsp;&nbsp;</span></td>',"</tpl>","<td>{faildDesc} {message}</td>","</tr>","</tpl>","</table>","</div>");var win=new Ext.Window({title:"检查项执行结果",layout:"fit",width:400,height:300,resizable:false,modal:true,autoScroll:true,closeAction:"close",tpl:tpl,data:extData});win.show()},tabAddKey:function(tab){var hd=function(tab){var mappings=[],cnt=tab.items.getCount();for(var i=0;i<cnt;i++){var fn=function(k,e){var index=k-49;tab.activate(index)};var key=49+i;mappings[i]={key:key,ctrl:true,alt:true,fn:fn}}tab.keymap=new Ext.KeyMap(tab.el,mappings);tab.keymap.enable()};JxUtil.delay(1000,function(){if(this.el){hd(this)}},tab)},isDisableBtn:function(page,eventCode){var tbar=page.getTopToolbar();if(tbar==null){return true}var btn=JxUtil.getButton(tbar,eventCode);if(btn==null){return true}return btn.disabled},focusFirst:function(page){if(page==null||!page.isXType("form")){return}var hd=function(){page.form.items.each(function(f){if(f.isFormField&&f.rendered&&f.name&&!f.isXType("hidden")){f.focus(true);return false}})};JxUtil.delay(500,hd)},focusFirstRow:function(page){if(page==null||!page.isXType("grid")){return}var row=JxUtil.getRowNum(page);page.getView().focusRow(row)},getRowNum:function(page){if(page==null||!page.isXType("grid")){return -1}var sm=page.getSelectionModel();if(sm.getSelectedCell){var pos=sm.getSelectedCell();if(pos){return pos[0]}else{return -1}}else{var s=page.getStore();var r=sm.getSelected();if(r){return s.indexOf(r)}else{return -1}}},getEditCol:function(page){if(page==null||!page.isXType("editorgrid")){return -1}var cm=page.getColumnModel();var cnt=cm.getColumnCount();for(var i=0;i<cnt;i++){if(cm.isCellEditable(i,0)){return i}}return -1},errorResponse:function(response){var msg,code=response.status;if(response.isTimeout){msg=jx.util.limittime}else{if(code>=200&&code<300){var result=Ext.decode(response.responseText);msg=result.message;if(msg.length==0){msg=response.statusText}}else{if(response.responseText!=null&&response.responseText.length>0){var msg=response.responseText;try{var result=Ext.decode(response.responseText);msg=result.message}catch(e){}JxHint.alert(msg);return}else{msg=response.statusText}}}if(msg.indexOf("communication")>-1){msg="网络异常，请稍后再试！";alert(msg);return}alert(msg);if(msg.indexOf(jx.index.login)>=0){JxUtil.isLogout=true;window.location.href=Jxstar.path}},delay:function(time,fn,scope,args){(new Ext.util.DelayedTask()).delay(time,fn,scope,args)},removeChild:function(parent){if(!parent){return}try{var childs=parent.childNodes||[];for(var i=childs.length-1;i>=0;i--){var has=childs[i].hasChildNodes();if(has){JxUtil.removeChild(childs[i])}else{if(childs[i]){parent.removeChild(childs[i]);childs[i]=null}}}if(parent){parent.parentNode.removeChild(parent)}parent=null}catch(e){}},strlen:function(value){if(value==null||value.length<1){return 0}var len=0;for(var i=0;i<value.length;i++){if(value.charCodeAt(i)<299){len++}else{len+=2}}return len},numBigMoney:function(num){var strOutput="";var strUnit="仟佰拾亿仟佰拾万仟佰拾元角分";num+="00";var intPos=num.indexOf(".");if(intPos>=0){num=num.substring(0,intPos)+num.substr(intPos+1,2)}strUnit=strUnit.substr(strUnit.length-num.length);for(var i=0;i<num.length;i++){strOutput+="零壹贰叁肆伍陆柒捌玖".substr(num.substr(i,1),1)+strUnit.substr(i,1)}return strOutput.replace(/零角零分$/,"整").replace(/零[仟佰拾]/g,"零").replace(/零{2,}/g,"零").replace(/零([亿|万])/g,"$1").replace(/零+元/,"元").replace(/亿零{0,3}万/,"亿").replace(/^元/,"零元")},fixPNG:function(myIMG){if(!Ext.isIE6){return}var imgID=(myIMG.id)?"id='"+myIMG.id+"' ":"";var imgTitle=(myIMG.title)?"title='"+myIMG.title+"' ":"title='"+myIMG.alt+"' ";var newHTML="<span "+imgID+imgTitle+' style="width:'+myIMG.width+"px; height:"+myIMG.height+"px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+myIMG.src+"', sizingMethod='scale');\"></span>";myIMG.outerHTML=newHTML},getDateFormat:function(renderer){var ren=renderer.toString(),form="Y-m-d";if(ren.indexOf("format('Y-m-d")>=0||ren.indexOf('format("Y-m-d')>=0){form="Y-m-d"}else{if(ren.indexOf("format('Y-m")>=0||ren.indexOf('format("Y-m')>=0){form="Y-m"}else{if(ren.indexOf("format('Y")>=0||ren.indexOf('format("Y')>=0){form="Y"}}}return form},getCurYear:function(inc){var d=new Date();var y=parseInt(d.format("Y"));if(inc!=null){y=y+inc}return y},getTodayTime:function(){var d=new Date();return d.format("Y-m-d H:i:s")},getToday:function(inc){var d=new Date();if(inc!=null){d=d.add(Date.DAY,inc)}return d.format("Y-m-d")},getMonth:function(inc){var d=new Date();if(inc!=null){d=d.add(Date.MONTH,inc)}return d.format("Y-m")},getNextMonth:function(smonth,num){if(smonth==null){return""}smonth=smonth.split(" ")[0];var sd=smonth.split("-");if(sd.length==2){smonth=smonth+"-01"}else{if(sd.length==1){smonth=smonth+"-01-01"}}var dt=Date.parseDate(smonth,"Y-m-d");dt=dt.add(Date.MONTH,num);return dt.format("Y-m")},getNextDate:function(sdate,num){if(sdate==null){return""}sdate=sdate.split(" ")[0];var sd=sdate.split("-");if(sd.length==2){sdate=sdate+"-01"}else{if(sd.length==1){sdate=sdate+"-01-01"}}var dt=Date.parseDate(sdate,"Y-m-d");dt=dt.add(Date.DAY,num);return dt.format("Y-m-d")},getWeekDates:function(){var d=new Date();var w=d.getDay();var sd=this.getNextDate(this.getToday(),-w);var ed=this.getNextDate(this.getToday(),7-w);return[sd,ed]},getPreWeekDates:function(){var d=new Date();var w=d.getDay();var sd=this.getNextDate(this.getToday(),-w-7);var ed=this.getNextDate(this.getToday(),-w);return[sd,ed]},getMonthDates:function(){var smonth=this.getMonth();var sd=smonth+"-01";var ed=this.getNextMonth(smonth,1)+"-01";return[sd,ed]},getPreMonthDates:function(){var smonth=this.getNextMonth(this.getMonth(),-1);var sd=smonth+"-01";var ed=this.getNextMonth(smonth,1)+"-01";return[sd,ed]},toFixed:function(v,f){with(Math){return round(v*pow(10,f))/pow(10,f)}},multiply:function(rec,a,b,c){var va=rec.get(a);var vb=rec.get(b);var vc=(parseFloat(va)*100)*(parseFloat(vb)*100);vc=vc/10000;if(isNaN(vc)){vc=0}else{vc=JxUtil.toFixed(vc,2)}rec.set(c,vc)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxAttach={};(function(){Ext.apply(JxAttach,{uploadType:"0",uploadUrl:"",addAttachCol:function(c,a){var b={col:{header:'<div class="hd_attach" title="附件标志">&#160;</div>',width:22,name:"attachcol",xtype:"actioncolumn",menuDisabled:true,align:"center",renderer:function(){return'<div unselectable="on" class="x-grid3-cell-inner">&nbsp;</div>'}}};if(!a){a=0}c.insert(a,b)},getAttachColNum:function(d){var b=d.getSelectionModel() instanceof Ext.grid.CheckboxSelectionModel;var a=d.gridNode.param.cols;for(var c=0,e=a.length;c<e;c++){if(a[c].col.name=="attachcol"){return c+(b?2:1)}}return -1},officeAppName:function(a){if(a.indexOf("word")>=0){return"Word.Document"}else{if(a.indexOf("excel")>=0||a.indexOf("spreadsheetml.sheet")>=0){return"Excel.Sheet"}}return""},previewOffice:function(l,j,i,h){var m="objAttach_"+l;var a="tabAttach_"+l;var k="divAttach_"+l;var c=h.getComponent(a);if(c){h.activate(c);return}var f='<div id="'+k+'" class="login_loading"><img src="resources/images/jxstar32.gif" width="32" height="32"style="margin-right:8px;float:left;vertical-align:bottom;"/><span id="loading-msg">正在加载'+j+"...</span></div>";var b=Jxstar.path;if(JxAttach.uploadType=="1"){b=JxAttach.uploadUrl}b+="/fileAction.do?funid=sys_attach&pagetype=editgrid&eventcode=down&nousercheck=1&dataType=byte&keyid="+l;var e=f+'<OBJECT classid="clsid:00460182-9e5e-11d5-b7c8-b8269041dd57" id="'+m+'" style="left:0px; top:0px; width:10px; height:10px" viewastext codebase=public/lib/dso/dsoframer.ocx#version=2,2,0,8><PARAM NAME="_ExtentX" VALUE="6350"><PARAM NAME="_ExtentX" VALUE="6350"><PARAM NAME="_ExtentY" VALUE="6350"><PARAM NAME="BorderColor" VALUE="-2147483632"><PARAM NAME="BackColor" VALUE="-2147483643"><PARAM NAME="ForeColor" VALUE="-2147483640"><PARAM NAME="TitlebarColor" VALUE="-2147483635"><PARAM NAME="TitlebarTextColor" VALUE="-2147483634"><PARAM NAME="BorderStyle" VALUE="0"><PARAM NAME="Titlebar" VALUE="0"><PARAM NAME="Toolbars" VALUE="0"><PARAM NAME="Menubar" VALUE="0"></OBJECT>';var g={id:a,pagetype:"formpic",title:"浏览-"+j,layout:"fit",border:false,closable:true,iconCls:"tab_form",html:e};c=h.add(g);h.activate(c);var d=Ext.getDom(m);d.Open(b,true,i);Ext.fly(k).hide();Ext.fly(d).setStyle({left:0,top:0,width:"100%",height:"100%"})},previewPDF:function(h,g,f){var i="objAttachPDF_"+h;var a="tabAttachPDF_"+h;var c=f.getComponent(a);if(c){f.activate(c);return}var b=Jxstar.path;if(JxAttach.uploadType=="1"){b=JxAttach.uploadUrl}b+="/fileAction.do?funid=sys_attach&pagetype=editgrid&eventcode=down&nousercheck=1&dataType=byte&keyid="+h;var d='<OBJECT classid="clsid:ca8a9780-280d-11cf-a24d-444553540000" id="'+i+'" style="left: 0px; top: 0px; width: 100%; height: 100%" border="0"><param name="src" value="'+b+'"></OBJECT>';var e={id:a,pagetype:"formpic",title:"浏览-"+g,layout:"fit",border:false,closable:true,iconCls:"tab_form",html:d};c=f.add(e);f.activate(c)},previewImage:function(n,m,l){var p="objAttachIMG_"+n;var a="tabAttachIMG_"+n;var d=l.getComponent(a);if(d){l.activate(d);return}var b=Jxstar.path;if(JxAttach.uploadType=="1"){b=JxAttach.uploadUrl}b+="/fileAction.do?funid=sys_attach&pagetype=editgrid&eventcode=down&nousercheck=1&dataType=byte&keyid="+n;var j=Jxstar.systemVar.sys__attach__use_resize;if(j=="1"){b+="&is_highimage=1"}var g='<img src="'+b+'">';var f=new Ext.BoxComponent({border:false,html:g});var o=null,i=0,c=0;var e=new Ext.Toolbar({items:[{xtype:"tbtext",text:"缩放比例："},{value:100,width:300,increment:10,minValue:10,maxValue:300,xtype:"slider",plugins:new Ext.slider.Tip({getText:function(q){return String(q.value)+"%"}}),listeners:{change:function(u){if(!o||i==0){return}var r=u.getValue();var q=parseInt(i)*parseInt(r)/100;var t=parseInt(c)*parseInt(r)/100;o.resizeTo(q,t)}}}]});var h={id:a,pagetype:"formpic",title:"浏览-"+m,layout:"fit",border:true,closable:true,autoScroll:true,iconCls:"tab_form",tbar:e,items:[f]};d=l.add(h);l.activate(d);var k=function(){var q=f.getEl().child("img");o=new Ext.Resizable(q,{wrap:true,pinned:true,minWidth:200,minHeight:100,preserveRatio:true,dynamic:true,handles:"all",draggable:true});i=o.getEl().getWidth();c=o.getEl().getHeight()};JxUtil.delay(1000,k)},previewMenu:function(c,e){var b,d;var a=JxAttach.officeAppName(c.content_type);if(Ext.isIE&&a.length>0){b=function(i){var h=i.initialConfig.data;var g=h.attach_id;var j=h.attach_name;var f=JxAttach.officeAppName(h.content_type);JxAttach.previewOffice(g,j,f,e)}}if(Ext.isIE&&c.content_type=="application/pdf"){b=function(h){var g=h.initialConfig.data;var f=g.attach_id;var i=g.attach_name;JxAttach.previewPDF(f,i,e)}}if(c.content_type.indexOf("image")==0){b=function(h){var g=h.initialConfig.data;var f=g.attach_id;var i=g.attach_name;JxAttach.previewImage(f,i,e)}}if(b){d={items:[{text:"在线浏览",data:c,handler:b}]}}return d},viewAttachFlag:function(a){if(a==null){return}JxAttach.uploadType=Jxstar.systemVar.uploadType;JxAttach.uploadUrl=Jxstar.systemVar.uploadUrl;var l=a.findParentByType("tabpanel");var o=JxAttach.getAttachColNum(a);if(!(o>=0||a.isShowAttach==true)){return}if(o<0){o=0}var m=a.getStore();var c=m.getCount();if(c==0){return}var h=a.gridNode.define;if(h.tablename=="sys_dept"||h.tablename=="sys_user"){return}var k=h.pkcol;var b="";for(var f=0;f<c;f++){var g=m.getAt(f);b+=g.get(k)+","}b=b.substr(0,b.length-1);var j=function(y){if(y.length==0){return}var r=[],q=[];var D=-1;for(var z=0;z<y.length;z++){var u=parseInt(y[z].row_num);var w=y[z].data_id;var E=y[z].attach_id;var x=y[z].attach_name;var B=y[z].content_type;var t=y[z].is_relat;if(D!=u){q=[]}var A={id:E,text:x,handler:function(){var F="funid=sys_attach&keyid="+this.id+"&pagetype=editgrid&eventcode=down";if(JxAttach.uploadType=="1"){var i=JxAttach.uploadUrl+"/fileAction.do?"+F+"&dataType=byte&nousercheck=1";Ext.fly("frmhidden").dom.src=i}else{Request.fileDown(F)}}};if(t=="1"){A.style={color:"red"}}var s=JxAttach.previewMenu(y[z],l);if(s){A.menu=s}q[q.length]=A;if(D!=u){D=u;var v=a.getView().getCell(u,o);Ext.fly(v.firstChild).addClass("flag_attach");var C=Ext.get(v);C.myitems=q;C.on("click",function(){var i=new Ext.menu.Menu({items:[this.myitems]});i.on("hide",function(F){F.myitems=null;F.destroy()});i.show(this)})}}};var n=a.isQueryRelat||"0";var e=Jxstar.systemVar.sys__attach__relat||"0";if(e!="1"){n="0"}var d="funid=queryevent&pagetype=grid&eventcode=query_attach";d+="&tablename="+h.tablename+"&keyids="+b+"&is_queryrelat="+n;var p=a.queryAttachType;if(p){d+="&attach_type="+p}Request.dataRequest(d,j)},checkGrid:function(a){var e=JxUtil.getSelectRows(a);if(!JxUtil.selected(e)){return}var n=a.findParentByType("tabpanel");if(n==null){return}var d=n.getComponent(1);if(d==null){return}var c=d.getComponent(0);if(c==null||c.isXType("form")==false){return}var l=c.findByType("fileuploadfield");if(l==null||l.length==0){return}for(var g=0;g<e.length;g++){var k=e[g];for(var h=0;h<l.length;h++){var m=l[h];if(m.allowBlank==false){var b=k.get(m.name);if(b==null||b.length==0){JxHint.alert("【"+m.fieldLabel+"】栏目没有上传附件，不能提交！");return false}}}}},checkAttach:function(c){var a=c.findByType("fileuploadfield");if(a==null||a.length==0){return true}for(var b=0;b<a.length;b++){var d=a[b];if(d.allowBlank==false){var e=d.getValue();if(e==null||e.length==0){JxHint.alert("【"+d.fieldLabel+"】栏目没有上传附件，不能提交！");return false}}}return true},beforeChange:function(b){if(b.disabled){return}var g=JxAttach.attachParam(b,"");if(g==null){return}var e=g.form;var c=e.get(g.define.pkcol);if(c==null||c.length==0){JxHint.alert(jx.event.nosave);return false}var d="0",f="6";if(g.define.status){d=g.define.status.audit0}var a=d;if(g.define.auditcol.length>0){a=e.get(g.define.auditcol)}if(a!=d&&a!=f){JxHint.alert("业务记录已提交，不能修改附件！");return false}},showAttach:function(c){if(c==null||c.parentNode==null){return}var a=Ext.getCmp(c.parentNode.id);if(a==null){return}var d=JxAttach.attachParam(a,"fdown");if(d==null){return}if(JxAttach.uploadType=="1"){var b=JxAttach.uploadUrl+"/fileAction.do?"+d.params+"&dataType=byte&nousercheck=1";Ext.fly("frmhidden").dom.src=b}else{Request.fileDown(d.params)}},deleteAttach:function(b){if(b==null||b.parentNode==null){return}var a=Ext.getCmp(b.parentNode.id);if(a==null){return}if(a.disabled){return}var c=function(){var i=JxAttach.attachParam(a,"fdelete");if(i==null){return}var f="0",h="6";if(i.define.status){f=i.define.status.audit0}var d=f;if(i.define.auditcol.length>0){d=i.form.get(i.define.auditcol)}if(d!=f&&d!=h){JxHint.alert("业务记录已提交，不能删除附件！");return false}var g=function(){a.setValue("");if(!Ext.isEmpty(i.form.myRecord)){i.form.myRecord.set(a.name,"");i.form.myRecord.commit()}};if(JxAttach.uploadType=="1"){var e=JxAttach.uploadUrl+"/fileAction.do?"+i.params+"&nousercheck=1";Ext.fly("frmhidden").dom.src=e;JxUtil.delay(800,function(){g()})}else{Request.postRequest(i.params,g)}};Ext.Msg.confirm(jx.base.hint,jx.event.delyes,function(d){if(d=="yes"){c()}})},saveAttach:function(a){if(a.disabled){return}var f=JxAttach.attachParam(a,"fcreate");if(f==null){return}var c=f.form;var b=c.get(f.define.pkcol);if(b==null||b.length==0){JxHint.alert(jx.event.nosave);return false}var d=function(){if(!Ext.isEmpty(c.myRecord)){c.myRecord.set(a.name,a.getValue());c.myRecord.commit()}};var e=f.params+"&attach_name="+encodeURIComponent(a.getValue());Request.fileRequest(c,e,d)},attachParam:function(f,h){var e=f.findParentByType("form");if(Ext.isEmpty(e)){JxHint.alert("没有找到Form表单对象，不能上传附件！");return}var a=e.getForm();var g=e.formNode.define;var b=g.nodeid;var i=g.tablename;var d=a.get(g.pkcol);if(Ext.isEmpty(d)){JxHint.alert(jx.event.nosave);return}var j=f.name.split("__")[1];var c="funid=sys_attach&pagetype=editgrid&eventcode="+h;c+="&attach_field="+j+"&dataid="+d;c+="&table_name="+i+"&datafunid="+b;return{form:a,params:c,define:g}}})})();var ImageShower=function(a){this.config=a};ImageShower.prototype={lookup:{},show:function(){this.initTemplates();this.store=new Ext.data.JsonStore({url:this.config.url,root:"data",fields:["name","url","title"],listeners:{load:{fn:function(){this.view.select(0)},scope:this,single:true}}});this.store.load();var e=function(f){f.shortName=Ext.util.Format.ellipsis(f.title,15);f.sizeString="34";f.dateString=new Date().format("m/d/Y g:i a");this.lookup[f.name]=f;return f};this.view=new Ext.DataView({store:this.store,tpl:this.thumbTemplate,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",emptyText:"No images to display",prepareData:e.createDelegate(this),listeners:{selectionchange:{fn:this.showDetails,scope:this,buffer:100},loadexception:{fn:this.onLoadException,scope:this},beforeselect:{fn:function(f){return f.store.getRange().length>0}}}});var c="images-view";var b=this.config.parentCtl.getComponent(c);if(b){var d=b.getComponent(0);d.removeAll(true);d.add(this.view)}else{var a={id:c,pagetype:"formpic",title:"图片浏览",layout:"border",border:false,closable:true,iconCls:"tab_form",items:[{id:"img-chooser-view",region:"west",split:true,width:160,minWidth:160,maxWidth:300,autoScroll:true,items:this.view},{id:"img-detail-panel",region:"center",autoScroll:true}]};b=this.config.parentCtl.add(a)}return b},initTemplates:function(){this.thumbTemplate=new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{name}">','<div class="thumb"><img src="{url}" title="{title}"></div>',"<span>{shortName}</span></div>","</tpl>",'<div class="x-clear"></div>');this.thumbTemplate.compile();this.detailsTemplate=new Ext.XTemplate('<div class="details">','<tpl for=".">','<img src="{url}"  style="width:100%;height:100%;">',"</tpl>","</div>");this.detailsTemplate.compile()},showDetails:function(){var b=this.view.getSelectedNodes();var c=Ext.getCmp("img-detail-panel").body;if(b&&b.length>0){b=b[0];var a=this.lookup[b.id];c.hide();this.detailsTemplate.overwrite(c,a);c.slideIn("l",{stopFx:true,duration:0.2})}else{c.update("")}},onLoadException:function(a,b){this.view.getEl().update('<div style="padding:10px;">Error loading images.</div>')}};
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxDefault={};(function(){Ext.apply(JxDefault,{getToday:function(){return new Date()},getCurMonth:function(b){var c=new Date();var a=c.format("Y-m");c=Date.parseDate(a+"-01","Y-m-d");if(b!=null){c=c.add(Date.MONTH,b)}return c},getUserId:function(){return Jxstar.session.user_id},getUserCode:function(){return Jxstar.session.user_code},getUserName:function(){return Jxstar.session.user_name},getDeptId:function(){return Jxstar.session.dept_id},getDeptCode:function(){return Jxstar.session.dept_code},getDeptName:function(){return Jxstar.session.dept_name},getOrgId:function(){return Jxstar.session.orgid},getOrgCode:function(){return Jxstar.session.orgcode},getOrgName:function(){return Jxstar.session.orgname},getRoleId:function(){return Jxstar.session.role_id}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxLists=function(a){a=a||{};if(a.isSelect==null){a.isSelect=true}Ext.apply(this,a)};Ext.apply(JxLists.prototype,{render:function(){var b=this;var d=new Ext.data.ArrayStore({data:b.leftData||[],fields:["value","text"]});var c=new Ext.data.ArrayStore({data:b.rightData||[],fields:["value","text"]});var g,e,h;g=new Ext.ListView({region:"west",width:b.leftWidth||180,store:d,style:"background-color:#fff;",disableHeaders:true,multiSelect:true,columns:[{header:b.leftHeader||jx.group.datafield,dataIndex:"text"}],listeners:{dblclick:function(j,l,n,m){if(!b.isSelect){return false}var k=j.getStore();var i=k.getAt(l);e.getStore().add(i);k.removeAt(l)}}});e=new Ext.ListView({region:"east",width:b.rightWidth||180,store:c,style:"background-color:#fff;",disableHeaders:true,multiSelect:true,columns:[{header:b.rightHeader||jx.base.selfield,dataIndex:"text"}],listeners:{dblclick:function(j,l,n,m){if(!b.isSelect){return false}var k=j.getStore();var i=k.getAt(l);g.getStore().add(i);k.removeAt(l)}}});var a="./public/lib/ext/ux/images/";h=this.lsCenter||new Ext.Panel({baseCls:"x-plain",style:"border-right:1px solid #ddd; border-left:1px solid #ddd;",region:"center",border:false,layout:{type:"vbox",pack:"center",align:"center"},defaults:{margins:"0 0 10 0"},items:[{xtype:"button",width:20,icon:a+"right1.gif",handler:function(){var j=g.getStore();var i=j.getRange(0,j.getCount());e.getStore().add(i);j.removeAll()}},{xtype:"button",width:20,icon:a+"right.gif",handler:function(){var j=g.getSelectedRecords();e.getStore().add(j);for(var k=0;k<j.length;k++){g.getStore().remove(j[k])}}},{xtype:"button",width:20,icon:a+"left.gif",handler:function(){var j=e.getSelectedRecords();g.getStore().add(j);for(var k=0;k<j.length;k++){e.getStore().remove(j[k])}}},{xtype:"button",width:20,icon:a+"left1.gif",handler:function(){var j=e.getStore();var i=j.getRange(0,j.getCount());g.getStore().add(i);j.removeAll()}}]});this.lsLeft=g;this.lsRight=e;this.lsCenter=h;var f=new Ext.Panel({layout:"border",border:false,items:[g,h,e]});return f},getSelectStore:function(){if(!this.isSelect){return null}return this.lsRight.getStore()},getSelectData:function(){if(!this.isSelect){return""}var b=this.lsRight.getStore();if(b.getCount()==0){return""}var a="";for(var c=0,e=b.getCount();c<e;c++){var d=b.getAt(c).get("value");a+=d.replace("__",".")+","}a=a.substr(0,a.length-1);return a}});
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxGroup={};(function(){Ext.apply(JxGroup,{funId:"",charFields:[],numFields:[],selCharStore:null,selNumStore:null,selCharField:[],selNumField:[],statGrid:null,querys:[],groupWin:null,init:function(p,q){this.funId=q.nodeId;this.querys=p||{};this.charFields=[];this.numFields=[];this.selCharField=[];this.selNumField=[];var r=[],j=q.param.cols;for(var e=0,m=0,l=0,a=j.length;e<a;e++){var o=j[e].col,g=j[e].field;if(o&&g){var f=o.header;if(f.charAt(0)=="*"){f=f.substr(1)}var d=[g.name,f];var k=g.type;if(k=="int"||k=="float"){this.numFields[m++]=d}else{this.charFields[l++]=d}}}},showWindow:function(b,c){var a=this;a.init(b,c);a.groupWin=new Ext.Window({title:jx.group.seltitle,layout:"fit",width:400,height:450,resizable:true,modal:true,closeAction:"close",items:[{html:""}],buttons:[{text:jx.base.ok},{text:jx.base.cancel}],listeners:{beforeclose:function(){if(a.statGrid!=null){a.statGrid.destroy()}a.funId=null;a.charFields=null;a.numFields=null;a.selCharStore=null;a.selNumStore=null;a.selCharField=null;a.selNumField=null;a.statGrid=null;a.querys=null;a.groupWin=null}}});a.groupWin.show();a.showGroupField()},showGroupField:function(){var b=this;var a=new JxLists({leftData:b.charFields,leftHeader:jx.group.nonum,rightHeader:jx.group.selnonum});var d=a.render();var c=[{text:jx.group.next,width:70,handler:function(){b.selCharStore=a.getSelectStore();if(b.selCharStore.getCount()==0){JxHint.alert(jx.group.nofield);return false}b.showNumField()}},{text:jx.base.cancel,width:70,handler:function(){b.groupWin.close()}}];b.updateWindow(jx.group.seltitle,400,d,c)},showNumField:function(){var b=this;var a=new JxLists({leftData:b.numFields,leftHeader:jx.group.numfield,rightHeader:jx.group.selfield});var d=a.render();var c=[{text:jx.group.pre,width:70,handler:function(){b.showGroupField()}},{text:jx.group.stat,width:70,handler:function(){b.selNumStore=a.getSelectStore();if(b.statGrid!=null){b.statGrid.remove()}b.showGroupData(true)}},{text:jx.base.cancel,width:70,handler:function(){b.groupWin.close()}}];b.updateWindow(jx.group.stattitle,400,d,c)},showGroupData:function(q){var p=this;var t=[{text:jx.group.outchat,width:70,handler:function(){p.showChartConfig()}},{text:jx.group.saveas,width:70,handler:function(){Request.exportCSV(p.statGrid,jx.group.statdata+".csv")}},{text:jx.group.back,width:70,handler:function(){p.showNumField()}},{text:jx.base.close,width:70,handler:function(){p.groupWin.close()}}];if(!q&&p.statGrid!=null){p.updateWindow(jx.group.restitle,700,p.statGrid,t);return}var j=[],l=[],x=0,u=0;var h="",z=p.selCharStore;for(var s=0,r=z.getCount();s<r;s++){var m=z.getAt(s).get("text");var b=z.getAt(s).get("value").split("__")[1];h+=b+",";p.selCharField[s]=[b,m];l[u++]={name:b,type:"string"};j[x++]={header:m,width:150,dataIndex:b}}if(h.length>0){h=h.substr(0,h.length-1)}var A="",z=p.selNumStore;for(var s=0,r=z.getCount();s<r;s++){var m=z.getAt(s).get("text");var b=z.getAt(s).get("value").split("__")[1];A+=b+",";p.selNumField[s]=[b,m];l[u++]={name:b};j[x++]={header:m,width:100,dataIndex:b}}p.selNumField[p.selNumField.length]=["recordnum",jx.group.recnum];if(A.length>0){A=A.substr(0,A.length-1)}j[x++]={header:jx.group.recnum,width:100,dataIndex:"recordnum"};l[u++]={name:"recordnum"};var k=p.querys[0]||"";var o=p.querys[1]||"";var y=p.querys[2]||"";var v=encodeURIComponent;var w="funid=queryevent&query_funid="+p.funId+"&pagetype=grid&eventcode=group_stat";w+="&where_sql="+v(k)+"&where_value="+v(o);w+="&where_type="+y+"&query_type=1";w+="&charfield="+h+"&numfield="+A+"&user_id="+Jxstar.session.user_id;var g=Jxstar.path+"/commonAction.do";var a=new Ext.data.Store({proxy:new Ext.data.HttpProxy({method:"POST",url:g,listeners:{exception:function(n,i,E,D,C,B){a.removeAll();JxUtil.errorResponse(C)}}}),reader:new Ext.data.JsonReader({root:"data.root",totalProperty:"data.total"},l)});a.load({params:w});var d=new Ext.grid.GridPanel({store:a,columns:j,border:false,stripeRows:true,columnLines:true});p.statGrid=d;p.updateWindow(jx.group.restitle,700,d,t)},showChartConfig:function(){var a=this;var c=new Ext.form.FormPanel({style:"padding:20px;",broder:false,baseCls:"x-plain",items:[{xtype:"fieldset",title:jx.group.datafield,items:[{xtype:"combo",fieldLabel:jx.group.groupfield,name:"group_field",store:new Ext.data.SimpleStore({fields:["value","text"],data:a.selCharField}),mode:"local",triggerAction:"all",valueField:"value",displayField:"text",editable:false,allowBlank:false,value:a.selCharField[0][0]},{xtype:"combo",fieldLabel:jx.group.statfield,name:"stat_field",store:new Ext.data.SimpleStore({fields:["value","text"],data:a.selNumField}),mode:"local",triggerAction:"all",valueField:"value",displayField:"text",editable:false,allowBlank:false,value:a.selNumField[0][0]}]},{xtype:"fieldset",title:jx.group.chattype,items:[{xtype:"radiogroup",fieldLabel:jx.group.chattype+":",name:"chart_type",items:[{boxLabel:jx.group.pie,name:"chart_type",inputValue:"piechart",checked:true},{boxLabel:jx.group.col,name:"chart_type",inputValue:"columnchart"},{boxLabel:jx.group.line,name:"chart_type",inputValue:"linechart"}]}]}]});var b=[{text:jx.group.createchat,width:70,handler:function(){var f=c.getForm();var d=f.findField("group_field").getValue();var g=f.findField("stat_field").getValue();var e=f.findField("chart_type").getValue().inputValue;a.showChartImage(d,g,e)}},{text:jx.group.back,width:70,handler:function(){a.showGroupData(false)}},{text:jx.base.close,width:70,handler:function(){a.groupWin.close()}}];a.updateWindow(jx.group.outset,400,c,b)},createChartImage:function(g,b,f,e){var i=this;var d={store:g,xtype:e,dataField:f,categoryField:b,extraStyle:{legend:{display:"right",padding:5,font:{family:"Tahoma",size:13}}}};var h=[100,10];if(e!="piechart"){h=i.maxValue(g,f)}var a={store:g,xtype:e,yField:f,xField:b,yAxis:new Ext.chart.NumericAxis({maximum:h[0],majorUnit:h[1]}),tipRenderer:function(k,j){return j.get(b)+jx.group.val+j.get(f)}};var c=new Ext.Panel({border:false,items:(e=="piechart")?d:a});return c},showChartImage:function(d,g,e){var c=this;var b=c.statGrid.getStore();var a=c.createChartImage(b,d,g,e);var f=[{text:jx.group.back,width:70,handler:function(){c.showChartConfig()}},{text:jx.base.close,width:70,handler:function(){c.groupWin.close()}}];c.updateWindow(jx.group.chattitle,700,a,f)},updateWindow:function(f,a,c,b){var e=this.groupWin;e.setTitle(f);var d=e.getComponent(0);if(d!=null){if(d.isXType("grid")){d.hide()}else{e.remove(d,true)}}if(c.isXType("grid")&&c.hidden==true){c.show()}else{e.insert(0,c)}e.fbar.removeAll(true);e.fbar.add(b);e.setWidth(a);e.doLayout();e.center()},maxValue:function(j,h){var g=0,d=0;for(var f=0,b=j.getCount();f<b;f++){var c=j.getAt(f).get(h);c=(new Number(c)).valueOf();if(c>g){g=c}if(c<d){d=c}}if(g==0){g=100}var e=(parseInt(g)==g&&parseInt(d)==d);var a=(g-d)/10;if(e){a=parseInt(a);if(a==0){a=1}}else{a=parseFloat(a).toFixed(2)}return[g,a]}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");Jxstar.JxSum=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a);Jxstar.JxSum.superclass.constructor.call(this)},init:function(b){this.grid=b;this.grid.jxsum=this;var a=this.view=b.getView();a.afterMethod("onColumnWidthUpdated",this.doWidth,this);a.afterMethod("onAllColumnWidthsUpdated",this.doAllWidths,this);a.afterMethod("onColumnHiddenUpdated",this.doHidden,this);a.afterMethod("onUpdate",this.doUpdate,this);a.afterMethod("onRemove",this.doRemove,this);if(!this.rowTpl){this.rowTpl=new Ext.Template('<div class="x-grid3-summary-row" style="{tstyle}">','<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr></tbody>","</table></div>");this.rowTpl.disableFormats=true}this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}">','<div class="x-grid3-cell-inner x-grid3-col-{id}">{value}</div>',"</td>");this.cellTpl.disableFormats=true}this.cellTpl.compile()},toggleSummaries:function(b){var a=this.grid.getGridEl();if(a){if(b===undefined){b=a.hasClass("x-grid-hide-summary")}a[b?"removeClass":"addClass"]("x-grid-hide-summary")}},renderSummary:function(d,h){h=h||this.view.getColumnData();var j=this.grid.getColumnModel().config,e=[],k,a={},b,l=h.length-1;for(var f=0,g=h.length;f<g;f++){k=h[f];b=j[f];a.id=k.id;a.style=k.style;a.css=f==0?"x-grid3-cell-first eb_sum":(f==l?"x-grid3-cell-last ":"");a.value=d.data[k.name];a.value=Ext.data.Types.FLOAT.convert(a.value);if(a.value==undefined||a.value===""){a.value="&#160;"}else{if(!isNaN(a.value)&&b.renderer){a.value=(b.renderer)(a.value)}}e[e.length]=this.cellTpl.apply(a)}return this.rowTpl.apply({tstyle:"width:"+this.view.getTotalWidth()+";",cells:e.join("")})},isGrouped:function(){return true},doWidth:function(d,b,c){if(!this.isGrouped()){return}var a=1,e=0,f;var g=this.view.mainBody.dom.childNodes;rlen=g.length;for(;e<a;++e){f=g[rlen-1];f.style.width=c;f.firstChild.style.width=c;f.firstChild.rows[0].childNodes[d].style.width=b}},doAllWidths:function(f,c){if(!this.isGrouped()){return}var e=1,b=0,a,k,h,d=f.length;var g=this.view.mainBody.dom.childNodes;rlen=g.length;for(;b<e;b++){k=g[rlen-1];k.style.width=c;k.firstChild.style.width=c;h=k.firstChild.rows[0].childNodes;for(a=0;a<d;a++){h[a].style.width=f[a]}}},doHidden:function(c,f,b){if(!this.isGrouped()){return}var a=1,d=0,e,h=f?"none":"";var g=this.view.mainBody.dom.childNodes;rlen=g.length;for(;d<a;d++){e=g[rlen-1];e.style.width=b;e.firstChild.style.width=b;e.firstChild.rows[0].childNodes[c].style.display=h}},refreshSummary:function(a){},getSummaryNode:function(a){var b=Ext.fly(a,"_gsummary");if(b){return b.down(".x-grid3-summary-row",true)}return null},refreshSummaryById:function(d){var f=Ext.getDom(d);if(!f){return false}var b=[];this.grid.getStore().each(function(g){if(g._groupId==d){b[b.length]=g}});var c=this.view.getColumnData(),a=this.renderSummary({data:data},c),e=this.getSummaryNode(d);if(e){f.removeChild(e)}Ext.DomHelper.append(f,a);return true},doUpdate:function(b,a){},doRemove:function(d,a,b,c){},refresh:function(c){var a=this.grid.getView().mainBody;if(!a){return}var b=this.renderSummary(c);a.select(".x-grid3-summary-row").remove();a.insertHtml("beforeEnd",b)}});
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxQuery={};(function(){Ext.apply(JxQuery,{funid:"",gridHis:null,gridDet:null,storeDet:null,queryWindow:function(c,d){var b=this;b.funid=d.nodeId;b.gridHis=b.historyGrid(c);b.gridDet=b.conditionGrid(d);var a=new Ext.Container({layout:"border",defaults:{margins:"2 2 2 2"},items:[{xtype:"container",region:"west",layout:"fit",width:200,items:[b.gridHis]},{xtype:"container",region:"center",layout:"fit",items:[b.gridDet]}]});JxUtil.delay(800,function(){var e=b.gridHis.getStore().getCount();if(e>0){b.gridHis.getSelectionModel().selectRow(0);b.gridHis.fireEvent("rowclick",b.gridHis,0)}});d.condGrid=b.gridDet;JxGroupExt.showCaseInQuery(d,b.gridDet);a.on("beforedestroy",function(){d.condGrid=null;delete d.condGrid});return a},historyGrid:function(m){var l=this;var d=new Ext.data.ArrayStore({fields:[{name:"query_id"},{name:"query_name"},{name:"is_share"},{name:"user_id"}]});var e=[];for(var f=0,g=m.root.length;f<g;f++){var k=[];k[0]=m.root[f].query_id;k[1]=m.root[f].query_name;k[2]=m.root[f].is_share;k[3]=m.root[f].user_id;e[f]=k}d.loadData(e);var j=function(){var n=JxUtil.getSelectRows(l.gridHis);if(!JxUtil.selectone(n)){return false}var i=n[0].get("user_id");if(i.length>0&&i!=JxDefault.getUserId()){JxHint.alert(jx.query.deluser);return false}var o=function(){var p=n[0].get("query_id");var q="funid=sysevent&pagetype=grid&eventcode=cond_delete";q+="&query_id="+p;Request.postRequest(q,function(){d.remove(n[0]);var r=d.getCount();if(r>0){l.gridHis.getSelectionModel().selectRow(0);l.gridHis.fireEvent("rowclick",l.gridHis,0)}else{l.storeDet.removeAll();l.gridDet.fkValue=""}})};Ext.Msg.confirm(jx.base.hint,jx.event.delyes,function(p){if(p=="yes"){o()}})};var a=function(){var i=this;var o="funid=sysevent&pagetype=grid&eventcode=cond_case";d.each(function(p){o+="&query_name="+p.get("query_name")+"&is_share="+p.get("is_share")+"&query_id="+p.get("query_id")});var n=function(){d.commitChanges()};Request.postRequest(o,n)};var b=new Ext.Toolbar({deferHeight:true,items:[{text:jx.base.del,iconCls:"eb_delete",handler:j},{text:jx.base.save,iconCls:"eb_save",handler:a}]});var c=new Ext.grid.RowSelectionModel();var h=new Ext.grid.EditorGridPanel({store:d,columns:[{header:jx.query.casename,width:140,dataIndex:"query_name",editable:true,hcss:"color:#3039b4;",editor:new Ext.form.TextField({maxLength:50,allowBlank:false})},{header:jx.query.pub,width:50,dataIndex:"is_share",editable:true,hcss:"color:#3039b4;",editor:new Ext.form.Checkbox(),renderer:function(i){return i=="1"?jx.base.yes:jx.base.no}},{header:"query_id",hidden:true,dataIndex:"query_id"},{header:"user_id",hidden:true,dataIndex:"user_id"}],tbar:b,sm:c,frame:false,border:true,enableHdMenu:false,stripeRows:true,columnLines:true,viewConfig:{forceFit:true}});h.on("rowclick",function(q,t,r){var i=q.getStore().getAt(t);if(i==null){return false}var p=i.get("query_id");var o=function(u){l.storeDet.removeAll();var x=[];for(var v=0,n=u.root.length;v<n;v++){var w=[];w[0]=u.root[v].left_brack;w[1]=u.root[v].colcode.replace(".","__");w[2]=u.root[v].condtype;w[3]=u.root[v].cond_value;w[4]=u.root[v].right_brack;w[5]=u.root[v].andor;w[6]=u.root[v].coltype;w[7]=u.root[v].col_no;x[v]=w}l.storeDet.loadData(x);l.gridDet.getView().refresh();l.gridDet.fkValue=p};var s="funid=queryevent&eventcode=cond_qrydet";s+="&query_id="+p;Request.dataRequest(s,o)});return h},saveQuery:function(j,g){var a=j.storeDet.getCount();if(a==0){JxHint.alert(jx.query.condempty);return false}for(var c=0;c<j.storeDet.getCount();c++){var d=j.storeDet.getAt(c);var h=d.get("cond_value");if(Ext.isEmpty(h)){JxHint.alert(String.format(jx.query.valempty,c+1));return false}}var b=j.gridDet.fkValue;if(b!=null&&b.length>0&&!g){j.saveQueryFn(b);return}var f=new Ext.form.FormPanel({layout:"form",labelAlign:"right",labelWidth:80,style:"padding-top:20px;",border:false,baseCls:"x-plain",items:[{xtype:"checkbox",fieldLabel:jx.query.share,name:"is_share"},{xtype:"textfield",fieldLabel:jx.query.casename,name:"query_name",allowBlank:false,labelSeparator:"*",anchor:"95%",labelStyle:"color:#0000ff;",maxLength:50}]});var e=new Ext.Window({title:jx.query.savetitle,layout:"fit",width:400,height:160,resizable:false,modal:true,closeAction:"close",items:[f],buttons:[{text:jx.base.ok,handler:function(){var l=f.getForm();var k=l.findField("is_share").getValue();var i=l.findField("query_name").getValue();if(i.length==0){JxHint.alert(jx.query.noname);return false}var m="&is_share="+k;m+="&query_name="+encodeURIComponent(i);j.saveQueryFn("",m,e)}},{text:jx.base.cancel,handler:function(){e.close()}}]});e.show()},saveQueryFn:function(d,f,b){var a=this;var e="funid=sysevent&selfunid="+a.funid;e+="&pagetype=grid&eventcode=cond_save&query_id="+d;a.storeDet.each(function(g){e+="&"+Ext.urlEncode(g.data)});if(f){e+=f}var c=function(h){if(d.length==0){h.user_id=JxDefault.getUserId();var g=new (a.gridHis.getStore().reader.recordType)(h);a.gridHis.getStore().insert(0,g)}a.gridHis.getSelectionModel().selectRow(0);a.gridHis.fireEvent("rowclick",a.gridHis,0);if(b){b.close()}};Request.postRequest(e,c)},conditionGrid:function(J){var w=this;var d=[];var A=new Ext.data.ArrayStore({fields:[{name:"left_brack"},{name:"colcode"},{name:"condtype"},{name:"cond_value"},{name:"right_brack"},{name:"andor"},{name:"coltype"},{name:"col_no"}]});A.loadData(d);w.storeDet=A;var e=new Ext.ux.grid.RowEditor({name:JxUtil.newId()+"_qv",saveText:jx.base.ok,cancelText:jx.base.cancel,listeners:{show:function(){p(u,true)},validateedit:function(c,h,i,M){var n=function(O,P){if(O!=null&&O.length>0){for(var N=0;N<O.length;N++){if(O.charAt(N)!=P){return false}}}return true};var K=h.left_brack;var L=h.right_brack;if(K!=null&&K.length>0&&!n(K,"(")){JxHint.alert("列【（】中只能输入 ( 字符！");return false}if(L!=null&&L.length>0&&!n(L,")")){JxHint.alert("列【）】中只能输入 ) 字符！");return false}return true}}});var F=new Ext.grid.CheckboxSelectionModel();var q=J.id+"_hqf";var v=J.page.getColumnModel();var b=[],r=v.config;for(var B=0,H=0,y=r.length;B<y;B++){var g=r[B],o=g.dataIndex;if(o==null||o.length==0){continue}if(g.colindex>=10000){continue}var D=o.length;if(o.substring(D-2)!="id"||!g.hidden){var E=g.header;if(E.charAt(0)=="*"){E=E.substr(1)}b[H++]=[o,E]}}var u=Jxstar.createCombo(q,b,100);var z=J.id+"_hqc";var d=ComboData.condtype;var k=Jxstar.createCombo(z,d);var I=J.id+"_hqa";var j=[["and",jx.query.and],["or",jx.query.or]];var s=Jxstar.createCombo(I,j);var a=4;var p=function(K,P){var U,c="string";var R=J.param.cols;for(var N=0,h=R.length;N<h;N++){var V=R[N].col,Q=R[N].field;if(Q&&Q.name==K.getValue()){c=Q.type;if(!V.hasOwnProperty("editor")){if(c=="string"){U=new Ext.form.TextField({allowBlank:false})}else{if(c=="date"){var W=JxUtil.getDateFormat(V.renderer);U=new Ext.form.DateField({format:W,allowBlank:false})}else{U=new Ext.form.NumberField({allowBlank:false,maxLength:12})}}}else{var L=V.editor;var M=false;if(L.isXType("combo")&&L.mode=="local"){M=true}Ext.apply(L.initialConfig,{allowBlank:true,editable:!M,cls:""});U=new L.constructor(L.initialConfig)}break}}if(U==null){U=new Ext.form.TextField({allowBlank:false})}if(P){var S=e.rowIndex;var O=A.getAt(S);var T="";if(O!=null){T=O.get("cond_value")}if(U.isXType("datefield")){T=Ext.isDate(T)?T.dateFormat("Y-m-d"):T;if(T.length>0){T=T.split(" ")[0]}T=Date.parseDate(T,"Y-m-d")}U.setValue(T)}U.selectOnFocus=true;e.remove(e.getComponent(a),true);e.insert(a,U);e.verifyLayout();w.setCondDefault(k,c,U.getXType());e.record.set("coltype",c)};u.on("select",function(c){p(c,false)});var m=new Ext.grid.ColumnModel([F,{id:"left_brack",header:"（",width:30,dataIndex:"left_brack",hcss:"color:#004080;",editor:new Ext.form.TextField()},{id:"colcode",header:jx.query.colcode,width:130,dataIndex:"colcode",hcss:"color:#0000ff;",editor:u,renderer:function(h){for(var c=0;c<b.length;c++){if(b[c][0]==h){return b[c][1]}}}},{id:"condtype",header:jx.query.cond,width:70,dataIndex:"condtype",hcss:"color:#0000ff;",editor:k,renderer:function(h){for(var c=0;c<d.length;c++){if(d[c][0]==h){return d[c][1]}}}},{id:"cond_value",header:jx.query.value,width:110,dataIndex:"cond_value",hcss:"color:#0000ff;",editor:new Ext.form.TextField(),renderer:function(c){var c=Ext.isDate(c)?c.format("Y-m-d"):c;if(c.length>0&&c.indexOf(" 00:00:00")>=0){c=c.split(" ")[0]}return c}},{id:"right_brack",header:"）",width:30,dataIndex:"right_brack",hcss:"color:#004080;",editor:new Ext.form.TextField()},{id:"andor",header:jx.query.andor,width:50,dataIndex:"andor",hcss:"color:#004080;",editor:s,renderer:function(h){for(var c=0;c<j.length;c++){if(j[c][0]==h){return j[c][1]}}}},{id:"col_no",header:jx.query.colno,width:40,dataIndex:"col_no",hcss:"color:#004080;",editor:new Ext.form.TextField()},{id:"coltype",dataIndex:"coltype",hidden:true},{id:"colname",dataIndex:"colname",hidden:true}]);var x=function(){var h=new (A.reader.recordType)({left_brack:"",colcode:b[0][0],condtype:d[0][0],cond_value:"",right_brack:"",andor:j[0][0],coltype:"string",col_no:"0"});e.stopEditing();A.insert(0,h);f.getView().refresh();f.getSelectionModel().selectRow(0);e.startEditing(0);u.fireEvent("select",u)};var G=function(){e.stopEditing();var h=f.getSelectionModel().getSelections();if(h==null||h.length==0){JxHint.alert(jx.query.delcond);return false}for(var c=0,n;n=h[c];c++){A.remove(n)}};var l=new Ext.Toolbar({deferHeight:true,items:[{text:jx.base.add,iconCls:"eb_add",handler:x},{text:jx.base.del,iconCls:"eb_delete",handler:G},{text:jx.base.save,iconCls:"eb_save",handler:function(){w.saveQuery(w)}},{text:jx.query.save,iconCls:"eb_copy",handler:function(){w.saveQuery(w,true)}}]});var t=function(){var n=A.getCount();if(n==0){JxHint.alert(jx.query.nocond);return false}for(var h=0;h<A.getCount();h++){var c=A.getAt(h);var L=c.get("cond_value");if(Ext.isEmpty(L)){JxHint.alert(String.format(jx.query.valempty,h+1));return false}}var K=w.getQuery(A);if(K==null){return false}A.commitChanges();Jxstar.myQuery(J.page,K,"1")};var C=[{text:"查询",iconCls:"eb_qry",handler:t},{text:"统计",iconCls:"eb_sum",handler:function(){JxGroupExt.caseWin(J)}}];var f=new Ext.grid.GridPanel({store:A,cm:m,sm:F,tbar:l,plugins:[e],frame:false,border:true,enableHdMenu:false,stripeRows:true,columnLines:true,viewConfig:{forceFit:true},buttonCls:"",buttonAlign:"center",buttons:C});f.on("rowdblclick",function(c,h){p(u,true)});return f},getQuery:function(n){if(n==null||n.getCount()==0){return null}var m=new Array("","","");var f="",c="";for(var j=0;j<n.getCount();j++){var h;if(n.getAt){h=n.getAt(j).data}else{h=n.itemAt(j)}var l=h.left_brack;var k=h.colcode.replace("__",".");var d=h.condtype;var e=h.cond_value;var p=h.right_brack;var a=h.andor;var b=h.coltype;f+=l.trim();c+=p.trim();if(Ext.isEmpty(e)){continue}if(e=="~null~"){if(d=="<>"){m[0]+=k+" is not null "+a+" "}else{m[0]+=k+" is null "+a+" "}continue}e=Ext.isDate(e)?e.dateFormat("Y-m-d"):e;var o=this.getQueryValue(e,d,b);if(d=="="&&b=="date"){m[0]+=l;m[0]+="("+k+" >= ? and "+k+" < ? )";m[0]+=p;m[0]+=" "+a+" ";var g=JxUtil.getNextDate(o[0],1);m[1]+=o[0]+";"+g+";";m[2]+=b+";"+b+";"}else{m[0]+=l;m[0]+=k+this.getCondType(d)+"?";m[0]+=p;m[0]+=" "+a+" ";m[1]+=o[0]+";";m[2]+=o[1]+";"}}if(f.length!=c.length){JxHint.alert("左边与右边的括号不匹配，不能执行查询！");return null}if(m[0].length>0){m[0]="("+m[0].substr(0,m[0].length-(a.length+1))+")"}if(m[1].length>0){m[1]=m[1].substr(0,m[1].length-1)}if(m[2].length>0){m[2]=m[2].substr(0,m[2].length-1)}return m},getWhere:function(a,c,e,g){var d=new Array("","","");if(Ext.isEmpty(e)){return d}if(e=="~null~"){if(c=="<>"){d[0]=a+" is not null"}else{d[0]=a+" is null"}return d}e=Ext.isDate(e)?e.dateFormat("Y-m-d"):e;var b=this.getQueryValue(e,c,g);if(c=="="&&g=="date"){d[0]+="("+a+" >= ? and "+a+" < ? )";var f=JxUtil.getNextDate(b[0],1);d[1]+=b[0]+";"+f;d[2]+=g+";"+g}else{d[0]+=a+this.getCondType(c)+"?";d[1]+=b[0];d[2]+=b[1]}return d},getCondType:function(b){var a="like";if(b==""){return a}switch(b){case"=":a=" = ";break;case">":a=" > ";break;case"<":a=" < ";break;case">=":a=" >= ";break;case"<=":a=" <= ";break;case"<>":a=" <> ";break;case"llike":a=" like ";break;case"rlike":a=" like ";break;case"like":a=" like ";break}return a},getQueryValue:function(c,b,d){var a=new Array();switch(d){case"string":if(b=="llike"){a[0]=c+"%"}else{if(b=="rlike"){a[0]="%"+c}else{if(b=="like"){a[0]="%"+c+"%"}else{a[0]=c}}}a[1]="string";break;case"int":a[0]=c;a[1]="int";break;case"date":a[0]=c;a[1]="date";break;case"float":a[0]=c;a[1]="double";break;default:a[0]=c;a[1]=d;break}return a},setCondDefault:function(d,e,a){var b=d.store;var c=b.reader.recordType;if(e=="string"){if(b.getCount()==5){b.insert(5,new c({value:"llike",text:jx.query.llike}));b.insert(6,new c({value:"rlike",text:jx.query.rlike}));b.insert(7,new c({value:"like",text:jx.query.like}))}d.setValue("like");if(a=="combo"){d.setValue("=")}}else{d.setValue("=");if(b.getCount()==8){b.remove(b.getAt(7));b.remove(b.getAt(6));b.remove(b.getAt(5))}}}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxExport={};(function(){Ext.apply(JxExport,{showWindow:function(m){var q=m.page.getColumnModel();var p=[],g=q.config;for(var d=0,k=0,a=g.length;d<a;d++){var b=g[d],l=b.dataIndex;if(l&&l.length>0){var e=b.header;if(e.charAt(0)=="*"){e=e.substr(1)}p[k++]=[l,e]}}var o=new JxLists({leftData:p});var j=o.render();var f=new Ext.Window({title:jx.base.seltitle,layout:"fit",width:400,height:500,resizable:false,modal:true,closeAction:"close",items:[j],buttons:[{text:jx.base.ok,handler:function(){var c=o.getSelectData();if(c.length==0){JxHint.alert(jx.base.nofield);return false}JxExport.executeExp(m,c);f.close()}},{text:jx.base.cancel,handler:function(){f.close()}}]});f.show()},executeExp:function(b,a){var c=b.page.getStore().lastOptions.params||{};var d=b.nodeId;var e="funid=sysevent&query_funid="+d;e+="&pagetype=grid&eventcode=expxls&dataType=xls";e+="&selfield="+a+"&zerotonull=0";Request.expFile(e,c)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxPrint={};(function(){Ext.apply(JxPrint,{hasReport:false,showWindow:function(b){var a=this;var d=b.nodeId;var c=function(h){var j=[];if(h==null||h.length==0){a.hasReport=false;j[0]={baseCls:"x-plain",border:false,html:'<font color="red">'+jx.print.noreport+"</font>"}}else{a.hasReport=true;for(var f=0,k=h.length;f<k;f++){var g={boxLabel:h[f].report_name,xtype:"radio",name:"reportId",inputValue:h[f].report_id,checked:false};if(f==0){g.checked=true}j[f]=g}}a.createWindow(d,j,b)};var e="funid=rpt_list&pagetype=grid&eventcode=listdata&selfunid="+d;Request.dataRequest(e,c)},createWindow:function(c,e,b){var f=new Ext.form.FormPanel({style:"padding:20 20 0 0px;",border:false,frame:false,baseCls:"x-plain",items:[{xtype:"fieldset",title:jx.print.seltemp,height:90,autoScroll:true,hideLabels:true,style:"margin-left:10px;",items:e},{xtype:"fieldset",title:jx.print.outtype,autoHeight:true,defaultType:"radio",hideLabels:true,style:"margin-left:10px;",items:[{boxLabel:jx.print.outxls,name:"printType",inputValue:"xls",checked:true},{boxLabel:jx.print.outhtm,name:"printType",inputValue:"html"}]},{xtype:"fieldset",title:jx.print.outrang,autoHeight:true,defaultType:"radio",hideLabels:true,style:"margin-left:10px;",items:[{boxLabel:jx.print.outrec,name:"printScope",inputValue:"select",checked:true},{boxLabel:jx.print.outall,name:"printScope",inputValue:"query"}]}]});var a=this;var d=new Ext.Window({title:jx.print.ptitle,layout:"fit",width:280,height:380,resizable:false,modal:true,closeAction:"close",items:[f],buttons:[{text:jx.base.ok,disabled:(!a.hasReport),handler:function(){JxPrint.printReport(c,f.getForm(),b);d.close()}},{text:jx.base.cancel,handler:function(){d.close()}}]});d.show()},printReport:function(f,c,a){var b=c.findField("reportId").getGroupValue();var e=c.findField("printType").getGroupValue();var d=c.findField("printScope").getGroupValue();this.exePrint(a,f,b,e,d,"0")},exePrint:function(t,q,g,f,i,l){g=g||"";f=f||"xls";i=i||"select";l=l||"0";var h="";var a="";var o="";var c="0";if(i=="select"){h=this.selectWhere(t);if(h.length==0){JxHint.alert(jx.print.selectno);return false}c="1"}else{if(i=="query"){var m=this.queryWhere(t);h=m[0];a=m[1];o=m[2];c=m[3]}else{return false}}var s={reportId:g,printType:f,printScope:i,printMode:l};if(t.event.fireEvent("beforeprint",t.event,s)==false){return false}var n=encodeURIComponent;var p="funid="+q+"&reportId="+g+"&printType="+f+"&printMode="+l+"&queryType="+c;var b="&whereSql="+n(h)+"&whereValue="+n(a)+"&whereType="+o;if(g.length==0){p+="&isDefault=1"}p+="&user_id="+Jxstar.session.user_id;if(typeof t.event.dataPrintParam=="function"){var r=t.event.dataPrintParam(s);if(r&&r.length>0){if(r.charAt(0)!="&"){r="&"+r}p+=r}}var j=Jxstar.path+"/reportAction.do?"+p;if("xls"==f){var d={whereSql:h,whereValue:a,whereType:o};this.postExpReport(j,d)}else{var k="w_report_"+parseInt(Math.random()*10000);this.newPrintWindow(j+b,k,800,600)}t.event.fireEvent("afterprint",t.event,s)},postExpReport:function(b,d){var c=Ext.get("frmExpReport");if(!c){c=Ext.DomHelper.append(Ext.getBody(),{tag:"form",method:"post",id:"frmExpReport",name:"frmExpReport",target:"frmhidden",cls:"x-hidden",cn:[{tag:"input",name:"exp_text",id:"exp_text",type:"hidden"},{tag:"input",name:"whereSql",id:"whereSql",type:"hidden"},{tag:"input",name:"whereValue",id:"whereValue",type:"hidden"},{tag:"input",name:"whereType",id:"whereType",type:"hidden"}]},true)}var a=d||{};c.child("#whereSql").set({value:a.whereSql||""});c.child("#whereValue").set({value:a.whereValue||""});c.child("#whereType").set({value:a.whereType||""});c.dom.action=b;c.dom.submit()},newPrintWindow:function(c,b,d,a){var e=window.open(c,b,"resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=yes,location=no");e.focus();e.moveTo((screen.width-d)/2,(screen.height-a)/2);e.resizeTo(d,a)},queryWhere:function(a){var c=[4];var b=a.page.getStore().lastOptions.params||{};c[0]=b.where_sql||"";c[1]=b.where_value||"";c[2]=b.where_type||"";c[3]=b.query_type||"0";return c},selectWhere:function(d){var f=d.page;var c="";var b=d.define.pkcol;if(d.pageType.indexOf("form")>-1){var g=f.getForm().findField(b).getValue();if(g!=null&&g.length>0){c="'"+g+"'"}}else{var a=f.getSelectionModel().getSelections();if(a.length>0){for(var e=0,h=a.length;e<h;e++){c+="'"+a[e].get(b)+"',"}c=c.substring(0,c.length-1)}}if(c.length>0){c=b.replace("__",".")+" in ("+c+")"}return c}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxHint={};(function(){var a;Ext.apply(JxHint,{hint:function(c){if(!a){a=Ext.DomHelper.insertFirst(document.body,{id:"msg-div"},true)}a.alignTo(document,"t-t",[-20,0]);var b=Ext.DomHelper.append(a,{html:'<div class="msg-hint">'+c+"</div>"},true);b.slideIn("t").pause(2).ghost("t",{remove:true})},alert:function(b){Ext.Msg.alert(jx.base.hint,b)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxSelect={};(function(){Ext.apply(JxSelect,{createSelectWin:function(c,e,i){if(e.readOnly||e.disabled){return}var g=false;if(c.isMoreSelect=="1"){g=true;c.pageType="selgrid"}var h=this;var b=c.nodeId;var d=Jxstar.findNode(b);if(d==null){JxHint.alert(String.format(jx.star.nopage,b));return}var f=function(k){var j=k(d,{pageType:c.pageType});if(typeof j.showPage=="function"){j=j.showPage(c.pageType)}j.height=495;var l=new Ext.Window({title:jx.base.select+d.nodetitle,layout:"fit",width:750,height:500,border:false,modal:true,closeAction:"close",items:[j]});l.show();JxUtil.delay(500,function(){var n=j;if(!n.isXType("grid")){n=n.getComponent(1);if(n==null){JxHint.alert(jx.star.nogrid);return false}else{n=n.getComponent(0)}}var m=c.whereValue;m=h.parseWhereValue(m,e,i);Jxstar.loadData(n,{where_sql:c.whereSql,where_value:m,where_type:c.whereType});n.on("rowdblclick",function(q,v,s){var o=JxUtil.getSelectRows(q);if(o==null||o.length==0){var p=q.getStore();o=[];o[0]=JxUtil.emptyRecord(p)}else{if(!g){o=[o[0]]}}var r=e.getValue();var t=e.ownerCt;if(t&&t.initialConfig.name&&t.initialConfig.name.indexOf("_qv")>0){h.setControlData(o,e,c.sourceField,c.targetField)}else{var u=h.selectTagRecord(e,i);h.setSelectData(o,u,c.isSame,c.sourceField,c.targetField)}l.close();e.fireEvent("change",e,e.getValue(),r)})})};var a=c.layoutPage;if(a==null||a.length==0){a=d.gridpage}if(a==null||a.length==0){JxHint.alert(jx.star.noselect);return}Request.loadJS(a,f)},createComboGrid:function(e,b,j){var i=this;var d=e.nodeId;var h=b.parentField;var f=Jxstar.findNode(d);if(f==null){JxHint.alert(String.format(jx.star.nopage,d));return}var c=function(l){var k=e.whereValue;k=i.parseWhereValue(k,h,j);Jxstar.loadData(l,{where_sql:e.whereSql,where_value:k,where_type:e.whereType})};var g=function(l){var k=l(f,{pageType:e.pageType});if(typeof k.showPage=="function"){k=k.showPage(e.pageType)}k.height=295;b.add(k);b.doLayout();c(k);b.on("show",function(){c(k)});b.on("destroy",function(){e=null;j=null;c=null});k.on("rowclick",function(p,o,r){if(!b.isVisible()){return false}var m=JxUtil.getSelectRows(p);if(m==null||m.length==0){var n=p.getStore();m=[];m[0]=JxUtil.emptyRecord(n)}else{m=[m[0]]}var q=h.ownerCt;if(q&&q.initialConfig.name&&q.initialConfig.name.indexOf("_qv")>0){i.setControlData(m,h,e.sourceField,e.targetField)}else{var s=i.selectTagRecord(h,j);i.setSelectData(m,s,e.isSame,e.sourceField,e.targetField)}b.hide()})};var a=f.gridpage;if(a==null||a.length==0){JxHint.alert(jx.star.noselect);return}Request.loadJS(a,g)},parseWhereValue:function(d,f,j){var i=this;if(d!=null&&d.indexOf("{")>=0){if(j.indexOf("grid")>=0){var e=f.el.findParentNode("div.x-grid-panel");var h=Ext.getCmp(e.id);if(h){var a=JxUtil.getParentForm(h);var b=null;if(a){b=a.myRecord}if(!b){var g=JxUtil.getParentGrid(h);if(g){var c=JxUtil.getSelectRows(g);if(c&&c.length>0){b=c[0]}}}if(b){d=JxUtil.parseWhereValue(d,b,true)}}}}if(d!=null&&d.indexOf("[")>=0){var b=i.selectTagRecord(f,j);d=JxUtil.parseWhereValue(d,b)}return d},selectTagRecord:function(g,b){var h;if(b.indexOf("grid")>=0){var f=g.el.findParentNode("div.x-grid-panel");var c=Ext.getCmp(f.id);if(c){var e=c.lastEdit;if(e){h=c.getStore().getAt(e.row)}else{var a=JxUtil.getSelectRows(c);if(a&&a.length>0){h=a[0]}}}}else{var d=g.ownerCt;if(d.isXType("form")==false){d=d.findParentByType("form")}if(d){h=d.getForm()}}if(Ext.isEmpty(h)){JxHint.alert(jx.star.notag)}return h},setControlData:function(l,j,a,o){var r=this;var q=j.ownerCt;if(q.isXType("toolbar")){var p=a.split(";");var m=o.split(";");if(p[0].length==0||m[0].length==0){JxHint.alert(jx.star.noselfield);return false}var e=p[0].split(".")[0];for(var g=0,d=p.length;g<d;g++){if(p[g].length==0||m[g]==null||m[g].length==0){continue}var k=p[g].split(".");if(k.length>1){f=k[0]+"__"+k[1];e=k[0]}else{f=e+"__"+p[g]}var b=r.getValue(l,f);var c=m[g].replace(".","__");var h=q.find("name",c);if(h==null||h.length==0){continue}h[0].setValue(b)}}else{var f=a.split(";")[0].replace(".","__");if(f==null||f.length==0){JxHint.alert(jx.star.nosrc);return false}var b=r.getValue(l,f);j.setValue(b)}},setSelectData:function(e,l,o,s,m){var k=this;var p,a;var d=l.data;if(d==null){d=l.getFieldValues()}if(o=="1"){for(p in e[0].data){var c=p.split("__")[1];for(a in d){var h=a.split("__")[1];if(c.indexOf("auditing")<0&&c==h){l.set(a,k.getValue(e,p))}}}}if(s!=null&&s.length>0){var r=s.split(";");var g=m.split(";");var q=r[0].split(".")[0];var b=g[0].split(".")[0];for(var n=0;n<r.length;n++){if(r[n].length==0||g[n]==null||g[n].length==0){continue}var f=r[n].split(".");if(f.length>1){p=f[0]+"__"+f[1];q=f[0]}else{p=q+"__"+r[n]}var j=g[n].split(".");if(j.length>1){a=j[0]+"__"+j[1];b=j[0]}else{a=b+"__"+g[n]}l.set(a,k.getValue(e,p))}}},initCombo:function(h,f,d,a){var c=this;f.pageSize=10;f.minListWidth=350;f.typeAhead=false;f.minChars=0;f.itemSelector="div.search-item";f.queryParam="where_value";f.loadingText="正在查询...";f.listEmptyText="没有找到数据...";f.isAll=f.isAll||a||(Jxstar.systemVar.edit__combo__all=="1");var e=f.getName();var b=function(A){var x=A.selcfg;if(!x||!A.fields){JxHint.alert(String.format(jx.star.selnot,e));return}var i=x.nodeId;var o=x.queryField||"",z=x.sourceField||"";if(o.length==0&&z.length==0){JxHint.alert(String.format(jx.star.selsrc,e));return}var r=c.comboWhere(x);var w=encodeURIComponent;var m=Jxstar.path+"/commonAction.do?eventcode=query_data&funid=queryevent&pagetype=grid";m+="&query_funid="+i+"&where_sql="+w(r.where_sql)+"&where_type="+r.where_type+"&user_id="+Jxstar.session.user_id;var n=new Ext.data.Store({proxy:new Ext.data.HttpProxy({method:"POST",url:m}),reader:new Ext.data.JsonReader({root:"data.root",totalProperty:"data.total"},A.fields)});f.store=n;var s={},u=0;Ext.each(A.fields,function(j){if(j.type=="date"){u++;s[j.name]=j}});var t=A.design,y=0,p=[],v=0;Ext.each(t,function(j){if(!j.h){y+=j.w;if(u>0&&s[j.n]){var C=s[j.n].dateFormat;p[v++]='<td style="width:'+j.w+'px;">{[values.'+j.n+" ? values."+j.n+'.format("'+C+'") : ""]}</td>'}else{p[v++]='<td style="width:'+j.w+'px;">{'+j.n+"}</td>"}}});var B=new Ext.XTemplate('<tpl for="."><div class="search-item" style="width:'+y+'px;border-bottom:1px dotted #a3bae9;">','<table border=0 style="width:100%;font-size:12px;"><tr>',p.join(""),"</tr></table>","</div></tpl>");f.tpl=B;f.on("beforequery",function(E){var D=E.combo;var C=D.isAll;var j=x.likeType;var I="",G="";for(var F=0;F<r.plen;F++){G=C?"%;":(((j=="left")?"":"%")+E.query+"%;");I+=G}r.where_value=c.parseWhereValue(x.whereValue,D,d);var H=r.where_value;if(I.length>0){I=I.substr(0,I.length-1);if(H&&H.length>0){I=H+";"+I}}else{I=H}E.query=I});var l=function(j,C){var D=j.ownerCt;if(D&&D.initialConfig.name&&D.initialConfig.name.indexOf("_qv")>0){c.setControlData([C],j,x.sourceField,x.targetField)}else{var E=c.selectTagRecord(j,d);c.setSelectData([C],E,x.isSame,x.sourceField,x.targetField);if(d.indexOf("grid")>=0){j.setValue(E.get(j.getName()))}}};f.on("select",function(j,C,D){l(j,C);j.selValue=j.getValue()});f.on("focus",function(j){j.selValue=j.getValue()});var q=x.isReadonly;f.on("blur",function(j){if(d.indexOf("form")>=0){var D=j.getValue();if(D.length==0||(j.selValue&&j.selValue!=D)){var C=JxUtil.emptyRecord(n);l(j,C)}if(q=="0"){j.setValue(D)}}});if(d.indexOf("grid")>=0){var k=f.gridEditor;if(k){k.on("complete",function(C,E,F){if(Ext.isEmpty(E)&&Ext.isEmpty(F)){return}var D=C.field;if(E.length==0||(E!=F&&E!=D.selValue)){var j=JxUtil.emptyRecord(n);l(D,j)}if(q=="0"){C.setValue(E)}})}}if(f.list){f.view.tpl=f.tpl;f.bindStore(n,false)}};var g="funid=queryevent&selfunid="+h;g+="&colcode="+e.replace("__",".")+"&pagetype=grid&eventcode=query_selctl";Request.dataRequest(g,b)},getValue:function(a,g){var d=(a.length>1);if(d){var f="";for(var c=0,h=a.length;c<h;c++){f+=a[c].get(g)+";"}return f}else{var f=a[0].get(g);if(f==null){var e=g.split("__");if(e.length>1&&e[1].length>0){var b=e[1];if(b.charAt(0)=="["&&b.charAt(b.length-1)=="]"){f=b.substring(1,b.length-1)}}}return f}},comboWhere:function(a){var k=a.whereSql;var c=a.whereValue;var l=a.whereType;var b=a.queryField,h=0;if(b&&b.length>0){var f=b.split(";"),e="",j="";for(var d=0;d<f.length;d++){if(f[d].length>0){e+=f[d]+" like ? or ";j+="string;";h++}}if(e.length>0){if(k.length>0){k="("+k+") and "}if(l.length>0){l=l+";"}k+="("+e.substr(0,e.length-4)+")";l+=j.substr(0,j.length-1)}}else{var g=a.sourceField;if(g&&g.length>0){b=g.split(";")[0];if(b.length>0){if(k.length>0){k="("+k+") and "}k=k+b+" like ?";if(l.length>0){l=l+";"}l=l+"string";h=1}}}return{where_sql:k,where_value:c,where_type:l,plen:h}}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxFormSub={};(function(){Ext.apply(JxFormSub,{formAddSub:function(d){var o=d.param;var g=Jxstar.findNode(o.funid);var j=g.subfunid;if(j==null||j.length==0){return}var b=g.notTabFunId||"";if(b.length>0){j=b}var p=g.subExpand||false;var l=o.items;var h=j.split(",");for(var e=0,c=h.length;e<c;e++){var q=h[e];if(q.length==0){continue}var f=Jxstar.findNode(q);var m=f.nodetitle;f.showInForm=true;var k=(e>0);if(p){k=false}var a={title:m,baseCls:"xs-panel",iconCls:"sub_title",data:q,cls:"sub_panel",border:true,layout:"fit",collapsible:true,collapsed:k,anchor:"100%",height:230};Ext.apply(a,o.subConfig);l[l.length]=a}},formShowSub:function(f){var c=f.event;var e=f.page;var d=f.param;var a=e.find("cls","sub_panel");if(a==null||a.length==0){return}for(var b=0,h=a.length;b<h;b++){var g={pageType:"subgrid",parentNodeId:f.nodeId};Jxstar.createPage(a[b].data,"gridpage",a[b],g)}c.on("initother",function(k){if(a==null||a.length==0){return}var o=k.define;var j=k.form;var i=o.pkcol;var n=j.get(i);var m=function(){for(var s=0,q=a.length;s<q;s++){var t=a[s];var x=t.getComponent(0);if(n==null||n.length==0){x.getStore().removeAll();x.fkValue="";x.disable()}else{x.enable();Jxstar.loadSubData(x,n)}if(t.header){t.header.setStyle("cursor","pointer");t.header.on("click",function(){if(this.collapsed){this.expand(true)}else{this.collapse(true)}},t)}if(d.subResizable&&t.el&&(t.outRe==null)){var y=new Ext.Resizable(t.el,{minHeight:180,minWidth:600,listeners:{resize:function(B,z,A){B.innerCmp.setWidth(z);B.innerCmp.setHeight(A)}}});y.innerCmp=t;t.outRe=y;t.on("destroy",function(z){z.outRe.destroy(true);z.outRe=null;delete z.outRe})}if(o.auditcol.length>0){var w="0",v="2",u="6";if(o.status){w=o.status.audit0;v=o.status.audit2}var p=j.get(o.auditcol);if(p==null||p.length==0){p=w}var r=(p!=w&&p!=u);JxUtil.delay(500,function(B){var C=B.getTopToolbar();JxUtil.disableButton(C,r);var A=B.gridNode.define;var D=A.subChkEdit||false;if(f.pageType=="chkform"&&D&&p==v){var z=JxUtil.getButton(C,"save_eg");if(z){z.enable()}}},this,[x])}}};var l=a[0].getComponent(0);if(l){m()}else{JxUtil.delay(500,m)}});c.on("beforecreate",function(i){c.fireEvent("initother",c)});c.on("aftercreate",function(i){c.fireEvent("initother",c)});c.on("afteraudit",function(i){c.fireEvent("initother",c)});c.on("aftercustom",function(i){c.fireEvent("initother",c)})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxQueryExt={};(function(){Ext.apply(JxQueryExt,{initQrys:[["0","--查询方案--"],["1","--自定义..."]],showCase:function(c){if(Jxstar.systemVar.page__query__two=="1"){JxQueryExt.renderToolQry(c);return}var b=this,d=c.page;var g=d.getTopToolbar();g.add("-");var a=b.initQrys;var e=JxUtil.newId()+"_qry";var f=Jxstar.createCombo(e,a,100);g.add(f);f.on("beforeselect",function(j,h){var m=h.get("value");var l=j.getValue();if(m!=l&&m=="0"){b.renderToolQry(c)}else{if(m!=l&&m=="1"){b.openToolQry(c,j)}else{if(m!=l){var i=function(n){b.renderToolQry(c,n.qrycond)};var k="funid=sys_query&queryid="+m+"&pagetype=grid&eventcode=selcase";Request.dataRequest(k,i)}}}});b.loadQryCase(c,f)},openToolQry:function(a,c){var b=this.queryWindow(a);b.on("destroy",function(){JxQueryExt.loadQryCase(a,c)})},loadQryCase:function(b,c){var a=function(g){var f=g.qrycase,h=JxQueryExt.initQrys;var e=[h[0],h[1]];Ext.each(f,function(i){e[e.length]=[i.value,i.text]});c.getStore().loadData(e);if(g.qryid.length>0){c.setValue(g.qryid);JxQueryExt.renderToolQry(b,g.qrycond)}else{c.setValue("0");JxQueryExt.renderToolQry(b)}};var d="funid=sys_query&qryfunid="+b.nodeId+"&pagetype=grid&eventcode=reloadcase";Request.dataRequest(d,a)},renderToolQry:function(a,c){var b=a.page;var d=function(){if(Ext.isEmpty(b.qryCt)){JxHint.alert("查询字段容器未显示！");return}b.qryCt.removeAll(true);var f=[],e=1;if(c){if(c.length>0){f=JxQueryExt.showQryTool(a,c);e=f.length}}else{f=JxQueryExt.hcfg();Jxstar.addBaseQry(a,f);if(Jxstar.systemVar.page__query__two=="1"){f.add({xtype:"button",iconCls:"eb_qryh",tooltip:jx.star.hqry,handler:function(){Jxstar.showQuery(a)}})}else{if(a.define.isarch=="1"){f.add(JxQueryExt.archCfg)}}}b.qryCt.add(f);b.qryCt.setHeight(24*e+2);b.qryCt.doLayout();b.setHeight(b.ownerCt.getHeight());b.ownerCt.doLayout()};if(b.bwrap==null){b.on("render",d)}else{d()}},hcfg:function(a){var b={name:JxUtil.newId()+"_qv",xtype:"container",layout:"hbox",border:false,layoutConfig:{padding:"1",align:"middle"},defaults:{margins:"0 0 0 5"},items:a||[]};if(a){return b}else{return new Ext.Container(b)}},archCfg:{xtype:"checkbox",boxLabel:"含归档数据",width:80,name:"xx_isarch",checked:false},showQryTool:function(l,k){if(k==null||k.length==0){return[]}var s=0,h=[];for(var f=0,c=k.length;f<c;f++){var o=k[f].row_no;if(Ext.isEmpty(o)){o="1"}if(s==parseInt(o)){var u=h[s-1];u[u.length]=k[f]}else{s=parseInt(o);h[s-1]=[k[f]]}}var g=[];var t=this,a=l.page;var p=l.param.cols;for(var f=0,c=h.length;f<c;f++){var r=h[f];var b=[];for(var e=0,d=r.length;e<d;e++){var q=r[e];q.colcode=q.colcode.replace(".","__");b=t.addQryField(q,p,b)}if(f==c-1){b[b.length]={xtype:"button",iconCls:"eb_qry",tooltip:jx.star.qry,handler:t.exeQry,data:a};if(l.define.isarch=="1"){b[b.length]=t.archCfg}}g[g.length]=t.hcfg(b)}return g},addQryField:function(o,k,b){var t=this;var r,q,a;for(var g=0,m=0,d=k.length;g<d;g++){var p=k[g].col,j=k[g].field;if(p==null||j==null){continue}if(j.name==o.colcode){a=j.type;if(!p.hasOwnProperty("editor")){if(a=="string"){q={xtype:"textfield"}}else{if(a=="date"){var s=JxUtil.getDateFormat(p.renderer);q={xtype:"datefield",format:s}}else{q={xtype:"numberfield",maxLength:12}}}}else{var e=p.editor;var f=false;if(e.isXType("combo")&&e.mode=="local"){f=true}Ext.apply(e.initialConfig,{allowBlank:true,editable:!f,cls:"",xtype:e.getXType()});q=e.initialConfig;if(f){q.iscombo=f;q.value="";q.listeners=Ext.apply(q.listeners||{},{specialkey:function(c,i){if(i.getKey()==i.DELETE||i.getKey()==i.BACKSPACE){c.setValue("")}if(i.getKey()==i.ENTER){t.exeQry(c)}}})}}var l=o.colname;if(Ext.isEmpty(l)){l=p.header}l+=": ";if(a=="date"){o.colname=l;t.dateCfgs(b,o)}else{var h=b.length;b[h]={xtype:"label",text:l};q.data=o;q.width=100;q.name=o.colcode;if(!q.iscombo){q.listeners=Ext.apply(q.listeners||{},{specialkey:function(c,i){if(i.getKey()==i.ENTER){t.exeQry(c)}}})}b[h+1]=q}break}}return b},exeQry:function(c){var f=c.ownerCt;var a=f.ownerCt;if(c.isXType("field")){c=a.findByType("button")[0]}var i=a.findByType("checkbox")[0];var e="0";if(i&&i.getValue()=="1"){e="1"}var h=c.initialConfig.data;var d=JxQueryExt.getQryField(a);var g=JxQuery.getQuery(d);Jxstar.myQuery(h,g,e)},getQryField:function(a){var b=new Ext.util.MixedCollection();a.items.each(function(c){c.items.each(function(g){if(g.isXType("field")&&g.getName()!="xx_isarch"){var e=g.getValue();var h=g.data;if(h&&Ext.isEmpty(e)==false){h.cond_value=e;b.add(h)}}})});return b},dateCfgs:function(l,j){var m=this;var o=l.length;var i=j.colcode;l[o++]={xtype:"tbtext",text:j.colname};var g=JxUtil.getToday();g=Date.parseDate(g,"Y-m-d");var b=JxUtil.getToday(-1);b=Date.parseDate(b,"Y-m-d");var h=JxUtil.getWeekDates();var q=Date.parseDate(h[0],"Y-m-d");var p=Date.parseDate(h[1],"Y-m-d");var t=JxUtil.getMonthDates();var e=Date.parseDate(t[0],"Y-m-d");var d=Date.parseDate(t[1],"Y-m-d");var s=Ext.applyIf({condtype:">="},j);if(s.right_brack.length>0){s.right_brack=""}var f=Ext.applyIf({condtype:"<"},j);if(s.left_brack.length>0){f.left_brack=""}var k={specialkey:function(u,v){if(v.getKey()==v.ENTER){m.exeQry(u)}}};var a=new Ext.form.DateField({xtype:"datefield",width:100,name:i,format:"Y-m-d",value:g,data:s,listeners:k});var c=new Ext.form.DateField({xtype:"datefield",width:100,name:i,format:"Y-m-d",value:g.add(Date.DAY,1),data:f,listeners:k});var r=function(u){if(u.checked){var v=u.inputValue;if(v=="today"){a.setValue(g);c.setValue(g.add(Date.DAY,1))}else{if(v=="yestoday"){a.setValue(b);c.setValue(b.add(Date.DAY,1))}else{if(v=="toweek"){a.setValue(q);c.setValue(p)}else{if(v=="tomonth"){a.setValue(e);c.setValue(d)}}}}}};var n=[{xtype:"radio",boxLabel:"今天",name:"dateRange",inputValue:"today",checked:true,listeners:{check:r}},{xtype:"radio",boxLabel:"昨天",name:"dateRange",inputValue:"yestoday",listeners:{check:r}},{xtype:"radio",boxLabel:"本周",name:"dateRange",inputValue:"toweek",listeners:{check:r}},{xtype:"radio",boxLabel:"本月",name:"dateRange",inputValue:"tomonth",listeners:{check:r}}];l[o++]=n[0];l[o++]=n[1];l[o++]=n[2];l[o++]=n[3];l[o++]=a;l[o++]={xtype:"tbtext",text:"~"};l[o++]=c},queryWindow:function(b){var a=this;a.funid=b.nodeId;var d=new Ext.Window({title:"查询方案自定义...",layout:"border",width:750,height:450,constrainHeader:true,resizable:false,modal:true,closeAction:"close",items:[{xtype:"container",region:"west",layout:"fit",width:250,split:true,margins:"2 0 2 2"},{xtype:"container",region:"center",layout:"fit",margins:"2 2 2 0"}]});Jxstar.createPage("sys_query","gridpage",d.getComponent(0));var c={pageType:"subeditgrid",parentNodeId:"sys_query"};Jxstar.createPage("sys_qrydet","gridpage",d.getComponent(1),c);JxUtil.delay(1000,function(){var f=d.getComponent(0).getComponent(0);var g=d.getComponent(1).getComponent(0);f.on("rowclick",function(j,l,k){var h=j.getStore().getAt(l);if(h==null){return false}var i=h.get("sys_query__query_id");Jxstar.loadSubData(g,i)});f.getStore().on("load",function(h){if(f.selectKeyId==null||f.selectKeyId.length==0){f.getSelectionModel().selectFirstRow();f.fireEvent("rowclick",f,0)}});var e={where_sql:"fun_id = ? and (is_share = '1' or user_id = ?)",where_value:a.funid+";"+JxDefault.getUserId(),where_type:"string;string"};Jxstar.loadData(f,e);f.qryFunId=a.funid;g.qryFunId=a.funid});d.show();return d}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxGroupExt={};(function(){Ext.apply(JxGroupExt,{initStas:[["0","--统计方案--"],["1","--自定义..."]],funId:"",charFields:[],numFields:[],charLists:null,numLists:null,selStatId:"",statGrid:null,statCombo:null,showCaseInQuery:function(a,g){var b=this;var e=g.fbar;b.initStas=[["0","--统计方案--"]];var c=b.initStas;var d=JxUtil.newId()+"_sta";var f=Jxstar.createCombo(d,c,100);e.add(f);f.on("beforeselect",function(i,h){var k=h.get("value");var j=i.getValue();if(k!=j&&k=="1"){b.caseWin(a)}else{if(k!=j&&k!="0"){b.exeStat(a,k)}}});f.on("select",function(i,h){i.setValue("0")});b.loadStaCase(a,f)},showCase:function(b){var a=this,c=b.page;var g=c.getTopToolbar();var d=a.initStas;var e=JxUtil.newId()+"_sta";var f=Jxstar.createCombo(e,d,100);g.add(f);f.on("beforeselect",function(i,h){var k=h.get("value");var j=i.getValue();if(k!=j&&k=="1"){a.caseWin(b)}else{if(k!=j&&k!="0"){a.exeStat(b,k)}}});f.on("select",function(i,h){i.setValue("0")});a.loadStaCase(b,f)},init:function(r){this.funId=r.nodeId;this.charFields=[];this.numFields=[];var s=[],k=r.param.cols;var p=0,m=0;for(var e=0,a=k.length;e<a;e++){var q=k[e].col,j=k[e].field;if(q==null||j==null){continue}var o=j.name,g=o.length;if(q&&j&&(o.substring(g-2)!="id")){var f=q.header;if(f.charAt(0)=="*"){f=f.substr(1)}var d=[j.name,f];var l=j.type;if(l=="int"||l=="float"){this.numFields[p++]=d}else{this.charFields[m++]=d}}}this.numFields[p]=["recordnum","记录数"]},charFieldCt:function(){var a=this;a.charLists=new JxLists({leftData:a.charFields,leftHeader:"可选分组列",rightHeader:"已选分组列"});return a.charLists.render()},numFieldCt:function(){var a=this;a.numLists=new JxLists({leftData:a.numFields,leftHeader:"可选统计列",rightHeader:"已选统计列"});return a.numLists.render()},saveCase:function(){var a=this;var d=a.charLists.getSelectStore();if(d.getCount()==0){JxHint.alert(jx.group.nofield);return}var b=a.numLists.getSelectStore();if(b.getCount()==0){JxHint.alert(jx.group.nofield);return}var c=function(m){var k=encodeURIComponent;var h="",i="",j="",f="";d.each(function(e){h+=e.get("value")+",";i+=e.get("text")+","});h=h.substr(0,h.length-1);i=i.substr(0,i.length-1);b.each(function(e){j+=e.get("value")+",";f+=e.get("text")+","});j=j.substr(0,j.length-1);f=f.substr(0,f.length-1);var g=function(n){a.statGrid.selectKeyId=n.keyid;var e=a.statGrid.getStore();e.reload()};var l="funid=sys_stat&statfunid="+a.funid+"&pagetype=grid&eventcode=savecase";l+="&keyid="+a.selStatId+"&statname="+k(m)+"&chars="+k(h);l+="&chartitles="+k(i)+"&nums="+j+"&numtitles="+k(f);Request.dataRequest(l,g)};if(a.selStatId.length==0){Ext.MessageBox.prompt(jx.base.hint,"请输入统计方案的名称",function(e,f){if(e!="ok"){return}if(f.length==0){JxHint.alert("必须填写统计方案名称");return}c(f)},a,null,"统计方案1")}else{c("")}},exeStat:function(a,b){if(!b){b=this.selStatId}if(Ext.isEmpty(b)){JxHint.alert("当前统计方案没有保存，不能执行！");return}if(!window.JxGroupPage){JxUtil.loadJS("/public/layout/ux/group_page.js",true)}var c=JxGroupPage.createPage(b,a);var d=new Ext.Window({title:"统计方案",layout:"fit",width:800,height:600,constrainHeader:true,resizable:true,modal:true,closeAction:"close",defaults:{margins:"5 2 5 2"},items:[c]});d.show()},loadStaCase:function(g,b){var h=this;var e=g.nodeId;h.statCombo=b;b.setValue("0");var f=function(l){var k=l.root;var j=[];j=j.concat(h.initStas);Ext.each(k,function(m){j[j.length]=[m.sys_stat__stat_id,m.sys_stat__stat_name]});b.getStore().loadData(j)};var i="fun_id = ? and (is_share = ? or user_id = ?)";var d=e+";1;"+JxDefault.getUserId();var a="string;string;string";var c="eventcode=query_data&funid=queryevent&pagetype=grid";c+="&query_funid=sys_stat&where_sql="+i+"&where_value="+d;c+="&where_type="+a;Request.dataRequest(c,f)},caseWin:function(h){var i=this;i.funid=h.nodeId;i.init(h);var f=i.charFieldCt();var c=i.numFieldCt();var d=new Ext.Panel({layout:"border",tbar:[{text:"新建",iconCls:"eb_create",handler:i.createCase.createDelegate(i)},{text:"保存",iconCls:"eb_save",handler:i.saveCase.createDelegate(i)},{text:"统计",iconCls:"eb_sum",handler:i.exeStat.createDelegate(i,[h])}],items:[{xtype:"container",region:"north",layout:"fit",height:250,items:[f]},{xtype:"container",region:"center",layout:"fit",style:"border-top:1px solid #99bbe8;",items:[c]}]});var g=new Ext.Window({title:"统计方案自定义...",layout:"border",width:620,height:500,constrainHeader:true,resizable:false,modal:true,closeAction:"close",items:[{xtype:"container",region:"west",layout:"fit",width:210,split:true,margins:"2 0 2 2"},{xtype:"container",region:"center",layout:"fit",margins:"2 2 2 0",items:[d]}]});Jxstar.createPage("sys_stat","gridpage",g.getComponent(0));var a=function(k){i.statGrid=k;k.on("rowclick",function(o,q,p){var l=o.getStore().getAt(q);if(l==null){return false}var m=l.get("sys_stat__stat_id");i.clickCase(m)});k.getStore().on("load",function(l){if(k.selectKeyId==null||k.selectKeyId.length==0){k.getSelectionModel().selectFirstRow();k.fireEvent("rowclick",k,0)}});k.gridNode.event.on("afterdelete",function(){i.createCase();k.selectKeyId=""});var j={where_sql:"fun_id = ? and (is_share = '1' or user_id = ?)",where_value:i.funid+";"+JxDefault.getUserId(),where_type:"string;string"};Jxstar.loadData(k,j)};var b=0;var e=function(){if(b++>6){return}JxUtil.delay(500,function(){var j=g.getComponent(0).getComponent(0);if(j){a(j);return}else{e()}})};e();g.on("destroy",function(){i.loadStaCase(h,i.statCombo);if(i.statGrid!=null){i.statGrid.destroy()}i.funId="";i.charFields=null;i.numFields=null;i.charLists=null;i.numLists=null;i.selStatId="";i.statGrid=null});g.show();return g},createCase:function(){var e=this;var b=e.charLists,a=e.numLists;e.selStatId="";var d=b.lsRight.getStore();var c=d.getRange(0,d.getCount());b.lsLeft.getStore().add(c);d.removeAll();d=a.lsRight.getStore();c=d.getRange(0,d.getCount());a.lsLeft.getStore().add(c);d.removeAll()},clickCase:function(c){var b=this;b.createCase();b.selStatId=c;var a=function(j){var h=j.chars;var k=j.nums;var f=b.charLists,e=b.numLists;for(var g=0,l=h.length;g<l;g++){b.leftToRight(h[g].colcode,f.lsLeft,f.lsRight)}for(var g=0,l=k.length;g<l;g++){b.leftToRight(k[g].colcode,e.lsLeft,e.lsRight)}};var d="funid=sys_stat&pagetype=grid&eventcode=selcase&keyid="+c;Request.dataRequest(d,a)},leftToRight:function(e,f,d){var a=f.getStore(),b=d.getStore();var c=a.find("value",e);if(c>-1){var g=a.getAt(c);b.add(g);a.removeAt(c)}}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletFun={};(function(){Ext.apply(PortletFun,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},setFun:function(){var d="plet_fun.owner_user_id = ?";var a="string";var b=Jxstar.session.user_id;var c=function(f){JxUtil.delay(500,function(){if(!f.isXType("grid")){f=f.getComponent(1).getComponent(0)}f.fkFunId="sys_user";f.fkValue=b;Jxstar.loadData(f,{where_sql:d,where_value:b,where_type:a})})};var e=Jxstar.findNode("plet_fun");Jxstar.showData({filename:e.gridpage,title:e.nodetitle,pagetype:"editgrid",nodedefine:e,callback:c})},showPortlet:function(e){var b=this;if(e==null){JxHint.alert(jx.plet.noparent);return}var c=e.getTool("gear");if(!c){var c={id:"gear",qtip:"设置个人常用功能",handler:function(i,h,g){b.setFun()}};e.addTool(c)}b.ownerCt=e;e.removeAll(e.getComponent(0),true);var d=function(h){var g=b.createPortlet(h);e.add({html:g,border:false,autoScroll:true});e.doLayout()};var a=e.initialConfig.pletid;var f="funid=queryevent&eventcode=query_pletfun&portletid="+a;Request.dataRequest(f,d)},createPortlet:function(g){if(g.length==0){return'<div class="nav_msg_notip">'+jx.plet.nofun+"</div>"}var d=new Ext.Template('<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="nav_msg_table">',"{rows}","</table>");var f=new Ext.Template('<tr height="20" style="background-color:{bgcolor};"><td>','<li><a href="#" {chgcolor} onclick="Jxstar.createNode(\'{funid}\');">{funname}</a>',"</td><tr>");var c=0,e=[];var a=g.length;for(var b=0;b<a;b++){if(Jxstar.validNode(g[b].funid)==false){continue}g[b].bgcolor=(c%2==1)?"#ddffdd":"";g[b].chgcolor="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#0080FF';\"";e[b]=f.apply(g[b]);c++}return d.apply({rows:e.join("")})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletMsg={};(function(){Ext.apply(PortletMsg,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},showPortlet:function(b){if(b==null){JxHint.alert(jx.plet.noparent);return}this.ownerCt=b;b.removeAll(b.getComponent(0),true);var a=function(f){var f=f.root;var e="";if(f.length==0){e='<div class="nav_msg_notip">'+jx.plet.nomsg+"</div>"}else{e=PortletMsg.createPortlet(f)}var d=PortletMsg.createHtml(e,f.length);b.add({html:d,autoScroll:true});b.doLayout()};var c="funid=get_msg&eventcode=newmsg";Request.dataRequest(c,a)},createHtml:function(c,g){var d="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#444';\"";var b='<a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletMsg.sendMsg();">'+jx.plet.sendmsg+'</a><a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletMsg.queryGetMsg();">'+jx.plet.getbar+'</a><a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletMsg.querySendMsg();">'+jx.plet.sendbar+'</a><a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletMsg.queryReadBoard();">'+jx.plet.hisboard+"</a>";var e="";if(g>0){e="<td>"+String.format(jx.plet.sumnum,g)+"</td>"}var f='<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" style="bottom:4px;" class="nav_msg_table"><tr>'+e+'<td style="text-align:right;">'+b+"</td></tr></table>";var a='<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0"><tr height="90%" style="vertical-align:top;"><td>'+c+'</td></tr><tr height="10%" style="vertical-align:bottom;background-color:#deecfd;"><td>'+f+"</td></tr></table>";return a},createPortlet:function(j){var h=new Ext.Template('<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="nav_msg_table">',"{rows}","</table>");var m=new Ext.Template('<tr height="20" style="background-color:{bgcolor};">','<td width="20" style="padding-left:4px;"><div class="{msgicon}" title="{msghint}">&nbsp;</div></td>','<td><a href="#" {chgcolor} onclick="{readFn};">{msgtitle}</a></td>',"<tr>");var n=[];for(var f=0;f<j.length;f++){var l={},e=j[f];var b=e.msg_id,d=e.content,k=jx.plet.manmsg,g="PortletMsg.readMsg('"+b+"');",c=e.msg_type;if(c=="gg"){var a=JxDefault.getDeptId();if(e.dept_id.length>0&&a.indexOf(e.dept_id)!=0){continue}d=e.msg_title;k=jx.plet.ggmsg;g="PortletMsg.readBoard('"+b+"');"}if(c=="sys"){k=jx.plet.sysmsg}l.readFn=g;l.msghint=k;l.msgicon="msg_"+c;l.msgtitle=Ext.util.Format.ellipsis(d,30);l.bgcolor=(f%2==1)?"#ddffdd":"";l.chgcolor="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#0080FF';\"";n[f]=m.apply(l);l=null}return h.apply({rows:n.join("")})},readMsg:function(b){var a=this;var c=function(e){var d={where_sql:"plet_msg.msg_id = ?",where_type:"string",where_value:b,callback:function(g){if(g.length==0){JxHint.alert(jx.plet.notmsg)}else{var f=e.formNode.event.newRecord(g[0]);e.getForm().myRecord=f;e.getForm().loadRecord(f)}}};Jxstar.queryData("get_msg",d);e.on("destroy",function(){var f=function(){a.showPortlet(a.ownerCt)};var g="funid=get_msg&keyid="+b+"&pagetype=form&eventcode=read";Request.postRequest(g,f)})};Jxstar.showData({filename:"/jxstar/system/form_get_msg.js",pagetype:"form",title:jx.plet.readmsg,callback:c})},readBoard:function(b){var a=this;var c=function(e){var d={where_sql:"plet_msg.msg_id = ?",where_type:"string",where_value:b,callback:function(g){if(g.length==0){JxHint.alert(jx.plet.notboard)}else{var f=e.formNode.event.newRecord(g[0]);e.getForm().myRecord=f;e.getForm().loadRecord(f)}}};Jxstar.queryData("send_board",d);e.on("destroy",function(){var f=function(){a.showPortlet(a.ownerCt)};var g="funid=send_board&keyid="+b+"&pagetype=readform&eventcode=read";Request.postRequest(g,f)})};Jxstar.showData({filename:"/jxstar/system/form_send_board.js",pagetype:"readform",title:jx.plet.readboard,callback:c})},sendMsg:function(){var a=function(b){b.formNode.event.create()};Jxstar.showData({filename:"/jxstar/system/form_send_msg.js",pagetype:"sendform",title:jx.plet.sendmsg,callback:a})},querySendMsg:function(){var d="plet_msg.from_userid = ?";var a="string";var b=JxDefault.getUserId();var c=function(e){JxUtil.delay(500,function(){Jxstar.loadData(e,{where_sql:d,where_value:b,where_type:a})})};Jxstar.showData({filename:"/jxstar/system/grid_send_msg.js",pagetype:"sendgrid",title:jx.plet.sendbar,callback:c})},queryGetMsg:function(d){var f="plet_msg.to_userid = ?";var b="string";var c=JxDefault.getUserId();if(d!=null&&d.length>0){f+=" and plet_msg.msg_state = ?";b+=";string";c+=";1"}var a=this;var e=function(g){JxUtil.delay(500,function(){Jxstar.loadData(g,{where_sql:f,where_value:c,where_type:b})});g.on("destroy",function(){a.showPortlet(a.ownerCt)})};Jxstar.showData({filename:"/jxstar/system/grid_get_msg.js",pagetype:"grid",title:jx.plet.getbar,callback:e})},queryReadBoard:function(){var e="plet_read.user_id = ?";var b="string";var c=JxDefault.getUserId();var a=this;var d=function(f){JxUtil.delay(500,function(){f=f.getComponent(0).getComponent(0);Jxstar.loadData(f,{where_sql:e,where_value:c,where_type:b})})};Jxstar.showData({filename:"/public/layout/layout_main.js",pagetype:"grid",title:jx.plet.hisboard,nodedefine:Jxstar.findNode("get_board"),callback:d})}});Ext.TaskMgr.start({run:function(){PortletMsg.refresh()},interval:1000*60*5})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletWarn={};(function(){Ext.apply(PortletWarn,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},showPortlet:function(b){if(b==null){JxHint.alert(jx.plet.noparent);return}this.ownerCt=b;b.removeAll(b.getComponent(0),true);var a=function(e){e=e.root;var d="";if(e.length==0){d='<div class="nav_msg_notip">'+jx.plet.nowarn+"</div>"}else{d=PortletWarn.createPortlet(e)}b.add({html:d,autoScroll:true});b.doLayout()};var c="funid=sys_warn&eventcode=cntwarn";Request.dataRequest(c,a)},createPortlet:function(a){var f=new Ext.Template('<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="nav_msg_table">',"{rows}","</table>");var h=new Ext.Template('<tr height="20" style="background-color:{bgcolor};"><td>','<li><a href="#" {chgcolor} onclick="{readFn}">{warntitle}</a>',"</td><tr>");var b=function(i){if(i==null||i.length==0){return""}i=encodeURIComponent(i);i=i.replace(/'/g,"\\'");return i};var k=[];var e=a.length;for(var d=0;d<e;d++){var j={};j.readFn="PortletWarn.showWarnData('"+a[d].fun_id+"', '"+b(a[d].whereSql)+"');";var c=a[d].warn_num;var g=a[d].warn_name;j.warntitle=g+"["+c+"]";j.bgcolor=(d%2==1)?"#ddffdd":"";j.chgcolor="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#0080FF';\"";k[d]=h.apply(j);j=null}return f.apply({rows:k.join("")})},showWarnData:function(c,a){var d=Jxstar.findNode(c);if(d==null){JxHint.alert(String.format(jx.star.nopage,c));return false}var b={whereSql:decodeURIComponent(a)};Jxstar.createNode(c,b)}});Ext.TaskMgr.start({run:function(){PortletWarn.refresh()},interval:1000*60*5})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletBoard={};(function(){Ext.apply(PortletBoard,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},showPortlet:function(c){var a=this;if(c==null){JxHint.alert(jx.plet.noparent);return}a.ownerCt=c;c.removeAll(c.getComponent(0),true);var b={where_sql:"plet_msg.msg_state = ? and plet_msg.send_date <= ?",where_type:"string;date",where_value:"1;"+JxUtil.getNextDate(JxUtil.getToday(),30),callback:function(f){var e="";if(f.length==0){e='<div class="nav_msg_notip">'+jx.plet.noboard+"</div>"}else{e=a.createPortlet(f)}var d=a.createHtml(e,f.length);c.add({html:d,autoScroll:true});c.doLayout()}};Jxstar.queryData("send_board",b)},createHtml:function(c){var d="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#444';\"";var b='<a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletBoard.queryBoard();">'+jx.plet.all+"</a>";var e='<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" style="bottom:4px;" class="nav_msg_table"><tr><td style="text-align:right;">'+b+"</td></tr></table>";var a='<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0"><tr height="90%" style="vertical-align:top;"><td>'+c+'</td></tr><tr height="10%" style="vertical-align:bottom;background-color:#deecfd;"><td>'+e+"</td></tr></table>";return a},createPortlet:function(a){var e=new Ext.Template('<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="nav_msg_table">',"{rows}","</table>");var g=new Ext.Template('<tr height="20" style="background-color:{bgcolor};"><td>','<li><a href="#" {chgcolor} onclick="PortletBoard.readBoard(\'{msgid}\');">{msgtitle}</a>',"</td><tr>");var f=[];for(var c=0;c<a.length;c++){var b={};b.msgid=a[c].plet_msg__msg_id;var d=a[c].plet_msg__msg_title;b.msgtitle=Ext.util.Format.ellipsis(d,40);b.bgcolor=(c%2==1)?"#ddffdd":"";b.chgcolor="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#0080FF';\"";f[c]=g.apply(b)}return e.apply({rows:f.join("")})},readBoard:function(b){var a=this;var c=function(e){var d={where_sql:"plet_msg.msg_id = ?",where_type:"string",where_value:b,callback:function(g){if(g.length==0){JxHint.alert(jx.plet.notboard)}else{var f=e.formNode.event.newRecord(g[0]);e.getForm().myRecord=f;e.getForm().loadRecord(f)}}};Jxstar.queryData("send_board",d)};Jxstar.showData({filename:"/jxstar/system/form_send_board.js",pagetype:"readform",title:jx.plet.readboard,callback:c})},queryBoard:function(){var d="plet_msg.msg_state = ?";var a="string";var b="1";var c=function(e){JxUtil.delay(500,function(){Jxstar.loadData(e,{where_sql:d,where_value:b,where_type:a})})};Jxstar.showData({filename:"/jxstar/system/grid_send_board.js",pagetype:"readgrid",title:jx.plet.allboard,callback:c})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletResult={};(function(){Ext.apply(PortletResult,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},showPortlet:function(c){var a=this;if(c==null){JxHint.alert(jx.plet.noparent);return}this.ownerCt=c;c.removeAll(c.getComponent(0),true);var e=c.initialConfig.objectid;var b=function(h){var i=h.charttype;var j=h.chartdata;var g=new Ext.data.SimpleStore({fields:["text","value"],data:j});var f=JxGroup.createChartImage(g,"text","value",i);c.add(f);c.doLayout()};var d="funid=queryevent&eventcode=query_pletres&chart_id="+e;Request.dataRequest(d,b)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletResultG={};(function(){Ext.apply(PortletResultG,{ownerCt:null,refresh:function(){if(this.ownerCt){var a=this.ownerCt.getComponent(0);Jxstar.reload(a)}},showPortlet:function(c){var a=this;if(c==null){JxHint.alert(jx.plet.noparent);return}this.ownerCt=c;c.removeAll(c.getComponent(0),true);var b=c.initialConfig.objectid;var d={pageType:"notoolgrid"};Jxstar.createPage(b,"gridpage",c,d)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletAssign={};(function(){Ext.apply(PortletAssign,{ownerCt:null,refresh:function(){if(this.ownerCt){var d=this.ownerCt.getComponent(0);var c="run_state = ? and assign_userid = ?";var a="0;"+JxDefault.getUserId();var b="string;string";Jxstar.loadData(d,{where_sql:c,where_value:a,where_type:b})}},showPortlet:function(c){var a=this;if(c==null){JxHint.alert(jx.plet.noparent);return}this.ownerCt=c;c.removeAll(c.getComponent(0),true);var b=function(i){var h=i();if(typeof h.showPage=="function"){h=h.showPage("notoolgrid")}c.add(h);c.doLayout();var g="run_state = ? and assign_userid = ?";var d="0;"+JxDefault.getUserId();var e="string;string";Jxstar.loadData(h,{where_sql:g,where_value:d,where_type:e})};Request.loadJS("/jxstar/studio/grid_wfassign.js",b)}});Ext.TaskMgr.start({run:function(){PortletAssign.refresh()},interval:1000*60*5})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletIcon={};(function(){Ext.apply(PortletIcon,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},setFun:function(){var d="plet_fun.owner_user_id = ?";var a="string";var b=Jxstar.session.user_id;var c=function(f){JxUtil.delay(500,function(){if(!f.isXType("grid")){f=f.getComponent(1).getComponent(0)}f.fkFunId="sys_user";f.fkValue=b;Jxstar.loadData(f,{where_sql:d,where_value:b,where_type:a})})};var e=Jxstar.findNode("plet_fun");Jxstar.showData({filename:e.gridpage,title:e.nodetitle,pagetype:"editgrid",nodedefine:e,callback:c})},showPortlet:function(f){var d=this;if(f==null){JxHint.alert(jx.plet.noparent);return}var e=f.getTool("gear");if(!e){var e={id:"gear",qtip:"设置个人常用功能",handler:function(i,h,g){d.setFun()}};f.addTool(e)}d.ownerCt=f;var b=f.getComponent(0);if(b){var c=b.getStore();c.reload()}else{var a=f.initialConfig.pletid;var b=d.createPortlet(a);f.add(b);f.doLayout()}},createPortlet:function(e){var d=Jxstar.path+"/commonAction.do?funid=queryevent&eventcode=query_pletfun&portletid="+e+"&user_id="+Jxstar.session.user_id;var b=new Ext.data.JsonStore({url:d,root:"data",fields:["funid","funname","funicon"]});b.load();var c=new Ext.XTemplate("<ul>",'<tpl for=".">','<li class="phone">','<img src="./resources/images/fun/{funicon}.png" />',"<span>{funname}</span>","</li>","</tpl>","</ul>");c.compile();var a=new Ext.DataView({cls:"fun-icon",store:b,tpl:c,singleSelect:true,autoHeight:true,autoScroll:true,itemSelector:"li.phone",overClass:"phone-hover",listeners:{click:function(g,f){var i=g.getStore().getAt(f);var h=i.get("funid");Jxstar.createNode(h)},containerclick:function(f){f.clearSelections()}}});return a}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
PortletNews={};(function(){Ext.apply(PortletNews,{ownerCt:null,refresh:function(){if(this.ownerCt){this.showPortlet(this.ownerCt)}},showPortlet:function(c){var a=this;if(c==null){JxHint.alert(jx.plet.noparent);return}a.ownerCt=c;c.removeAll(c.getComponent(0),true);var b=function(g){var f="";if(g.length==0){f='<div class="nav_msg_notip">没有新闻公告！</div>'}else{f=a.createPortlet(g)}var e=a.createHtml(f,g.length);c.add({html:e,autoScroll:true});c.doLayout()};var d="funid=sys_news&eventcode=qrycont&pagetype=grid&premonth=1";Request.dataRequest(d,b)},createHtml:function(c){var d="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#444';\"";var b='<a href="#" '+d+' style="padding-right:8px;color:#444" onclick="PortletNews.queryBoard();">'+jx.plet.all+"</a>";var e='<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" style="bottom:4px;" class="nav_msg_table"><tr><td style="text-align:right;">'+b+"</td></tr></table>";var a='<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0"><tr height="90%" style="vertical-align:top;"><td>'+c+'</td></tr><tr height="10%" style="vertical-align:bottom;background-color:#deecfd;"><td>'+e+"</td></tr></table>";return a},createPortlet:function(a){var e=new Ext.Template('<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="nav_msg_table">',"{rows}","</table>");var g=new Ext.Template('<tr height="20" style="background-color:{bgcolor};"><td>','<li><a href="#" {chgcolor} onclick="PortletNews.readBoard(\'{msgid}\');">{msgtitle}</a>',"</td><tr>");var f=[];for(var c=0;c<a.length;c++){var b={};b.msgid=a[c].news_id;var d=a[c].news_title;b.msgtitle=Ext.util.Format.ellipsis(d,40);b.bgcolor=(c%2==1)?"#ddffdd":"";b.chgcolor="onmouseover=\"this.style.color='#FF4400';\" onmouseout=\"this.style.color='#0080FF';\"";f[c]=g.apply(b)}return e.apply({rows:f.join("")})},readBoard:function(a){var b=this;var c=function(k){var o=new Ext.Toolbar({deferHeight:true,items:[{iconCls:"eb_return",text:"回复",handler:function(){b.replyBoard(a,l)}},{iconCls:"eb_refresh",text:"刷新",handler:function(){b.refreshCont(a,l)}}]});var g=b.contHtml(k.cont);var h=k.reply;for(var f=0,m=h.length;f<m;f++){g+=b.replyHtml(f+1,h[f])}var j=new Ext.Panel({tbar:o,html:g,autoScroll:true});var l=new Ext.Window({title:"阅读新闻公告",layout:"fit",width:750,height:500,constrainHeader:true,resizable:true,border:false,modal:true,closeAction:"close",autoScroll:true,style:"padding: 5px;",items:[j]});l.show();b.addDelete(j)};var d=function(f){if(Ext.isEmpty(f)){JxHint.alert(jx.plet.notboard)}else{c(f)}};var e="funid=sys_news_reply&eventcode=fqury&pagetype=form&newsId="+a;Request.dataRequest(e,d)},contHtml:function(a){var b=new Ext.Template('<div flag="0" itemid="{news_id}">','<p style="margin:8px;background-color:#f0f0f0;padding:5px;">',"<span>发布者：{edit_user}&nbsp;&nbsp;{edit_date}</span>","</p>",'<p style="margin:8px;font-size:14px;font-weight:bold;">{news_title}</p>','<div style="margin:8px;">{news_cont}</div>',"</div>");return b.apply(a)},replyHtml:function(b,a){var d="";if(JxUtil.isAdminUser()){d='&nbsp;&nbsp;<a href="#" class="delete" itemid="{reply_id}" parentid="{news_id}">删除</a>'}var c=new Ext.Template('<div flag="1" itemid="{reply_id}">','<p style="margin:8px;background-color:#f0f0f0;padding:5px;">',"<span>楼{index}: {edit_user}&nbsp;&nbsp;{edit_date}"+d+"</span>","</p>",'<div style="margin:8px;">{reply_cont}</div>',"</div>");a.index=b;return c.apply(a)},replyBoard:function(b,a){var c=this;var e=Math.round(Math.random()*100);var d=e+(new Date()).getTime();var f=new Ext.form.FormPanel({layout:"fit",border:false,items:[{xtype:"imghtmleditor",name:"sys_news_reply__reply_cont",allowBlank:false,anchor:"100%",maxLength:20000},{xtype:"hidden",name:"sys_news_reply__reply_id",value:d},]});f.formNode={define:Jxstar.findNode("sys_news_reply")};var g=new Ext.Window({title:"回复新闻公告",layout:"fit",width:650,height:400,modal:true,border:false,closeAction:"close",style:"padding: 5px;",items:[f],buttons:[{text:jx.base.ok,handler:function(){var i=f.getForm().get("sys_news_reply__reply_cont");i=encodeURIComponent(i);var j="funid=sys_news_reply&keyid="+d+"&pagetype=form&eventcode=fsave";j+="&news_id="+b+"&reply_cont="+i;var h=function(k){c.refreshCont(b,a);g.close()};Request.postRequest(j,h)}},{text:jx.base.cancel,handler:function(){g.close()}}]});g.show()},refreshCont:function(b,a){var c=this;var d=function(k){if(Ext.isEmpty(k)){JxHint.alert(jx.plet.notboard)}else{var j=a.getComponent(0);j.removeAll();var g=c.contHtml(k.cont);var h=k.reply;for(var f=0,l=h.length;f<l;f++){g+=c.replyHtml(f+1,h[f])}j.update(g);c.addDelete(j)}};var e="funid=sys_news_reply&eventcode=fqury&pagetype=form&newsId="+b;Request.dataRequest(e,d)},addDelete:function(b){if(!JxUtil.isAdminUser()){return}var a=this;var d=function(e,f){var h="funid=sys_news_reply&replyId="+e+"&pagetype=form&eventcode=fdelete";var g=function(i){a.refreshCont(f,b.ownerCt)};Request.postRequest(h,g)};var c=b.body.select("a.delete");c.on("click",function(j,f){var g=Ext.get(f);var h=g.getAttribute("itemid");var i=g.getAttribute("parentid");d(h,i)})},queryBoard:function(){var a=Jxstar.session.user_id;var e="f_isnews(news_id, ?) = ? and sys_news.state = ?";var b="string;string;string";var c=a+";1;1";var d=function(f){JxUtil.delay(500,function(){Jxstar.loadData(f,{where_sql:e,where_value:c,where_type:b})})};Jxstar.showData({filename:"/jxstar/system/grid_sys_news.js",pagetype:"readgrid",title:jx.plet.allboard,callback:d})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxMenu={};(function(){Ext.apply(JxMenu,{createMainMenu:function(a){var b=function(d){var f=JxMenu.createMenumItems(d);f[0]={baseCls:"x-plain",cls:"btn-panel",xtype:"panel",html:"<div>&nbsp;</div>",columnWidth:1};var e=new Ext.Panel({layout:"column",defaultType:"button",defaults:{style:"margin-right:1px;"},baseCls:"x-plain",cls:"btn-panel",renderTo:a,items:f});Jxstar.topMenu=e};var c="funid=queryevent&eventcode=query_menu";Request.dataRequest(c,b)},createMenumItems:function(a){var d=[],f=1;d[0]={};for(var o=0;o<a.length;o++){var l=a[o];l.text=JxLang.moduleText(l.id,l.text);var e=new Ext.menu.Menu();for(var n=0;n<l.children.length;n++){var b=l.children[n];b.text=JxLang.moduleText(b.id,b.text);var c=new Ext.menu.Menu();for(var h=0;h<b.children.length;h++){var p=b.children[h];p.text=JxLang.funText(p.id,p.text);c.add({id:"menu_"+p.id,text:p.text});Jxstar.rightNodes.push(p.id)}c.on("itemclick",function(i,k){var j=i.id.substr(5);Jxstar.createNode(j)});e.add({id:"menu_"+b.id,text:b.text,menu:c})}e.on("itemclick",function(i,j){return false});d[f++]={id:"menu_"+l.id,text:l.text,baseCls:"x-plain",menu:e}}var g=[{id:"menu_modify_pwd",text:"修改密码",baseCls:"x-plain",handler:function(){var i=JxDefault.getUserId();JxUtil.setPass(i)}}];g[1]={id:"menu_show_online",text:"在线用户",handler:JxUtil.onLineUser};d[f]={id:"menu_sys_other",text:"其它",iconCls:"eb_online",leaf:false,menu:g};d[f+1]={id:"menu_logout",text:"退出",baseCls:"x-plain",iconCls:"eb_logout",handler:JxUtil.logout};return d},showProxy:function(){var c=Jxstar.session.proxy_id;if(c){JxMenu.showOutProxy();return}var e=function(){var g=function(l){var j=Jxstar.session.user_id;var i=(new Date()).add(Date.DAY,-1).format("Y-m-d");var k={where_sql:"auditing=1 and user_id = ? and end_date > ?",where_type:"string;date",where_value:j+";"+i};Jxstar.loadData(l,k)};var h=Jxstar.findNode("sys_proxy_sel");Jxstar.showData({filename:h.gridpage,title:h.nodetitle,pagetype:"selgrid",width:600,height:300,callback:g})};var d=function(n){if(n.total==0){return}var m=Jxstar.systemVar.index__menu__pos;if(m&&m=="top"){var l=function(){if(Jxstar.topMenu){var o=Jxstar.topMenu.getComponent("menu_sys_other");o.menu.add({id:"menu_in_proxy",iconCls:"top_btn_proxy",text:"代理工作",handler:e})}else{JxUtil.delay(500,l)}};l()}else{var h=Jxstar.viewport.getComponent(0);var g=h.getEl().query("#top_btn_td");var i='onmouseover="this.style.color=\'#ff9900\';" onmouseout="this.style.color=\'#ffffff\';" class="top-menu-text"';if(g.length>0){var k='<span><span class="top-menu-img top_btn_proxy"></span><a href="#" '+i+" >代理工作</a></span>";var j=Ext.get(g[0]).insertHtml("afterBegin",k,true);j.on("click",e)}}};var b=Jxstar.session.user_id;var a=(new Date()).add(Date.DAY,-1).format("Y-m-d");var f="eventcode=query_data&funid=queryevent&pagetype=grid&query_funid=sys_proxy&where_sql=auditing=1 and user_id = ? and end_date > ?&where_type=string;date&where_value="+b+";"+a;Request.dataRequest(f,d)},showOutProxy:function(){var g=Jxstar.session.proxy_id;var d=Jxstar.session.user_id;var c=Jxstar.session.proxy_user_id;var j=function(){JxMenu.loginProxy(d,c,"0",g)};var k=Jxstar.systemVar.index__menu__pos;if(k&&k=="top"){var i=function(){if(Jxstar.topMenu){var l=Jxstar.topMenu.getComponent("menu_sys_other");l.menu.add({id:"menu_out_proxy",iconCls:"eb_audit_back",text:"退出代理",handler:j})}else{JxUtil.delay(500,i)}};i()}else{var h=Jxstar.viewport.getComponent(0);var a=h.getEl().query("#top_btn_td");var f='onmouseover="this.style.color=\'#ff9900\';" onmouseout="this.style.color=\'#ffffff\';" class="top-menu-text"';if(a.length>0&&g){var e='<span><span class="top-menu-img eb_audit_back"></span><a href="#" '+f+" >退出代理</a></span>";var b=Ext.get(a[0]).insertHtml("afterBegin",e,true);b.on("click",j)}}},loginProxy:function(e,f,d,c){var a=Jxstar.path+"/public/core/workproxy.jsp?proxy_in="+d+"&to_userid="+e+"&proxy_userid="+f;if(c){a+="&proxy_id="+c}var b=function(g){if(Jxstar.topMenu){Jxstar.topMenu.destroy();Jxstar.topMenu=null}Jxstar.viewport.destroy();Jxstar.viewport=null;g.maxInterval=Jxstar.session.maxInterval;g.sessionId=Jxstar.session.sessionId;Jxstar.session=g;Request.loadJS("/public/core/JxBody.js")};Ext.Ajax.request({method:"POST",url:a,success:function(h){var g=Ext.decode(h.responseText);if(g.success==true||g.success=="true"){JxHint.hint("执行成功："+g.message);b(g.data)}else{var i=g.message;JxHint.alert("执行失败："+i)}},failure:function(g){JxUtil.errorResponse(g)}})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxPortal={};(function(){Ext.apply(JxPortal,{mainPortals:[],ContentTypes:{portlet_fun:PortletFun,portlet_msg:PortletMsg,portlet_warn:PortletWarn,portlet_board:PortletBoard,portlet_result:PortletResult,portlet_resultg:PortletResultG,portlet_flow:PortletAssign,portlet_icon:PortletIcon,portlet_news:PortletNews},tools:[{id:"refresh",handler:function(f,d,a){var c=a.initialConfig.typecode;var b=JxPortal.ContentTypes[c];if(b==null){JxHint.alert(String.format(jx.port.noport,c));return false}b.showPortlet(a)}}],createMainPortal:function(b){Ext.TaskMgr.stopAll();var a=function(q){if(q==null||q.portalnum==0){JxHint.alert(jx.port.notemp);return}var f=JxPortal.parsePortal(q);b.add(f);b.doLayout();var g=JxPortal.mainPortals.length;for(var m=0;m<g;m++){var r=JxPortal.mainPortals[m];var d=r.items.length;for(var l=0;l<d;l++){var e=r.items.itemAt(l);var p=e.items.length;for(var h=0;h<p;h++){var s=e.items.itemAt(h);var n=s.initialConfig.typecode;var o=JxPortal.ContentTypes[n];if(o==null){continue}o.showPortlet(s)}}}};var c="funid=queryevent&eventcode=query_portal";Request.dataRequest(c,a)},parsePortal:function(b){var g=parseInt(b.portalnum);if(g>1){var d=[g];for(var c=0;c<g;c++){var f=b.portals[c];var a=JxPortal.createPortal(f);d[c]={title:f.templet_name,autoScroll:true,layout:"fit",iconCls:"function",items:a};JxPortal.mainPortals[c]=a}var e=new Ext.TabPanel({id:"sys_portal_tab",region:"center",closeAction:"close",activeTab:0,items:d});return e}else{var f=b.portals[0];var a=JxPortal.createPortal(f);JxPortal.mainPortals[0]=a;return a}},createPortal:function(e){var a=e.col_num;var n=e.col_width.split(";");if(a!=n.length){var l=String.format(jx.port.colrow,a,n);JxHint.alert(l);return false}var d=[a];for(var f=0;f<a;f++){d[f]=[]}var h=e.items.length;for(var f=0;f<h;f++){var m=e.items[f];var j=parseInt(m.colno)-1;if(j>=a){JxHint.alert("【"+m.title+"】所属列大于模板总列数！");continue}var k={title:m.title,iconCls:m.iconCls,layout:"fit",autoScroll:true,tools:JxPortal.tools,height:parseInt(m.height),collapsed:(m.collapse=="1"),pletid:m.id,typecode:m.typecode,objectid:m.objectid};var g=d[j].length;d[j][g]=k}var c=[a];for(var f=0;f<a;f++){c[f]={width:n[f],style:f<(a-1)?"padding:10px 0 10px 10px":"padding:10px",items:d[f]}}var b=new Ext.ux.Portal({region:"center",border:true,margins:"5 5 5 0",items:c});return b}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Request={};(function(){if(Ext.LoadMask){Ext.LoadMask.prototype.msg=jx.req.exeing}Ext.apply(Request,{loadXML:function(data){if(data==null||data.length==0){return}var xdoc=null;if(typeof(DOMParser)=="undefined"){xdoc=new ActiveXObject("Microsoft.XMLDOM");xdoc.async="false";xdoc.loadXML(data)}else{var parser=new DOMParser();xdoc=parser.parseFromString(data,"application/xml")}return xdoc},loadJS:function(url,hdCall){if(url==null||url.length==0){JxHint.alert("Request.loadJS"+jx.req.nopath);return}if(url.charAt(0)!="/"){url="/"+url}Ext.Ajax.request({method:"GET",url:Jxstar.path+url,success:function(response){var f=eval(response.responseText);if(hdCall!=null){hdCall(f)}f=null;Jxstar.currentPage=null},failure:function(response){JxUtil.errorResponse(response)}})},loadJsp:function(url){if(url==null||url.length==0){JxHint.alert("Request.loadJsp"+jx.req.nopath);return}Ext.getBody().load({method:"GET",url:url,scripts:true})},postRequest:function(params,hdCall,options){options=options||{};options.action="event";this.asynchRequest(params,hdCall,options)},dataRequest:function(params,hdCall,options){options=options||{};options.action="query";this.asynchRequest(params,hdCall,options)},asynchRequest:function(params,hdCall,options){SessionTimer.resetTimer();var myMask=null;var useWait=options.wait||false;var dataType=options.type||"json";var action=options.action;var sync=options.sync||false;var timeout=options.timeout||60000;params+="&user_id="+Jxstar.session.user_id;params+="&dataType="+dataType;if(action=="query"){params+="&query_type="+(options.query_type||"0");params+="&has_page="+(options.has_page||"0")}useWait=useWait||(action=="event");if(useWait){myMask=new Ext.LoadMask(Ext.getBody());myMask.show()}Ext.Ajax.request({method:"POST",url:Jxstar.path+"/commonAction.do",timeout:timeout,success:function(response){var result={};if(dataType=="xml"){var xdoc=response.responseXML;var query=Ext.DomQuery;result.data=query.selectValue("data",xdoc);result.success=query.selectValue("success",xdoc);result.message=query.selectValue("message",xdoc)}else{result=Ext.decode(response.responseText)}if(result.success==true||result.success=="true"){var msg=result.message;if(action=="event"){if(msg.length==0){msg=jx.req.success}JxHint.hint(msg)}if(hdCall!=null){hdCall(result.data,result.extData)}}else{if(options&&options.errorcall){options.errorcall(result)}else{var msg=result.message;if(msg.length==0){msg=jx.req.faild}JxHint.alert(msg)}}if(useWait&&myMask){myMask.hide();myMask=null}},failure:function(response){if(useWait&&myMask){myMask.hide();myMask=null}JxUtil.errorResponse(response)},params:params})},fileUpdate:function(targetId,params,hdCall){SessionTimer.resetTimer();params=params||"";if(params.indexOf("&user_id=")<0){params+="&user_id="+Jxstar.session.user_id}if(params.indexOf("&dataType=")<0){params+="&dataType=byte"}Ext.get(targetId).load({method:"POST",url:Jxstar.path+"/fileAction.do",scripts:true,nocache:true,callback:function(el,success,response,options){if(success==true){if(hdCall!=null){hdCall(response.responseText)}}else{JxUtil.errorResponse(response)}},params:params})},fileDown:function(params){SessionTimer.resetTimer();params=params||"";if(params.indexOf("&user_id=")<0){params+="&user_id="+Jxstar.session.user_id}if(params.indexOf("&dataType=")<0){params+="&dataType=byte"}var href=Jxstar.path+"/fileAction.do?"+params;var iframe=document.getElementById("frmhidden");iframe.src=href},fileRequest:function(form,params,hdCall){SessionTimer.resetTimer();params=params||"";if(params.indexOf("&user_id=")<0){params+="&user_id="+Jxstar.session.user_id}form.fileUpload=true;form.method="POST";form.submit({url:Jxstar.path+"/fileAction.do",waitTitle:jx.req.wait,waitMsg:jx.req.uping,success:function(form,action){var result=Ext.decode(action.response.responseText);if(result.success){var msg=result.message;if(msg.length==0){msg=jx.req.success}JxHint.hint(msg);if(hdCall!=null){hdCall(result.data)}}else{if(action.response){JxUtil.errorResponse(action.response)}else{JxHint.alert(jx.req.ajaxerror)}}},failure:function(form,action){if(action.response){JxUtil.errorResponse(action.response)}else{JxHint.alert(jx.req.ajaxerror)}},params:params})},expFile:function(getParams,postParams){var fd=Ext.get("frmExpFile");if(!fd){fd=Ext.DomHelper.append(Ext.getBody(),{tag:"form",method:"post",id:"frmExpFile",name:"frmExpFile",target:"frmhidden",cls:"x-hidden",cn:[{tag:"input",name:"exp_text",id:"exp_text",type:"hidden"},{tag:"input",name:"query_type",id:"query_type",type:"hidden"},{tag:"input",name:"where_sql",id:"where_sql",type:"hidden"},{tag:"input",name:"where_value",id:"where_value",type:"hidden"},{tag:"input",name:"where_type",id:"where_type",type:"hidden"}]},true)}var pps=postParams||{};fd.child("#exp_text").set({value:pps.exp_text||""});fd.child("#query_type").set({value:pps.query_type||"0"});fd.child("#where_sql").set({value:pps.where_sql||""});fd.child("#where_value").set({value:pps.where_value||""});fd.child("#where_type").set({value:pps.where_type||""});var href=Jxstar.path+"/fileAction.do";var gps=getParams||"";if(gps.indexOf("&user_id=")<0){gps+="&user_id="+Jxstar.session.user_id}if(gps.indexOf("&dataType=")<0){gps+="&dataType=byte"}if(gps.length>0){href+="?"+encodeURI(gps)}fd.dom.action=href;fd.dom.submit()},exportCSV:function(grid,fileName,includeHidden){var content=JxUtil.gridToCSV(grid,Ext.isEmpty(includeHidden)?true:includeHidden);var fd=Ext.get("frmDummy");if(!fd){fd=Ext.DomHelper.append(Ext.getBody(),{tag:"form",method:"post",id:"frmDummy",name:"frmDummy",action:Jxstar.path+"/public/core/exportfile.jsp",target:"_blank",cls:"x-hidden",cn:[{tag:"input",name:"fileName",id:"fileName",type:"hidden"},{tag:"input",name:"exportContent",id:"exportContent",type:"hidden"}]},true)}fd.child("#fileName").set({value:fileName});fd.child("#exportContent").set({value:content});fd.dom.submit()}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
function XmlRequest(f,b,c,d,e,a){this.url=b;this.params=d;this.method=f||"POST";this.async=(c!=null)?c:true;this.username=e;this.password=a}XmlRequest.prototype.url=null;XmlRequest.prototype.params=null;XmlRequest.prototype.method=null;XmlRequest.prototype.async=null;XmlRequest.prototype.binary=false;XmlRequest.prototype.username=null;XmlRequest.prototype.password=null;XmlRequest.prototype.request=null;XmlRequest.prototype.isBinary=function(){return this.binary};XmlRequest.prototype.setBinary=function(a){this.binary=a};XmlRequest.prototype.getText=function(){return this.request.responseText};XmlRequest.prototype.isReady=function(){return this.request.readyState==4};XmlRequest.prototype.getDocumentElement=function(){var a=this.getXml();if(a!=null){return a.documentElement}return null};XmlRequest.prototype.getXml=function(){var a=this.request.responseXML;if(a==null||a.documentElement==null){a=mxUtils.parseXml(this.request.responseText)}return a};XmlRequest.prototype.getText=function(){return this.request.responseText};XmlRequest.prototype.getStatus=function(){return this.request.status};XmlRequest.prototype.create=function(){if(window.XMLHttpRequest){return function(){var a=new XMLHttpRequest();if(this.isBinary()&&a.overrideMimeType){a.overrideMimeType("text/plain; charset=x-user-defined")}return a}}else{if(typeof(ActiveXObject)!="undefined"){return function(){return new ActiveXObject("Microsoft.XMLHTTP")}}}}();XmlRequest.prototype.send=function(b,a){this.request=this.create();if(this.request!=null){if(b!=null){this.request.onreadystatechange=mxUtils.bind(this,function(){if(this.isReady()){b(this);this.onreadystatechaange=null}})}this.request.open(this.method,this.url,this.async,this.username,this.password);this.setRequestHeaders(this.request,this.params);this.request.send(this.params)}};XmlRequest.prototype.setRequestHeaders=function(a,b){if(b!=null){a.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}};
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");Jxstar.GridEvent=function(a){this.define=a;this.grid=null;this.audit0="0";this.audit1="1";this.audit2="2";this.audit6="6";this.audit_b="";this.audit_e="7";if(this.define.status){this.audit0=this.define.status.audit0;this.audit1=this.define.status.audit1;this.audit_b=this.define.status.audit_b;this.audit_e=this.define.status.audit_e}this.addEvents("beforecreate","beforesave","aftersave","beforedelete","afterdelete","beforeaudit","afteraudit","beforecopy","aftercopy","beforecustom","aftercustom","beforeimport","afterimport","beforeprint","afterprint");Jxstar.GridEvent.superclass.constructor.call(this,a)};(function(){Ext.extend(Jxstar.GridEvent,Ext.util.Observable,{myDestroy:function(){this.define=null;delete this.define;this.grid=null;delete this.grid},setPage:function(page){this.grid=page},impType:function(){var self=this;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}var rightTypeId=self.grid.rightTypeId;var rightGrid=self.grid.rightGrid;var selUserIds=self.grid.selUserIds;if(!rightGrid||!rightTypeId||!selUserIds){JxHint.alert(jx.event.noqxbg);return}var endcall=function(data){rightGrid.getStore().reload();self.grid.rightGrid=null;delete self.grid.rightGrid;self.grid.rightTypeId=null;delete self.grid.rightTypeId;self.grid.selUserIds=null;delete self.grid.selUserIds;var win=self.grid.findParentByType("window");if(win){win.close()}};var params="funid="+self.define.nodeid+"&userids="+selUserIds;for(var i=0;i<records.length;i++){params+="&keyid="+records[i].get(self.define.pkcol)}params+="&pagetype=imptype&eventcode=imptype&typeid="+rightTypeId;Request.postRequest(params,endcall)},customEvent:function(eventCode){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}if(this.fireEvent("beforecustom",this,eventCode)==false){return}var self=this;var hdcall=function(){var params="funid="+self.define.nodeid;for(var i=0;i<records.length;i++){params+="&keyid="+records[i].get(self.define.pkcol)}params+="&pagetype=grid&eventcode="+eventCode;var endcall=function(data){if(self.grid.gridNode.param.substat){self.substat(self.grid)}self.fireEvent("aftercustom",self,data,eventCode);self.grid.getStore().reload()};Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.doyes,function(btn){if(btn=="yes"){hdcall()}})},showForm:function(){var store=this.grid.getStore();var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selectone(records)){return}Jxstar.showForm({define:this.define,grid:this.grid,record:records[0],store:store})},showSubForm:function(){var self=this;var url=self.define.formpage;if(url==null||url.length==0){return}var store=this.grid.getStore();var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selectone(records)){return}Jxstar.openSubForm({filename:url,title:self.define.nodetitle,grid:self.grid,pagetype:"subform",parentNodeId:self.grid.gridNode.parentNodeId,record:records[0],store:store})},create:function(){var self=this;var store=this.grid.getStore();Jxstar.showForm({define:self.define,grid:self.grid,record:null,store:store})},subcreate:function(){var self=this;var store=this.grid.getStore();Jxstar.openSubForm({filename:self.define.formpage,title:self.define.nodetitle,grid:self.grid,pagetype:"subform",parentNodeId:self.grid.gridNode.parentNodeId,record:null,store:store})},checkAudit:function(auditval){if(Ext.isEmpty(auditval)){auditval=this.audit1}var records=JxUtil.getSelectRows(this.grid);for(var i=0;i<records.length;i++){var auditcol=this.define.auditcol;if(Ext.isEmpty(auditcol)){return false}var state=records[i].get(auditcol);if(Ext.isEmpty(state)){state=this.audit0}if(auditval==this.audit0){if(state!=this.audit1){JxHint.alert(jx.event.selaudit0);return true}}else{if(auditval==this.audit1){if(state!=this.audit0&&state!=this.audit6){JxHint.alert(jx.event.selaudit1);return true}}}}return false},del:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}if(this.checkAudit()){return}if(this.fireEvent("beforedelete",this,records)==false){return}var self=this;var hdcall=function(){var params="funid="+self.define.nodeid;for(var i=0;i<records.length;i++){params+="&keyid="+records[i].get(self.define.pkcol)}params+="&pagetype=grid&eventcode=delete";var endcall=function(data){if(self.grid.gridNode.param.substat){self.substat(self.grid)}self.fireEvent("afterdelete",self,data);self.grid.getStore().reload()};Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.delyes,function(btn){if(btn=="yes"){hdcall()}})},audit:function(){this.baseAudit(this.audit1,"audit")},unaudit:function(){this.baseAudit(this.audit0,"unaudit")},auditBack:function(){if(Ext.isEmpty(this.audit_b)){JxHint.alert(jx.event.auditbe);return}this.baseAudit(this.audit_b,"audit_back")},auditCancel:function(){if(Ext.isEmpty(this.audit_e)){JxHint.alert(jx.event.auditee);return}this.baseAudit(this.audit_e,"audit_cancel")},baseAudit:function(auditval,eventcode){var store=this.grid.getStore();var mrow=store.getModifiedRecords();if(mrow.length>0){if(confirm(jx.event.saveyes)){this.editSave();return false}else{store.rejectChanges()}}var keyids=[];var cm=this.grid.getColumnModel();var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}if(JxAttach.checkGrid(this.grid)==false){return}if(JxUtil.validateGrid(this.grid)==false){return}if(Ext.isEmpty(eventcode)){eventcode="audit"}if(Ext.isEmpty(auditval)){auditval=this.audit1}if(this.checkAudit(auditval)){return}if(this.fireEvent("beforeaudit",this)==false){return}var self=this;var define=this.define;var hdcall=function(){var params="funid="+self.define.nodeid;for(var i=0;i<records.length;i++){params+="&keyid="+records[i].get(self.define.pkcol)}params+="&pagetype=grid&eventcode="+eventcode+"&auditvalue="+auditval;var endcall=function(data){self.fireEvent("afteraudit",self,data);self.grid.getStore().reload()};var errorcall=function(result){var extd=result.extData;if(eventcode=="audit"&&extd&&extd.checkMsg){JxUtil.checkResult(extd)}else{var msg=result.message;if(msg.length==0){msg=jx.req.faild}JxHint.alert(msg)}};Request.postRequest(params,endcall,{errorcall:errorcall})};var shint="";if(auditval==self.audit0){shint=jx.event.auditno}else{if(auditval==self.audit_b){shint=jx.event.auditback}else{if(auditval==self.audit_e){shint=jx.event.auditcancel}else{shint=jx.event.audityes}}}Ext.Msg.confirm(jx.base.hint,shint,function(btn){if(btn=="yes"){hdcall()}})},editCreate:function(){var g=this.grid;var record=this.createRecord();var store=g.getStore();g.stopEditing();store.insert(0,record);var col=JxUtil.getEditCol(g);g.startEditing(0,col);var sm=g.getSelectionModel();if(sm.selectRow){sm.selectFirstRow()}else{sm.select(0,col)}if(this.fireEvent("beforecreate",this)==false){return}},createRecord:function(){var cm=this.grid.getColumnModel();var store=this.grid.getStore();var record=new (store.reader.recordType)({});var cols=record.fields.keys;for(var i=0;i<cols.length;i++){var colobj=cm.getColumnById(cols[i]);var defaultval=(colobj)?colobj.defaultval:"";if(typeof defaultval=="string"&&defaultval.indexOf("fun_")==0){var val=eval("JxDefault."+defaultval.split("fun_")[1]);record.set(cols[i],val)}else{if(typeof defaultval=="undefined"){record.set(cols[i],"")}else{record.set(cols[i],defaultval)}}}return record},substat:function(subGrid){var params="funid=sysevent&pagetype=subgrid&eventcode=substat";var fkv=subGrid.fkValue?subGrid.fkValue:"";if(Ext.isEmpty(fkv)){return}params+="&fkValue="+fkv;var pfunId=subGrid.gridNode.parentNodeId;if(Ext.isEmpty(pfunId)){return}params+="&pfunid="+pfunId;var endcall=function(data){if(Ext.isEmpty(data)){return}var form=JxUtil.getParentForm(subGrid);if(!Ext.isEmpty(form)&&form.myRecord){var record=form.myRecord;Ext.iterate(data,function(key,value){form.oset(key,value);record.set(key,value)});record.commit()}else{var mGrid=JxUtil.getParentGrid(subGrid);if(mGrid){var records=JxUtil.getSelectRows(mGrid);if(records&&records.length>0){var record=records[0];Ext.iterate(data,function(key,value){record.set(key,value)});record.commit()}}}};Request.postRequest(params,endcall)},editDelete:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}if(this.checkAudit()){return}if(this.fireEvent("beforedelete",this,records)==false){return}var self=this;var pkcol=self.define.pkcol;var store=self.grid.getStore();var hdcall=function(){var keys="";for(var i=0;i<records.length;i++){var k=records[i].get(pkcol);if(k==null||k.length==0){store.remove(records[i])}else{keys+="&keyid="+records[i].get(pkcol)}}if(keys.length==0){return true}var params="funid="+self.define.nodeid+keys;params+="&pagetype=editgrid&eventcode=delete_eg";var endcall=function(data){if(self.grid.gridNode.param.substat){self.substat(self.grid)}self.fireEvent("afterdelete",self,data);self.grid.getStore().reload()};Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.delyes,function(btn){if(btn=="yes"){hdcall()}})},editCopy:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}if(this.fireEvent("beforecopy",this)==false){return}var keys="";var pkcol=this.define.pkcol;for(var i=0;i<records.length;i++){keys+="&keyid="+records[i].get(pkcol)}var self=this;var hdcall=function(text){var params="funid="+self.define.nodeid;params+=keys+"&copynum="+text;var attr=self.grid.treeNodeAttr;if(attr){var parentId=attr.id;var levelCol=attr.node_level;params+="&parentId="+parentId+"&levelCol="+levelCol}params+="&pagetype=grid&eventcode=copy_eg";var endcall=function(data){if(self.grid.gridNode.param.substat){self.substat(self.grid)}self.fireEvent("aftercopy",self,data);self.grid.getStore().reload()};Request.postRequest(params,endcall)};Ext.MessageBox.prompt(jx.base.hint,jx.event.copynum,function(btn,text){if(btn!="ok"){return}if(text.length==0||isNaN(text)){JxHint.alert(jx.event.nocopynum);return}if(text<1){text="1"}hdcall(text)},null,null,"1")},editSave:function(){var cm=this.grid.getColumnModel();var store=this.grid.getStore();var mrow=store.getModifiedRecords();if(mrow.length==0){JxHint.alert(jx.event.nomodify);return}if(this.fireEvent("beforesave",this)==false){return}var keys="";var pkcol=this.define.pkcol;var self=this;for(var i=0,n=mrow.length;i<n;i++){var record=mrow[i];var fields=record.fields.keys;keys+="&keyid="+record.get(pkcol);for(var j=0;j<fields.length;j++){var name=fields[j];var value=record.data[name];if(value==null){value=""}var colIndex=cm.findColumnIndex(name);var rowIndex=store.indexOfId(record.id);var editor=cm.getCellEditor(colIndex,rowIndex);if(editor==null){continue}var field=editor.field;if(field!=null&&!field.validateValue(value)){JxHint.alert(jx.event.datavalid);self.grid.startEditing(rowIndex,colIndex);return}}}var params="funid="+this.define.nodeid;var fkn=this.grid.fkName;if(fkn&&fkn.length>0){var fkv=this.grid.fkValue?this.grid.fkValue:"";if(fkv.length==0){JxHint.alert(jx.event.nofkv);return}params+="&fkValue="+fkv}var pfunId=this.grid.gridNode.parentNodeId;if(!Ext.isEmpty(pfunId)){params+="&pfunid="+pfunId}var attr=self.grid.treeNodeAttr;if(attr){var parentId=attr.id;var levelCol=attr.node_level;params+="&parentId="+parentId+"&levelCol="+levelCol}params+=keys+"&pagetype=editgrid&eventcode=save_eg";Ext.each(mrow,function(item){params+="&"+Ext.urlEncode(item.data)});var self=this;var endcall=function(data){store.commitChanges();if(self.grid.gridNode.param.substat){self.substat(self.grid)}self.fireEvent("aftersave",self,data);self.grid.getStore().reload()};Request.postRequest(params,endcall)},viewHtmlReport:function(){var self=this;var funid=self.define.nodeid;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selectone(records)){return}var keyid=records[0].get(self.define.pkcol);var viewReport=function(reportId){var pk=self.define.pkcol.replace("__",".");var whereSql=pk+" = ?";var params="funid="+funid+"&reportId="+reportId+"&isCheck=true&printType=html&whereSql="+whereSql+"&whereValue="+keyid+"&whereType=string";params+="&user_id="+Jxstar.session.user_id;var href=Jxstar.path+"/reportAction.do?"+params;var tabPanel=self.grid.findParentByType("tabpanel");if(tabPanel==null||!tabPanel.isXType(Ext.TabPanel)){tabPanel=new Ext.Window({title:"显示审批表单",layout:"fit",width:820,height:600,resizable:false,modal:true,closeAction:"close",items:[]})}var title=self.define.nodetitle;JxUtil.createReportTab(tabPanel,href,title,funid,keyid)};var hdCall=function(data){if(data==null||data.length==0){JxHint.alert("当前功能没有审批单定义！");return}viewReport(data[0].report_id)};var params="funid=rpt_list&pagetype=grid&eventcode=checkrpt&selfunid="+funid+"&dataid="+keyid+"&repttype=form&wheresql=";Request.dataRequest(params,hdCall)},dataImport:function(){var self=this;if(this.fireEvent("beforeimport",this)==false){return}var routes=RuleData[self.define.nodeid];if(!routes||routes.length==0){JxHint.alert("没有定义导入SQL、或者没有生成SQL规则文件！");return false}var endcall=function(page,srcnode,win){var title=jx.base.imp+"--"+srcnode.nodetitle;if(win==null){win=new Ext.Window({tbar:tbar,title:title,layout:"fit",width:750,height:500,constrainHeader:true,resizable:true,border:false,modal:true,closeAction:"close",autoScroll:true,style:"padding: 5px;",items:[page]});win.show()}else{win.setTitle(title);win.remove(0);win.add(page);win.doLayout()}};var tbar=null;if(routes.length>1){var items=[];var showSrcFun=function(radio){if(radio.getValue()=="0"){return}var srcId=radio.inputValue;var win=radio.findParentByType("window");if(win==null){return}for(var i=0,n=routes.length;i<n;i++){if(routes[i].srcNodeId==srcId){self.showImpGrid(routes[i],endcall,win);break}}};for(var i=0,n=routes.length;i<n;i++){var srcId=routes[i].srcNodeId;var srcnode=Jxstar.findNode(srcId);var srcName=srcnode?srcnode.nodetitle:srcId;var item={xtype:"radio",boxLabel:srcName,name:"impSrcNodeId",inputValue:srcId,handler:showSrcFun};if(i==0){item.checked=true}items[i]=item}tbar=new Ext.Toolbar({deferHeight:true,style:"border-bottom-width:0;",items:items})}self.showImpGrid(routes[0],endcall)},showImpGrid:function(route,endcall,win){var self=this;var fkValue=self.grid.fkValue;var srcNodeId=route.srcNodeId;var layout=route.layout;var whereSql=route.whereSql||"";var whereType=route.whereType||"";var whereValue=route.whereValue||"";if(whereSql.length>0){whereSql="("+whereSql+")"}if(whereSql.indexOf("{FKEYID}")>=0){whereSql=whereSql.replace("{FKEYID}","?");whereType=whereType.length==0?"string":"string;"+whereType;whereValue=whereValue.length==0?fkValue:fkValue+";"+whereValue}if(typeof self.dataImportParam=="function"){var options=self.dataImportParam(srcNodeId);if(!options){return}if(options.whereSql!=null&&options.whereSql.length>0){if(whereSql.length>0){whereSql+=" and ("+options.whereSql+")"}else{whereSql=options.whereSql}}if(options.whereType!=null&&options.whereType.length>0){if(whereType.length>0){whereType+=";"}whereType+=options.whereType}if(options.whereValue!=null&&options.whereValue.length>0){if(whereValue.length>0){whereValue+=";"}whereValue+=options.whereValue}}var loaddata=function(grid){JxUtil.delay(500,function(){if(typeof self.dataImportGrid=="function"){grid=self.dataImportGrid(grid,srcNodeId)}else{if(!grid.isXType("grid")){var tree=grid.getComponent(0).getComponent(0);if(tree.isXType("treepanel")){if(grid.getComponent(1).getComponent(0).isXType("grid")){grid=grid.getComponent(1).getComponent(0)}else{if(grid.getComponent(1).getComponent(0).isXType("tabpanel")){grid=grid.getComponent(1).getComponent(0).getComponent(0).getComponent(0)}else{JxHint.alert("找不到表格页面！")}}}else{if(grid.isXType("tabpanel")){grid=grid.getComponent(0).getComponent(0)}else{grid=grid.getComponent(1).getComponent(0);if(!grid.isXType("grid")){grid=grid.getComponent(0).getComponent(0);if(!grid.isXType("grid")){JxHint.alert("找不到表格页面！")}}}}}}grid.destParentId=fkValue;grid.destNodeId=self.define.nodeid;grid.destGrid=self.grid;grid.on("beforedestroy",function(gp){gp.destParentId=null;delete gp.destParentId;gp.destNodeId=null;delete gp.destNodeId;gp.destGrid=null;delete gp.destGrid;gp=null;return true});Jxstar.loadData(grid,{where_sql:whereSql,where_value:whereValue,where_type:whereType})})};var srcnode=Jxstar.findNode(srcNodeId);if(layout==null||layout.length==0){layout=srcnode.gridpage}var hdcall=function(f){var pagetype="import";var page=f(srcnode,{pageType:pagetype});if(typeof page.showPage=="function"){page=page.showPage(pagetype)}endcall(page,srcnode,win);loaddata(page)};Request.loadJS(layout,hdcall)},imp:function(){var self=this;var tb=self.grid.getTopToolbar();if(!JxUtil.getButton(tb,"import")){return}var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}JxUtil.disableButton(tb,true);var keys="";var pkcol=self.define.pkcol;for(var i=0;i<records.length;i++){keys+="&keyid="+records[i].get(pkcol)}var parentId=self.grid.destParentId;var destFunId=self.grid.destNodeId;var params="funid="+self.define.nodeid+"&destfunid="+destFunId+keys;params+="&parentId="+parentId+"&pagetype=import&eventcode=import";var endcall=function(data){JxUtil.disableButton(self.grid.getTopToolbar(),false);self.fireEvent("afterimport",self,{srcFunId:self.define.nodeid,destFunId:destFunId,data:data});self.grid.getStore().reload();var destGrid=self.grid.destGrid;if(destGrid!=null){if(destGrid.gridNode.param.substat){self.substat(destGrid)}destGrid.getStore().reload()}};Request.postRequest(params,endcall)},clearRecord:function(){this.grid.getSelectionModel().clearSelections();this.grid.fireEvent("rowclick",this.grid);this.grid.fireEvent("rowdblclick",this.grid)},selRecord:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}this.grid.fireEvent("rowclick",this.grid);this.grid.fireEvent("rowdblclick",this.grid)},addAttach:function(attachField){if(attachField!=null&&attachField.isXType&&attachField.isXType("button")){attachField=null}var dataId,dataFunId,dataField,tableName;var nodeid=this.define.nodeid;var isAttach=this.define.isAttach;if(nodeid=="sys_attach"||nodeid=="project_attach"||isAttach){dataId=this.grid.attachDataId||"";dataFunId=this.grid.attachFunId||"";dataField=attachField||""}else{var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selectone(records)){return}var pkcol=this.define.pkcol;dataId=records[0].get(pkcol);dataFunId=nodeid;dataField=attachField||"";tableName=this.define.tablename}if(dataId.length==0){JxHint.alert(jx.event.noup);return}if(dataFunId.length==0){JxHint.alert(jx.event.noupfun);return}var self=this;if(Jxstar.systemVar.uploadType=="1"){var url=Jxstar.systemVar.uploadUrl;var showIframe=function(){var ifrHtml='<iframe frameborder="no" style="display:none;border-width:0;width:100%;height:100%;"></iframe>';var win=new Ext.Window({title:"上传附件",layout:"fit",width:400,height:160,modal:true,closeAction:"close",html:ifrHtml,listeners:{show:function(cmp){var href=url+"/public/core/uploadfield.jsp?dataid="+dataId+"&datafunid="+dataFunId+"&attach_field="+dataField+"&user_id="+Jxstar.session.user_id;if(dataField&&dataField.length>0){href+="&eventcode=fcreate&table_name="+tableName}var frm=cmp.getEl().child("iframe");frm.dom.src=href+"&_dc="+(new Date()).getTime();frm.show()}}});win.on("close",function(){if(nodeid=="sys_attach"||nodeid=="project_attach"||isAttach){self.grid.getStore().reload()}});win.show()};showIframe();return}var formItems=[{xtype:"fileuploadfield",useType:"file",maxLength:50,fieldLabel:jx.event.selfile,name:attachField||"attach_path",labelSeparator:"*",buttonText:"",buttonCfg:{iconCls:"upload_icon"},listeners:{fileselected:function(f,path){var len=path.length;if(len>0){var pos=path.lastIndexOf("\\");if(pos>=0){path=path.substr(pos+1,len)}}queryForm.getForm().findField("attach_name").setValue(path)}}},{xtype:"textfield",fieldLabel:jx.event.upname,name:"attach_name",labelSeparator:"*",maxLength:50}];var formHeight=160;var comboType=this.grid.attachTypeCombo;if(comboType){if(typeof comboType=="function"){comboType=comboType()}formHeight=190;formItems.insert(0,comboType)}var queryForm=new Ext.form.FormPanel({layout:"form",labelAlign:"right",labelWidth:80,border:false,baseCls:"x-plain",autoHeight:true,bodyStyle:"padding: 20px 10px 0 10px;",defaults:{anchor:"95%",allowBlank:false,msgTarget:"side"},items:formItems});var win=new Ext.Window({title:jx.event.uptitle,layout:"fit",width:400,height:formHeight,resizable:false,modal:true,closeAction:"close",items:[queryForm],buttons:[{text:jx.base.ok,handler:function(){var form=queryForm.getForm();if(!form.isValid()){return}var params="funid=sys_attach&pagetype=editgrid";params+="&attach_field="+dataField+"&dataid="+dataId+"&datafunid="+dataFunId;if(dataField&&dataField.length>0){params+="&eventcode=fcreate&table_name="+tableName}else{params+="&eventcode=create"}var attach_type=form.get("attach_type_combo");if(attach_type.length>0){params+="&attach_type="+attach_type}var hdCall=function(){win.close();if(nodeid=="sys_attach"||nodeid=="project_attach"||attachField||isAttach){self.grid.getStore().reload()}};Request.fileRequest(form,params,hdCall)}},{text:jx.base.cancel,handler:function(){win.close()}}]});win.show()},upload:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selectone(records)){return}var self=this;var pkcol=this.define.pkcol;var nodeid=this.define.nodeid;var keyid=records[0].get(pkcol);var deled=false,acol=self.define.auditcol;if(!Ext.isEmpty(acol)){var audit=records[0].get(acol);if(audit==self.audit0||audit==self.audit6){deled=true}}else{var attr=self.define.attachDeled;deled=(Ext.isEmpty(attr))?false:attr}if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var options={};if(typeof self.uploadWhereParam=="function"){options=self.uploadWhereParam()}else{var tablename=self.define.tablename;options.where_sql="sys_attach.data_id = ? and sys_attach.table_name = ?";options.where_type="string;string";options.where_value=keyid+";"+tablename}var comboType=null;if(typeof self.grid.attachTypeCombo=="function"){comboType=self.grid.attachTypeCombo()}var hdcall=function(grid){JxUtil.delay(500,function(){grid.attachDataId=keyid;grid.attachFunId=nodeid;grid.attachDeled=deled;if(comboType){grid.attachTypeCombo=comboType}grid.on("beforedestroy",function(gp){gp.attachDataId=null;delete gp.attachDataId;gp.attachFunId=null;delete gp.attachFunId;gp.attachDeled=null;delete gp.attachDeled;gp.attachTypeCombo=null;delete gp.attachTypeCombo;gp=null;return true});Jxstar.loadData(grid,options)})};var srcDefine=Jxstar.findNode("sys_attach");Jxstar.showData({filename:srcDefine.gridpage,title:srcDefine.nodetitle,pagetype:"editgrid",nodedefine:srcDefine,callback:hdcall})},expxls:function(){JxExport.showWindow(this.grid.gridNode)},print:function(){JxPrint.showWindow(this.grid.gridNode)},agree:function(){var store=this.grid.getStore();var mrow=store.getModifiedRecords();if(mrow.length>0){if(confirm(jx.event.saveyes)){this.editSave();return false}else{store.rejectChanges()}}var self=this;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}var hdcall=function(){var params="funid=wf_assign&pagetype=chkgrid&eventcode=execheck&check_funid="+self.define.nodeid;for(var i=0;i<records.length;i++){params+="&keyid="+records[i].get(self.define.pkcol)}var checkType="Y",checkDesc=jx.event.agree;params+="&check_type="+checkType+"&check_desc="+encodeURIComponent(checkDesc);var endcall=function(data){self.grid.getStore().reload()};Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.agreeyes,function(btn){if(btn=="yes"){hdcall()}})},check:function(){var store=this.grid.getStore();var mrow=store.getModifiedRecords();if(mrow.length>0){if(confirm(jx.event.saveyes)){this.editSave();return false}else{store.rejectChanges()}}var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selected(records)){return}JxUtil.myCheckGrid=this.grid;if(records.length>1){this.checkMore(records)}else{this.baseWf("check_work")}},checkMore:function(records){var self=this;var dataId=records[0].get(self.define.pkcol);var dataIds="";for(var i=0,n=records.length;i<n;i++){dataIds+=records[i].get(self.define.pkcol);if(i<n-1){dataIds+=","}}var appData={funId:self.define.nodeid,dataId:dataId,dataIds:dataIds};JxUtil.showCheckWindow(appData,"check_work")},showassign:function(){this.baseWf("check_assign")},showhis:function(){this.baseWf("check_his")},showmap:function(){this.baseWf("check_map")},showlist:function(){var funId=this.define.nodeid;var appData={funId:funId,dataId:""};JxUtil.showCheckWindow(appData,"check_list")},baseWf:function(fileName){var funId=this.define.nodeid;this.showWorkFlow(funId,fileName)},editLog:function(){var records=JxUtil.getSelectRows(this.grid);if(!JxUtil.selectone(records)){return}var pkcol=this.define.pkcol;var nodeid=this.define.nodeid;var keyid=records[0].get(pkcol);if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var options={};options.where_sql="(fun_id = ? and data_id = ?) or (pfun_id = ? and pdata_id = ?)";options.where_type="string;string;string;string";options.where_value=nodeid+";"+keyid+";"+nodeid+";"+keyid;var hdcall=function(grid){JxUtil.delay(500,function(){Jxstar.loadData(grid,options)})};var df=Jxstar.findNode("sys_log_edit");Jxstar.showData({filename:df.gridpage,title:df.nodetitle,pagetype:"editgrid",nodedefine:df,pagetype:"query",callback:hdcall})},showWorkFlow:function(funId,fileName){var self=this;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}var dataId=records[0].get(self.define.pkcol);var appData={funId:funId,dataId:dataId};JxUtil.showCheckWindow(appData,fileName)},showPicture:function(){var self=this;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}var funId=self.define.nodeid;var url=Jxstar.path+"/commonAction.do?funid=sys_attach&pagetype=editgrid&eventcode=showpic&selfunid="+funId;url+="&dataType=json&user_id="+Jxstar.session.user_id;for(var i=0,n=records.length;i<n;i++){var keyid=records[i].get(self.define.pkcol);url+="&keyid="+keyid}var viewPicture=function(url){var tabPanel=self.grid.findParentByType("tabpanel");var shower=new ImageShower({parentCtl:tabPanel,url:url});var tab=shower.show();tabPanel.activate(tab)};viewPicture(url)},impExcel:function(imp_index){var impIndex="";if(Ext.isNumber(imp_index)||Ext.isString(imp_index)){impIndex=imp_index}var nodeid=this.define.nodeid;var queryForm=new Ext.form.FormPanel({layout:"form",labelAlign:"right",labelWidth:80,border:false,baseCls:"x-plain",autoHeight:true,bodyStyle:"padding: 20px 10px 0 10px;",defaults:{anchor:"95%",allowBlank:false,msgTarget:"side"},items:[{xtype:"fileuploadfield",useType:"file",fieldLabel:jx.event.selfile,name:"import_file",buttonText:"",maxLength:200,buttonCfg:{iconCls:"upload_icon"}}]});var self=this;var win=new Ext.Window({title:jx.event.uptitle,layout:"fit",width:400,height:130,resizable:false,modal:true,closeAction:"close",items:[queryForm],buttons:[{text:"下载模板",handler:function(){var params="funid=imp_list&impFunId="+nodeid+"&pagetype=grid&eventcode=downtpl&impIndex="+impIndex;Request.fileDown(params)}},{text:jx.base.ok,handler:function(){var form=queryForm.getForm();if(!form.isValid()){return}var fkValue=self.grid.fkValue;var params="funid="+nodeid+"&pagetype=grid&eventcode=impexcel&fkValue="+fkValue+"&impFunId="+nodeid+"&impIndex="+impIndex;var hdCall=function(data){if(!Ext.isEmpty(data)&&!Ext.isEmpty(data.valueInfo)){JxHint.alert(data.valueInfo)}win.close();self.grid.getStore().reload()};Request.fileRequest(form,params,hdCall)}},{text:jx.base.cancel,handler:function(){win.close()}}]});win.show()},dirPrint:function(printMode,printScope,printType,reportId){if(!Ext.isString(printMode)){printMode="0"}printMode=printMode||"0";printScope=printScope||"select";printType=printType||"html";reportId=reportId||"";var pageNode=this.grid.gridNode;var funId=this.define.nodeid;JxPrint.exePrint(pageNode,funId,reportId,printType,printScope,printMode)},showPic:function(){var self=this;var records=JxUtil.getSelectRows(self.grid);if(!JxUtil.selected(records)){return}var pkcol=self.define.pkcol;var funId=self.define.nodeid;var tablename=self.define.tablename;var url=Jxstar.path+"/commonAction.do?funid="+funId+"&pagetype=grid&eventcode=showpic&tablename="+tablename;url+="&dataType=json&user_id="+Jxstar.session.user_id;for(var i=0,n=records.length;i<n;i++){var keyid=records[i].get(pkcol);url+="&keyid="+keyid}var viewPicture=function(url){var tabPanel=self.grid.findParentByType("tabpanel");if(tabPanel){var shower=new ImageShower({parentCtl:tabPanel,url:url});var tab=shower.show();tabPanel.activate(tab)}};viewPicture(url)},refresh:function(){this.grid.getStore().reload()}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");Jxstar.FormEvent=function(a){this.define=a;this.page=null;this.form=null;this.audit0="0";this.audit1="1";this.audit2="2";this.audit6="6";this.audit_b="";this.audit_e="7";if(this.define.status){this.audit0=this.define.status.audit0;this.audit1=this.define.status.audit1;this.audit2=this.define.status.audit2;this.audit_b=this.define.status.audit_b;this.audit_e=this.define.status.audit_e}this.addEvents("beforecreate","aftercreate","beforesave","aftersave","beforedelete","afterdelete","beforeaudit","afteraudit","beforecopy","aftercopy","beforecustom","aftercustom","initother","beforeprint","afterprint");Jxstar.FormEvent.superclass.constructor.call(this,a)};(function(){Ext.extend(Jxstar.FormEvent,Ext.util.Observable,{myDestroy:function(){this.define=null;delete this.define;this.page=null;delete this.page;this.form=null;delete this.form},setPage:function(page){this.page=page;this.form=page.getForm()},customEvent:function(eventCode){var keyid=this.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}if(this.fireEvent("beforecustom",this,eventCode)==false){return}var self=this;var hdcall=function(){var endcall=function(data){self.fireEvent("aftercustom",self,data,eventCode)};var params="funid="+self.define.nodeid+"&keyid="+keyid;params+="&pagetype=form&eventcode="+eventCode;Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.doyes,function(btn){if(btn=="yes"){hdcall()}})},initForm:function(ispop){var self=this;var record=self.form.myRecord;var toolBar=self.page.getTopToolbar();var formnode=self.page.formNode;if(record){var state=record.get(self.define.auditcol);if(state==null||state.length==0){state=self.audit0}var audit0=self.audit0,audit6=self.audit6;var pageType=self.page.formNode.pageType;if(pageType=="subform"){var parentGrid=JxUtil.getParentGrid(self.form.myGrid);if(parentGrid){var records=parentGrid.getSelectionModel().getSelections();if(records.length>0){var pdef=parentGrid.gridNode.define;if(pdef.status){audit0=pdef.status.audit0;audit6=pdef.status.audit6}state=records[0].get(pdef.auditcol);if(state==null||state.length==0){state=audit0}}}}var dealEditState=function(){var noedit=(formnode.right.edit=="0");if(noedit||state!=null){var readOnly=noedit||(state!=audit0&&state!=audit6);JxUtil.readOnlyForm(self.form,readOnly);JxUtil.disableButton(toolBar,readOnly);if(!noedit&&pageType=="form"){var createBtn=JxUtil.getButton(toolBar,"create");if(createBtn){createBtn.setDisabled(false)}var unaudit=JxUtil.getButton(toolBar,"unaudit");if(unaudit){unaudit.setDisabled(false)}}}};if(ispop==true){JxUtil.delay(500,function(){dealEditState()})}else{dealEditState()}}JxUtil.clearDirty(self.form);var dataId=this.getPkField().getValue();if(state==self.audit2&&formnode.pageType.indexOf("chk")>=0){var nodeId=self.define.nodeid;JxUtil.showCheckEdit(nodeId,dataId,self.form,toolBar)}if(!Ext.isEmpty(dataId)){var images=self.page.findByType("imagefield");if(images&&images.length>0){Ext.each(images,function(item){var v=item.getValue();if(v.length==0){item.loadImage(Ext.BLANK_IMAGE_URL)}else{item.loadImage()}})}}self.fireEvent("initother",self);return self.initOther()},initOther:function(){},create:function(){var self=this;if(self.form.myRecord&&self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}}var record=self.createRecord();self.form.myRecord=record;self.form.loadRecord(record);JxUtil.readOnlyForm(self.form,false);var toolBar=self.page.getTopToolbar();JxUtil.disableButton(toolBar,false);var images=self.page.findByType("imagefield");if(images&&images.length>0){Ext.each(images,function(item){item.clearImage()})}if(self.fireEvent("beforecreate",self)==false){return}},createRecord:function(){var self=this;var fm=self.form;var record=null;var store=fm.myStore;if(store==null){record=self.newEmptyRecord()}else{record=new (store.reader.recordType)({})}var cols=record.fields.keys;for(var i=0;i<cols.length;i++){var field=fm.findField(cols[i]);if(field==null){continue}var defaultval=field.defaultval;if(typeof defaultval=="string"&&defaultval.indexOf("fun_")==0){var val=eval("JxDefault."+defaultval.split("fun_")[1]);record.set(cols[i],val)}else{if(typeof defaultval=="undefined"){if(cols[i]==self.define.auditcol){record.set(cols[i],self.audit0)}else{record.set(cols[i],"")}}else{record.set(cols[i],defaultval)}}}return record},newRecord:function(data){var record=this.newEmptyRecord();var cols=record.fields.keys;Ext.each(cols,function(f){record.set(f,data[f])});return record},newEmptyRecord:function(){var fields=[];var fm=this.form;fm.fieldItems().each(function(f){if(f.isFormField){var type=f.getXType();if(type=="datefield"){type="date"}else{if(type=="numberfield"){type="float"}else{type="string"}}var o={name:f.getName(),type:type};fields[fields.length]=o}});return new (Ext.data.Record.create(fields))()},del:function(){var keyid=this.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nokey);return}if(this.checkAudit(this.audit1,"del")){return}if(this.fireEvent("beforedelete",this)==false){return}var self=this;var hdcall=function(){var params="funid="+self.define.nodeid+"&keyid="+keyid;params+="&pagetype=form&eventcode=delete";var endcall=function(data){JxUtil.clearDirty(self.form);var record=self.form.myRecord;if(record!=null){var store=self.form.myStore;if(store!=null){store.remove(record)}}self.create();self.fireEvent("afterdelete",self,data)};Request.postRequest(params,endcall)};Ext.Msg.confirm(jx.base.hint,jx.event.delyes,function(btn){if(btn=="yes"){hdcall()}})},save:function(){var self=this;if(this.checkAudit()){return}if(this.fireEvent("beforesave",this)==false){return}var eventcode="save";var keyid=this.getPkField().getValue();if(keyid.length==0){eventcode="create"}if(eventcode=="save"&&!this.form.isDirty()){self.fireEvent("aftersave",self,{});return}var params="funid="+this.define.nodeid+"&keyid="+keyid;params+=JxUtil.getFormValues(this.form,false);params+="&pagetype=form&eventcode="+eventcode;var mygrid=self.form.myGrid;if(mygrid!=null){var attr=mygrid.treeNodeAttr;if(attr){var parentId=attr.id;var levelCol=attr.node_level;params+="&parentId="+parentId+"&levelCol="+levelCol;if(typeof(levelCol)=="undefined"||levelCol=="undefined"){if(this.define.regtype=="treemain"){alert("请重新打开功能，等树型加载完后再操作！");return}}}}if(eventcode!=="create"){params+="&dirtyfields="+JxUtil.getDirtyFields(this.form)}var fkv=this.form.fkValue?this.form.fkValue:"";params+="&fkValue="+fkv;var endcall=function(data){var record=self.form.myRecord;for(var key in data){var field,val=data[key];if(key=="keyid"){field=self.getPkField();if(field){field.osetValue(val)}}else{key=key.replace(".","__");field=self.form.findField(key);if(field){field.osetValue(val)}}}if(eventcode=="create"){var fkn=self.form.fkName;if(fkv.length>0&&fkn&&fkn.length>0){self.form.findField(fkn).osetValue(fkv)}}if(record!=null){self.form.updateRecord(record);record.commit();if(eventcode=="create"){var store=self.form.myStore;if(store!=null){store.insert(0,record);store.commitChanges()}var grid=self.form.myGrid;if(grid!=null){grid.getSelectionModel().selectFirstRow()}}}if(eventcode=="save"){self.fireEvent("aftersave",self,data)}else{self.fireEvent("aftercreate",self,data)}JxUtil.clearDirty(self.form)};Request.postRequest(params,endcall)},checkAudit:function(auditval,srctype){var self=this;if(Ext.isEmpty(auditval)){auditval=self.audit1}if(Ext.isEmpty(srctype)){srctype="audit"}if(srctype!="del"&&!self.form.isValid()){JxHint.alert(jx.event.datavalid);return true}var auditcol=self.define.auditcol;if(Ext.isEmpty(auditcol)){return false}var record=self.form.myRecord;var state=record.get(auditcol);if(Ext.isEmpty(state)){state=self.audit0}if(auditval==self.audit0){if(state!=self.audit1){JxHint.alert(jx.event.curaudit0);return true}}else{if(auditval==self.audit1){if(state!=self.audit0&&state!=self.audit2&&state!=self.audit6){JxHint.alert(jx.event.curaudit1);return true}}}return false},audit:function(){this.baseAudit(this.audit1,"audit")},unaudit:function(){this.baseAudit(this.audit0,"unaudit")},auditBack:function(){if(Ext.isEmpty(this.audit_b)){JxHint.alert(jx.event.auditbe);return}this.baseAudit(this.audit_b,"audit_back")},auditCancel:function(){if(Ext.isEmpty(this.audit_e)){JxHint.alert(jx.event.auditee);return}this.baseAudit(this.audit_e,"audit_cancel")},baseAudit:function(auditval,eventcode){var keyid=this.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var self=this;var record=self.form.myRecord;if(self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}else{return}}if(JxAttach.checkAttach(self.page)==false){return}if(Ext.isEmpty(eventcode)){eventcode="audit"}if(Ext.isEmpty(auditval)){auditval=self.audit1}if(this.checkAudit(auditval)){return}if(this.fireEvent("beforeaudit",this)==false){return}var hdcall=function(){var params="funid="+self.define.nodeid+"&keyid="+keyid;params+="&pagetype=form&eventcode="+eventcode+"&auditvalue="+auditval;var endcall=function(data){if(!Ext.isEmpty(data)){Ext.iterate(data,function(key,value){record.set(key,value)});record.commit();self.form.loadRecord(record)}self.fireEvent("afteraudit",self,data);JxUtil.clearDirty(self.form);var readOnly=(auditval==self.audit1);JxUtil.readOnlyForm(self.form,readOnly);var toolBar=self.page.getTopToolbar();JxUtil.disableButton(toolBar,readOnly);var createBtn=JxUtil.getButton(toolBar,"create");if(createBtn){createBtn.setDisabled(false)}};var errorcall=function(result){var extd=result.extData;if(eventcode=="audit"&&extd&&extd.checkMsg){JxUtil.checkResult(extd)}else{var msg=result.message;if(msg.length==0){msg=jx.req.faild}JxHint.alert(msg)}};Request.postRequest(params,endcall,{errorcall:errorcall})};var shint="";if(auditval==self.audit0){shint=jx.event.auditno}else{if(auditval==self.audit_b){shint=jx.event.auditback}else{if(auditval==self.audit_e){shint=jx.event.auditcancel}else{shint=jx.event.audityes}}}Ext.Msg.confirm(jx.base.hint,shint,function(btn){if(btn=="yes"){hdcall()}})},viewHtmlReport:function(){var self=this;var funid=self.define.nodeid;var keyid=self.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var viewReport=function(reportId){var pk=self.define.pkcol.replace("__",".");var whereSql=pk+" = ?";var params="funid="+funid+"&reportId="+reportId+"&isCheck=true&printType=html&whereSql="+whereSql+"&whereValue="+keyid+"&whereType=string";params+="&user_id="+Jxstar.session.user_id;var href=Jxstar.path+"/reportAction.do?"+params;var tabPanel=self.page.findParentByType("tabpanel");if(tabPanel==null||!tabPanel.isXType(Ext.TabPanel)){return}var title=self.define.nodetitle;JxUtil.createReportTab(tabPanel,href,title,funid,keyid)};var hdCall=function(data){if(data==null||data.length==0){JxHint.alert("当前功能没有审批单定义！");return}viewReport(data[0].report_id)};var params="funid=rpt_list&pagetype=grid&eventcode=checkrpt&selfunid="+funid+"&dataid="+keyid+"&repttype=form&wheresql=";Request.dataRequest(params,hdCall)},getPkField:function(){return this.form.findField(this.define.pkcol)},preRecord:function(){var self=this;var record=this.form.myRecord;if(record!=null){if(self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}}var store=this.form.myStore;if(store!=null){var index=store.indexOf(record);if(index>=1){var cunidx=index-1;record=store.getAt(cunidx);this.form.myRecord=record;this.form.loadRecord(record);var grid=this.form.myGrid;if(grid){grid.getSelectionModel().selectRow(cunidx);grid.fireEvent("rowclick",grid,cunidx)}self.initForm();return true}else{JxHint.alert(jx.event.firstrec)}}}return false},nextRecord:function(){var self=this;var record=self.form.myRecord;if(record!=null){if(self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}}var store=this.form.myStore;if(store!=null){var index=store.indexOf(record);if(index<store.getCount()-1){var cunidx=index+1;record=store.getAt(cunidx);this.form.myRecord=record;this.form.loadRecord(record);var grid=this.form.myGrid;if(grid){grid.getSelectionModel().selectRow(cunidx);grid.fireEvent("rowclick",grid,cunidx)}self.initForm();return true}else{JxHint.alert(jx.event.endrec)}}}return false},upload:function(){var keyid=this.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var self=this;var pkcol=this.define.pkcol;var nodeid=this.define.nodeid;var audit=this.form.get(this.define.auditcol);var deled=false,acol=self.define.auditcol;if(!Ext.isEmpty(acol)){var audit=self.form.get(acol);if(audit==self.audit0||audit==self.audit6){deled=true}}else{var attr=self.define.attachDeled;deled=(Ext.isEmpty(attr))?false:attr}var options={};if(typeof this.uploadWhereParam=="function"){options=this.uploadWhereParam()}else{var tablename=this.define.tablename;options.where_sql="sys_attach.data_id = ? and sys_attach.table_name = ?";options.where_type="string;string";options.where_value=keyid+";"+tablename}var hdcall=function(grid){JxUtil.delay(500,function(){grid.attachDataId=keyid;grid.attachFunId=nodeid;grid.attachDeled=deled;grid.on("beforedestroy",function(gp){gp.attachDataId=null;delete gp.attachDataId;gp.attachFunId=null;delete gp.attachFunId;gp.attachDeled=null;delete gp.attachDeled;gp=null;return true});Jxstar.loadData(grid,options)})};var srcDefine=Jxstar.findNode("sys_attach");Jxstar.showData({filename:srcDefine.gridpage,title:srcDefine.nodetitle,pagetype:"editgrid",nodedefine:srcDefine,callback:hdcall})},print:function(){JxPrint.showWindow(this.page.formNode)},agree:function(){var self=this;var keyid=self.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nokey);return}if(self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}}var hdcall=function(){var params="funid=wf_assign&pagetype=chkgrid&eventcode=execheck&check_funid="+self.define.nodeid;params+="&keyid="+keyid;var checkType="Y",checkDesc=jx.event.agree;params+="&check_type="+checkType+"&check_desc="+encodeURIComponent(checkDesc);Request.postRequest(params,null)};Ext.Msg.confirm(jx.base.hint,jx.event.agreeyes,function(btn){if(btn=="yes"){hdcall()}})},takecheck:function(){var self=this;var keyid=self.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nokey);return}var hdcall=function(){var params="funid=wf_assign&pagetype=chkgrid&eventcode=takecheck&check_funid="+self.define.nodeid;params+="&keyid="+keyid;var checkType="Y",checkDesc=String.format(jx.event.takedesc,JxDefault.getUserName());params+="&check_type="+checkType+"&check_desc="+encodeURIComponent(checkDesc);Request.postRequest(params,null)};Ext.Msg.confirm(jx.base.hint,jx.event.takeyes,function(btn){if(btn=="yes"){hdcall()}})},check:function(){this.baseWf("check_work")},showassign:function(){this.baseWf("check_assign")},showhis:function(){this.baseWf("check_his")},showmap:function(){this.baseWf("check_map")},baseWf:function(fileName){var self=this;var keyid=self.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nokey);return}if(self.form.isDirty()){if(confirm(jx.event.saveyes)){self.save();return}}var funId=self.define.nodeid;var appData={funId:funId,dataId:keyid};JxUtil.showCheckWindow(appData,fileName)},editLog:function(){var nodeid=this.define.nodeid;var keyid=this.getPkField().getValue();if(keyid==null||keyid.length==0){JxHint.alert(jx.event.nosave);return}var options={};options.where_sql="(fun_id = ? and data_id = ?) or (pfun_id = ? and pdata_id = ?)";options.where_type="string;string;string;string";options.where_value=nodeid+";"+keyid+";"+nodeid+";"+keyid;var hdcall=function(grid){JxUtil.delay(500,function(){Jxstar.loadData(grid,options)})};var df=Jxstar.findNode("sys_log_edit");Jxstar.showData({filename:df.gridpage,title:df.nodetitle,pagetype:"editgrid",nodedefine:df,pagetype:"query",callback:hdcall})},dirPrint:function(printMode,printScope,printType,reportId){if(!Ext.isString(printMode)){printMode="0"}printMode=printMode||"0";printScope=printScope||"select";printType=printType||"html";reportId=reportId||"";var pageNode=this.page.formNode;var funId=this.define.nodeid;JxPrint.exePrint(pageNode,funId,reportId,printType,printScope,printMode)}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxExt={};Array.prototype.insert=function(a,c){if(a>=this.length){this[this.length]=c;return this}if(a<0){a=this.length+a}for(var b=this.length-1;b>=a;b--){this[b+1]=this[b]}this[a]=c;return this};Ext.enableListenerCollection=true;Ext.urlEncode=function(f,d){var b,a=[],c=encodeURIComponent;Ext.iterate(f,function(e,g){b=Ext.isEmpty(g);Ext.each(b?e:g,function(h){a.push("&",c(e),"=",(!Ext.isEmpty(h)&&(h!=e||!b))?(Ext.isDate(h)?h.dateFormat("Y-m-d H:i:s"):c(h)):"")})});if(!d){a.shift();d=""}return d+a.join("")};Ext.PagingToolbar.prototype.doLoad=function(d){var c={};var b=this.store.lastOptions;if(b&&b.params){c=b.params}var a=this.getParams();c[a.start]=d;c[a.limit]=this.pageSize;if(this.fireEvent("beforechange",this,c)!==false){this.store.load({params:c})}Jxstar.startNo=d};Ext.grid.RowNumberer.prototype.width=40;Ext.grid.RowNumberer.prototype.css="background:#f0f0f0 !important;";Ext.grid.GridView.prototype.getColumnStyle=function(b,d){var a=this.cm,f=a.config,c=d?f[b].hcss||"":f[b].css||"",e=f[b].align;c+=String.format("width: {0};",this.getColumnWidth(b));if(a.isHidden(b)){c+="display: none; "}if(e){c+=String.format("text-align: {0};",e)}return c};Ext.grid.GridView.prototype.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>");Ext.grid.PropertyGrid.prototype.initComponent=function(){this.customRenderers=this.customRenderers||{};this.customEditors=this.customEditors||{};this.lastEditRow=null;var b=new Ext.grid.PropertyStore(this);this.propStore=b;var a=new Ext.grid.PropertyColumnModel(this,b);this.addEvents("beforepropertychange","propertychange");this.cm=a;this.ds=b.store;Ext.grid.PropertyGrid.superclass.initComponent.call(this);this.mon(this.selModel,"beforecellselect",function(e,d,c){if(c===0){this.startEditing.defer(200,this,[d,1]);return false}},this)};Ext.form.Checkbox.prototype.getValue=function(){if(this.rendered&&this.el){return this.el.dom.checked?"1":"0"}return this.checked?"1":"0"};Ext.tree.TreeLoader.prototype.handleResponse=function(c){this.transId=false;var b=c.argument;var e=Ext.decode(c.responseText).data;if(e!=null){c.responseText=Ext.encode(e)}this.processResponse(c,b.node,b.callback,b.scope);this.fireEvent("load",this,b.node,c)};Ext.form.BasicForm.prototype.set=function(b,d){var c=this.findField(b);if(c){var a=c.getValue();c.setValue(d);c.fireEvent("change",c,a,d)}return this};Ext.form.BasicForm.prototype.get=function(a){var b=this.findField(a);if(b){return b.getValue()}return""};Ext.form.BasicForm.prototype.getNum=function(a){var c="";var b=this.findField(a);if(b){c=b.getValue()}if(c==null||c.length==0){return 0}return parseFloat(c)};Ext.form.BasicForm.prototype.oset=function(b,d){var c=this.findField(b);if(c){var a=c.getValue();c.setValue(d);c.originalValue=d}return this};Ext.form.BasicForm.prototype.fieldItems=function(){var a=new Ext.util.MixedCollection(false,function(b){return b.getItemId()});this.items.each(function(b){if(b.isComposite){b.items.each(function(c){a.add(c.getItemId(),c)})}else{a.add(b.getItemId(),b)}});return a};Ext.form.BasicForm.prototype.isDirty=function(){var a=false;this.items.each(function(b){if(!Ext.isEmpty(b.name)&&b.isDirty()){a=true;return false}});return a};Ext.form.ComboBox.prototype.restrictHeight=function(){this.innerList.dom.style.height="";var c=this.innerList.dom,g=this.list.getFrameWidth("tb")+(this.resizable?this.handleHeight:0)+this.assetHeight,e=Math.max(c.clientHeight,c.offsetHeight,c.scrollHeight),a=this.getPosition()[1]-Ext.getBody().getScroll().top,i=Ext.lib.Dom.getViewHeight()-a-this.getSize().height,f=Math.max(a,i,this.minHeight||0)-this.list.shadowOffset-g-5;e=Math.min(e,f,this.maxHeight);if(Ext.isIE){var b=c.clientWidth,d=c.offsetWidth;if(b<d){e+=18}}else{e+=1}this.innerList.setHeight(e);this.list.beginUpdate();this.list.setHeight(e+g);this.list.alignTo.apply(this.list,[this.el].concat(this.listAlign));this.list.endUpdate()};Ext.form.ComboBox.prototype.getValue=function(){var a="";if(this.valueField){a=Ext.isDefined(this.value)?this.value:""}else{a=Ext.form.ComboBox.superclass.getValue.call(this)}if(a==jx.star.select){a="";this.value="";this.originalValue=""}return a};Ext.form.Field.prototype.osetValue=function(a){this.setValue(a);this.originalValue=a};Ext.form.DateField.prototype.onSelect=function(b,c){if(Ext.isDate(c)){var a=new Date();c.setHours(a.getHours(),a.getMinutes(),a.getSeconds())}this.setValue(c);this.fireEvent("select",this,c);this.menu.hide()};Ext.form.DateField.prototype.parseDate=function(f){if(!f||Ext.isDate(f)){return f}if(!Ext.isEmpty(f)&&f.length==7&&this.format=="Y-m"){return Date.parseDate(f+"-01","Y-m-d")}var b=this.safeParse(f,this.format),c=this.altFormats,e=this.altFormatsArray;if(!b&&c){e=e||c.split("|");for(var d=0,a=e.length;d<a&&!b;d++){b=this.safeParse(f,e[d])}}return b},Ext.layout.FormLayout.prototype.labelSeparator="";Ext.form.NumberField.prototype.selectOnFocus=true;Ext.form.TextField.prototype.selectOnFocus=true;Ext.form.BasicForm.prototype.trackResetOnLoad=true;Ext.Component.prototype.stateful=false;Ext.Window.prototype.iconCls="eb_win";Ext.Window.prototype.shadow=false;Ext.layout.MenuLayout.prototype.isValidParent=function(d,b){var a=d.el.up("li.x-menu-list-item",5);if(Ext.isEmpty(a)){return false}return a.dom.parentNode===(b.dom||b)};Ext.form.Field.prototype.setReadOnly=function(a){if(this.rendered&&this.el){this.el.dom.readOnly=a;if(a){this.el.addClass("x-field-only")}else{this.el.removeClass("x-field-only")}}this.readOnly=a};Ext.form.TriggerField.prototype.setReadOnly=function(a){if(a!=this.readOnly&&this.el){if(a){this.el.addClass("x-field-only")}else{this.el.removeClass("x-field-only")}this.readOnly=a;this.updateEditState()}};Ext.form.TriggerField.prototype.updateEditState=function(){if(this.rendered&&this.el){if(this.readOnly){this.el.dom.readOnly=true;this.el.addClass("x-field-only");this.el.addClass("x-trigger-noedit");this.mun(this.el,"click",this.onTriggerClick,this);this.emptyText=""}else{if(!this.editable){this.el.dom.readOnly=true;this.el.addClass("x-trigger-noedit");this.mon(this.el,"click",this.onTriggerClick,this)}else{this.el.dom.readOnly=false;this.el.removeClass("x-field-only");this.el.removeClass("x-trigger-noedit");this.mun(this.el,"click",this.onTriggerClick,this)}}}};Ext.form.DateField.prototype.onTriggerClick=function(){if(this.readOnly||this.disabled){return}if(this.menu==null){this.menu=new Ext.menu.DateMenu({hideOnClick:false,focusOnSelect:false})}this.onFocus();Ext.apply(this.menu.picker,{minDate:this.minValue,maxDate:this.maxValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,startDay:this.startDay,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});this.menu.picker.setValue(this.getValue()||new Date());this.menu.show(this.el,"tl-bl?");this.menuEvents("on")};Ext.form.DateField.prototype.fieldClass="x-field-d";Ext.form.NumberField.prototype.fieldClass="x-field-n";Ext.EventObjectImpl.prototype.isSpecialKey=function(){var a=this.normalizeKey(this.keyCode);return(this.type=="keypress"&&this.ctrlKey)||this.isNavKeyPress()||(a==this.BACKSPACE)||(a>=16&&a<=20)||(a>=44&&a<=46)||(a>=112&&a<=123)};Ext.grid.RowSelectionModel.prototype.getEditor=Ext.emptyFn;Ext.data.Types.INT={convert:function(a){return a!==undefined&&a!==null&&a!==""?parseInt(String(a).replace(Ext.data.Types.stripRe,""),10):""},sortType:Ext.data.SortTypes.none,type:"int"};Ext.data.Types.FLOAT={convert:function(a){return a!==undefined&&a!==null&&a!==""?parseFloat(String(a).replace(Ext.data.Types.stripRe,""),10):""},sortType:Ext.data.SortTypes.none,type:"float"};Ext.data.Types.DATE={convert:function(b){var c=this.dateFormat;if(!b){return""}if(Ext.isDate(b)){return b}if(c){if(c=="timestamp"){return new Date(b*1000)}if(c=="time"){return new Date(parseInt(b,10))}return Date.parseDate(b,c)}var a=Date.parse(b);return a?new Date(a):""},sortType:Ext.data.SortTypes.asDate,type:"date"};Ext.apply(Ext.form.VTypes,{time24:function(c,b){var a=/^([0-9]|0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/i;return a.test(c)},time24Text:jx.base.timetext});Ext.data.Record.prototype.getNum=function(a){var b=this.data[a];if(b==null||b.length==0){return 0}return parseFloat(b)};Ext.form.TextField.prototype.getErrors=function(a){var d=Ext.form.TextField.superclass.getErrors.apply(this,arguments);a=Ext.isDefined(a)?a:this.processValue(this.getRawValue());if(Ext.isFunction(this.validator)){var c=this.validator(a);if(c!==true){d.push(c)}}if(a.length<1||a===this.emptyText){if(this.allowBlank){return d}else{if(!this.isBlankCheck){d.push(this.blankText)}}}if(!this.isBlankCheck&&!this.allowBlank&&(a.length<1||a===this.emptyText)){d.push(this.blankText)}if(JxUtil.strlen(a)<this.minLength){d.push(String.format(this.minLengthText,this.minLength))}if(JxUtil.strlen(a)>this.maxLength){d.push(String.format(this.maxLengthText,this.maxLength))}if(this.vtype){var b=Ext.form.VTypes;if(!b[this.vtype](a,this)){d.push(this.vtypeText||b[this.vtype+"Text"])}}if(this.regex&&!this.regex.test(a)){d.push(this.regexText)}return d};Ext.form.BasicForm.prototype.isValidBlank=function(){var a=true;this.items.each(function(b){b.isBlankCheck=true;if(!b.validate()){a=false}delete b.isBlankCheck});return a};Ext.Container.prototype.getComponent=function(a){if(Ext.isObject(a)){a=a.getItemId()}if(this.items==null){return null}return this.items.get(a)};Ext.form.Field.prototype.afterRender=function(){Ext.form.Field.superclass.afterRender.call(this);this.initEvents();this.initValue();var b=function(h,n){if(h.getKey()==h.ENTER){var l=this;var j=l.findParentByType("form");if(Ext.isEmpty(j)){return}var k=j.form.items;var c=0,f=-1,g=-1,d=-1;k.each(function(e){if(e.isFormField&&e.rendered&&e.name&&!e.isXType("hidden")&&!e.isXType("textarea")){if(f<0){f=c}if(e.name==l.name){g=c}else{if(g>=0){d=c;return false}}}c++});if(g>=0&&d<0){d=f}if(d>=0){var m=k.get(d);if(m){m.focus(true)}}}};var a=Jxstar.systemVar.edit__field__next;if(a=="1"){this.mon(this.el,Ext.EventManager.getKeyEvent(),b,this)}};Ext.grid.RowSelectionModel.prototype.onEditorKey=function(n,l){var d=l.getKey(),f,h=this.grid,p=h.lastEdit,i=h.activeEditor,b=l.shiftKey,o,p,a,m;var j=(Jxstar.systemVar.edit__field__next=="1");if(j){if(d==l.ENTER){if(b){f=h.walkCells(p.row,p.col-1,-1,this.acceptsNav,this)}else{f=h.walkCells(p.row,p.col+1,1,this.acceptsNav,this)}}else{if(d==l.TAB){l.stopEvent();i.completeEdit();if(this.moveEditorOnEnter!==false){if(b){f=h.walkCells(p.row-1,p.col,-1,this.acceptsNav,this)}else{f=h.walkCells(p.row+1,p.col,1,this.acceptsNav,this)}}}}}else{if(d==l.TAB){l.stopEvent();i.completeEdit();if(b){f=h.walkCells(i.row,i.col-1,-1,this.acceptsNav,this)}else{f=h.walkCells(i.row,i.col+1,1,this.acceptsNav,this)}}else{if(d==l.ENTER){if(this.moveEditorOnEnter!==false){if(b){f=h.walkCells(p.row-1,p.col,-1,this.acceptsNav,this)}else{f=h.walkCells(p.row+1,p.col,1,this.acceptsNav,this)}}}}}if(f){a=f[0];m=f[1];this.onEditorSelect(a,p.row);if(h.isEditor&&h.editing){o=h.activeEditor;if(o&&o.field.triggerBlur){o.field.triggerBlur()}}h.startEditing(a,m)}if(l.ctrlKey&&l.altKey&&i){i.completeEdit()}};Ext.ux.ToolbarKeyMap=Ext.extend(Object,(function(){var c,a,e;var d=function(f){if(c=f.keyBinding){delete f.keyBinding;if(!c.fn&&f.handler){c.fn=function(g,h){h.preventDefault();h.stopEvent();f.handler.call(f.scope,f,h)}}e.push(c)}if((f instanceof Ext.Button)&&f.menu){f.menu.cascade(d)}};var b=function(){delete this.onRender;if(a=this.ownerCt){e=[];this.cascade(d);if(!a.menuKeyMap){a.menuKeyMap=new Ext.KeyMap(a.el,e);a.el.dom.tabIndex=0}else{a.menuKeyMap.addBinding(e)}}};return{init:function(f){f.onRender=f.onRender.createSequence(b);f.doLayout=f.doLayout.createSequence(b)}}})());JxUtil.getDecimalPrecision=function(m){var c=m.ownerCt;var j,d,k;if(c){if(c.isXType("form")==false){c=c.findParentByType("form")}if(c){d=c.getForm();j=c.formNode.param.precisionField}}else{var g=m.el.findParentNode("div.x-grid-panel");var a=Ext.getCmp(g.id);if(a){var n=a.lastEdit;if(n){d=a.getStore().getAt(n.row)}else{var l=JxUtil.getSelectRows(a);if(l&&l.length>0){d=l[0]}}j=a.gridNode.param.precisionField}}if(d&&j){var b,o,e;if(m.name){b=j[m.name]}if(b){o=d.get(b)}if(o&&(typeof(Jxstar.UnitData)!="undefined")){for(var f=0;f<Jxstar.UnitData.length;f++){if(Jxstar.UnitData[f].unit_name==o){e=Jxstar.UnitData[f].keep_num;break}}}if(e!=null){k=e}}if(k==null){var h=parseInt(Jxstar.systemVar.sys__numdyn__len);k=isNaN(h)?2:h}return k};Ext.form.NumberField.prototype.beforeBlur=function(){var b=this.parseValue(this.getRawValue());if(this.format=="numset"){var a=parseInt(Jxstar.systemVar.sys__numset__len);this.decimalPrecision=isNaN(a)?2:a}if(this.format=="numdyn"){if(Jxstar.systemVar.sys__numdyn__use=="1"){var a=parseInt(Jxstar.systemVar.sys__numdyn__len);this.decimalPrecision=isNaN(a)?2:a}else{if(JxUtil.getDecimalPrecision){this.decimalPrecision=JxUtil.getDecimalPrecision(this)}}}if(!Ext.isEmpty(b)){this.setValue(b)}};JxExt.bbsurl=function(b){var a=".";if(Jxstar.systemVar.uploadType=="1"){a=Jxstar.systemVar.uploadUrl}a+="/fileAction.do?funid=sys_attach&pagetype=editgrid&eventcode=down&nousercheck=1&dataType=byte&keyid="+b;return a};JxExt.bbsfile=function(b){var c=document.getElementById("frmhidden");c.src=JxExt.bbsurl(b.id)};ImgHtmlEditor=Ext.extend(Ext.form.HtmlEditor,{addImage:function(k){var g=this;var c=g.findParentByType("form");if(Ext.isEmpty(c)){return}var a=c.getForm();var e=c.formNode.define;var j=e.nodeid;var i=e.tablename;var b=a.get(e.pkcol);var h=[{xtype:"fileuploadfield",useType:"file",labelWidth:50,maxLength:50,fieldLabel:"选择文件",name:"attach_path",labelSeparator:"*",buttonText:"",buttonCfg:{iconCls:"upload_icon"},listeners:{fileselected:function(m,n){var l=n.length;if(l>0){var o=n.lastIndexOf("\\");if(o>=0){n=n.substr(o+1,l)}}d.getForm().findField("attach_name").setValue(n)}}},{xtype:"hidden",fieldLabel:"附件名称",name:"attach_name",labelSeparator:"*",maxLength:50}];var d=new Ext.FormPanel({region:"center",frame:true,bodyStyle:"padding:5px 5px 0",border:false,items:h,buttons:[{text:"上传",type:"submit",handler:function(){var m=d.form;var n="funid=sys_attach&pagetype=editgrid";n+="&attach_field=&dataid="+b+"&datafunid="+j;n+="&eventcode=create";var l=function(p){if(Ext.isEmpty(p)){JxHint.alert("文件上传失败！");return}var o;if(k=="1"){o='<img src="'+JxExt.bbsurl(p.attachId)+'">'}else{o='<a href="#" id="'+p.attachId+'" onclick="return JxExt.bbsfile(this);">'+m.get("attach_name")+"</a>"}g.insertAtCursor(o);f.close()};Request.fileRequest(m,n,l)}},{text:"关闭",type:"submit",handler:function(){f.close(this)}}]});var f=new Ext.Window({title:"上传文件",width:300,height:105,modal:true,border:false,icon:"./resources/images/icons/button/upload.gif",layout:"fit",items:d});f.show()},createToolbar:function(a){ImgHtmlEditor.superclass.createToolbar.call(this,a);this.tb.insertButton(16,{cls:"x-btn-icon",tooltip:"添加图片",icon:"./resources/images/icons/button/upload.gif",handler:function(){this.addImage("1")},scope:this});this.tb.insertButton(17,{cls:"x-btn-icon",tooltip:"添加文件",icon:"./resources/images/icons/button/change.gif",handler:function(){this.addImage("0")},scope:this})}});Ext.reg("imghtmleditor",ImgHtmlEditor);
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Ext.ns("Jxstar");(function(){Ext.apply(Jxstar,{pageSize:50,startNo:0,session:{},rightNodes:[],editor:null,systemVar:{},createNode:function(c,j){if(c==null||c.length==0){JxHint.alert(jx.star.noid);return false}var f=Jxstar.findNode(c);if(f==null){JxHint.alert(String.format(jx.star.nodef,c));return false}var a=(j&&j.pageType&&j.pageType=="check");if(!a&&!Jxstar.validNode(c)){JxHint.alert(String.format(jx.star.noright,c));return false}var d=Jxstar.sysMainTab;var e=f.nodetitle;var i=d.getComponent("fun_"+f.nodeid);if(a){e+="--"+jx.base.check;if(i!=null){d.remove(i,true);i=null}}if(i==null){var h=d.items.length;if(h>8){JxHint.alert(jx.star.morefun);return false}var g=function(l){var k=l(f,j);if(typeof k.showPage=="function"){j=j||{};k=k.showPage(j.pageType,j.parentNodeId)}i=d.add({id:"fun_"+f.nodeid,title:e,border:false,layout:"fit",closable:true,autoScroll:true,iconCls:"function",items:[k],listeners:{beforedestroy:function(){k=null;i=null},destroy:function(){if(Ext.isIE){CollectGarbage()}}}});d.activate(i);if(k.isXType("grid")){if(j&&j.whereSql&&j.whereSql.length>0){Jxstar.loadData(k,{where_sql:j.whereSql,where_value:j.whereValue,where_type:j.whereType,is_query:j.isQuery})}else{Jxstar.loadInitData(k)}}k=null};var b=f.layout;if(b==null||b.length==0){b=f.gridpage}if(b==null||b.length==0||b.indexOf(".jsp")>-1){JxHint.alert(String.format(jx.star.nopage,c));return false}Request.loadJS(b,g)}else{d.activate(i)}},createPage:function(f,a,e,c){if(f==null||f.length==0){JxHint.alert(jx.star.noid);return}var g=Jxstar.findNode(f);if(g==null){JxHint.alert(String.format(jx.star.nodef,f));return}var b=function(j){var i=j(g,c);if(typeof i.showPage=="function"){c=c||{};i=i.showPage(c.pageType,c.parentNodeId)}e.add(i);e.doLayout();if(i.isXType("grid")){i.focus();if(c&&c.whereSql&&c.whereSql.length>0){Jxstar.loadData(i,{where_sql:c.whereSql,where_value:c.whereValue,where_type:c.whereType,is_query:c.isQuery})}else{Jxstar.loadInitData(i)}if(c&&c.showType&&(c.showType=="form"||c.showType=="report")){var h=i.getStore();if(h==null){return}h.on("load",function(){if(i==null){return}var k=0;if(c.updateId!=null&&c.updateId.length>0){k=h.find(g.pkcol,c.updateId)}if(k<0){return true}i.getSelectionModel().selectRow(k);if(c.showType=="report"){i.gridNode.event.viewHtmlReport()}else{i.gridNode.event.showForm()}i=null})}}};var d=g[a];if(d.length==0){JxHint.alert(String.format(jx.star.nopage,f));return false}Request.loadJS(d,b)},createTree:function(b,g,d,c,h){if(b==null||b.length==0){JxHint.alert(jx.star.notreeid);return}d=d||g.getComponent(0);c=c||g.getComponent(1);var a="10";var i=function(p,q,r){var n=Jxstar.path+"/commonAction.do?eventcode=query_tree&funid=queryevent";n+="&tree_funid="+b+"&user_id="+Jxstar.session.user_id;var l=new Ext.Toolbar();var s=new Ext.tree.TreePanel({teamid:(p)?q:"",tbar:(p)?null:l,border:(p)?false:true,autoScroll:true,rootVisible:false,lines:false,useArrows:false,loader:new Ext.tree.TreeLoader({dataUrl:n,listeners:{beforeload:function(t,u){t.baseParams.tree_no=u.attributes.tree_no||"";if(p){t.baseParams.team_id=q}}}}),root:new Ext.tree.AsyncTreeNode({id:a,iconCls:"tree_root_ext",text:jx.star.refresh})});s.on("load",function(u){if(u.id==a){var w=u.firstChild;if(!w){return}var t=w.attributes;var v=t.tree_title;if(v.length>0){l.items.get(0).setText(v)}u.attributes.tree_no=t.tree_no;u.attributes.table_name=t.table_name;u.attributes.node_level=t.node_level;u.attributes.right_where=t.right_where;if(w.id=="10"){w.remove(true)}}});var m=function(){s.getLoader().load(s.getRootNode());s.fireEvent("click",s.getRootNode())};l.add({text:jx.star.refresh,iconCls:"tree_root",handler:m});var o=function(){var w=c.getComponent(0);var u=w;if(!w.isXType("grid")){u=w.getComponent(0).getComponent(0)}var t=s.getRootNode();var v=t.attributes;u.treeNodeAttr={id:"",text:"",node_level:v.node_level,tree_no:v.tree_no,table_name:v.table_name};u.cmpTree=s;s.on("click",function(y){if(s.hasCustClick){return}if(w.isXType("tabpanel")){w.activate(w.getComponent(0))}var G=null;if(h!=null&&typeof h=="function"){G=h(s,y,u)}var F=y.attributes;var D=F.id;var B=Math.floor(D.length/4)+1;var x="string";var E=D+"%";var I=F.right_where;if(I&&I.length>0){I="("+I+")"}var A=s.getTopToolbar();if(A){var C=A.find("xtype","checkbox");if(C.length>0){if(C[0].getValue()=="1"){E=D}}}if(I.indexOf("=")>=0){E=D}if(a==D){E="%"}if(I.indexOf("[tree_id]")>=0){var H=/\[tree_id\]/g;I=I.replace(H,E)}if(I.indexOf("?")<0){x="",E=""}if(G!=null){if(!Ext.isEmpty(G.where_sql)){I+=" and "+G.where_sql}if(!Ext.isEmpty(G.where_value)){E+=";"+G.where_value}if(!Ext.isEmpty(G.where_type)){x+=";"+G.where_type}}var z=u.gridNode?u.gridNode.define.regtype:"";if(z=="treemain"&&(F.tree_no=="1"||F.tree_no=="")){if(F.has_level=="1"&&B>1){I+=" and ("+F.node_level+" = ? or "+F.node_level+" = ?)";E+=";"+B+";"+(B-1);x+=";int;int"}else{I+=" and "+F.node_level+" = ?";E+=";"+B;x+=";int"}}if(x.charAt(0)==";"){x=x.substring(1,x.length);E=E.substring(1,E.length)}u.jxstarParam.tree_wsql=I;u.jxstarParam.tree_wtype=x;u.jxstarParam.tree_wvalue=E;Jxstar.loadData(u,{where_sql:I,where_value:E,where_type:x,is_query:1});u.treeNodeAttr=F});s.on("beforedestroy",function(){u=null;w=null;c=null})};var k=function(t){var v=t.getComponent(0);if(Ext.isEmpty(v)){return null}var u=v;if(!v.isXType("grid")){u=v.getComponent(0).getComponent(0)}return u};JxUtil.delay(1000,function(){var t=k(c);if(Ext.isEmpty(t)){JxUtil.delay(1000,o)}else{o()}});return s};var j;var f=function(p){if(Ext.isEmpty(p)){j=i(false);d.add(j);d.doLayout();return}var t=p.length>1;var s;if(t){var m=new Array();for(var q=0;q<p.length;q++){m[q]=[p[q].team_id,p[q].team_title]}var l=Jxstar.createCombo("sel_tree",m,130);var o=d.getTopToolbar();o.add(l);l.on("select",function(n){var u=n.value;s=null;d.items.each(function(v){if(v.teamid==u){s=v}});if(s){d.layout.setActiveItem(s.id)}});var r=function(){s.getLoader().load(s.getRootNode());s.fireEvent("click",s.getRootNode())};o.add("->",{text:"",iconCls:"x-tbar-loading",handler:r});d.border=true;d.layout=new Ext.Container.LAYOUTS.card}for(var q=0,k=p.length;q<k;q++){j=i(t,p[q].team_id,p[q].team_title);d.add(j);d.doLayout()}d.activeItem=0;s=d.getComponent(0)};var e=Jxstar.findNode(b);f(e.treeteam);return j},openSubForm:function(a){var b=function(e){var d=e();if(typeof d.showPage=="function"){d=d.showPage(a.pagetype||"form",a.parentNodeId)}var g=new Ext.Window({title:a.title,layout:"fit",width:a.width||750,height:a.height||500,constrainHeader:true,modal:true,border:false,closeAction:"close",autoScroll:true,style:"padding: 5px;",items:[d]});g.show();if(a.store!=null){var c=d.getForm();c.myGrid=a.grid;c.myStore=a.store;if(a.record==null){d.formNode.event.create()}else{c.myRecord=a.record;c.loadRecord(a.record)}c.fkName=a.grid.fkName;c.fkValue=a.grid.fkValue;d.formNode.event.initForm(true)}};Request.loadJS(a.filename,b)},showForm:function(b){var c=b.grid.findParentByType("tabpanel");if(c==null){return}var d=c.getComponent(1);if(d==null){return}var a=d.getComponent(0);if(a==null||!a.isXType("form")){return}var e=a.getForm();e.myGrid=b.grid;e.myStore=b.store;e.fkName=b.grid.fkName;e.fkValue=b.grid.fkValue;e.srcEvent="create";if(b.record==null){a.formNode.event.create()}else{e.myRecord=b.record;e.loadRecord(b.record)}c.activate(d)},showData:function(a){var b=function(e){var d=e(a.nodedefine,{pageType:a.pagetype});if(typeof d.showPage=="function"){d=d.showPage(a.pagetype)}var c=a.modal;if(a.modal==null){c=true}var h={title:a.title,layout:"fit",width:a.width||750,height:a.height||500,constrainHeader:true,border:false,modal:c,closeAction:"close",autoScroll:true,style:"padding: 5px;",items:[d]};if(a.wincfg){Ext.apply(h,a.wincfg)}var g=new Ext.Window(h);g.show();if(a.callback){a.callback(d)}};Request.loadJS(a.filename,b)},showQuery:function(a){var b=function(d){var e=JxQuery.queryWindow(d,a);var f=new Ext.Window({title:jx.star.hqry,layout:"fit",width:750,height:450,constrainHeader:true,resizable:false,modal:true,closeAction:"close",style:"padding: 5px;",items:[e]});f.show()};var c="funid=queryevent&eventcode=cond_query";c+="&selfunid="+a.nodeId;Request.dataRequest(c,b)},queryData:function(c,a){if(c==null||c.length==0||a==null){JxHint.alert(jx.star.noparam);return false}var d="eventcode=query_data&funid=queryevent&query_funid="+c;d+="&where_sql="+a.where_sql||"";d+="&where_value="+a.where_value||"";d+="&where_type="+a.where_type||"";var b=function(e){if(a.callback){a.callback(e.root)}};Request.dataRequest(d,b)},loadSubData:function(d,b){if(d==null){return}if(!d.isXType("grid")){JxHint.alert(jx.star.nosubgrid);return}if(b==null||b.length==0){return}var a=d.fkName;if(a==null||a.length==0){JxHint.alert(jx.star.nofk);return false}a=a.replace("__",".");d.fkValue=b;var c=a+" = ?";var e={where_sql:c,where_value:b,where_type:"string"};if(d.subWhereSql){e.where_sql=d.subWhereSql()}if(d.subWhereParam){e=d.subWhereParam()}Jxstar.loadData(d,e)},reload:function(a){a.getStore().load({params:{start:0,limit:Jxstar.pageSize}})},loadData:function(d,c){if(d==null||d.getStore()==null){return}if(c.is_query==null){d.jxstarParam.old_wsql=c.where_sql||"";d.jxstarParam.old_wtype=c.where_type||"";d.jxstarParam.old_wvalue=c.where_value||""}else{var b=d.jxstarParam.old_wsql;var g=d.jxstarParam.old_wtype;var e=d.jxstarParam.old_wvalue;if(b&&b.length>0){if(c.where_sql&&c.where_sql.length>0){c.where_sql="("+b+") and ("+c.where_sql+")"}else{c.where_sql=b}}if(g&&g.length>0){if(c.where_type&&c.where_type.length>0){c.where_type=g+";"+c.where_type}else{c.where_type=g}}if(e&&e.length>0){if(c.where_value&&c.where_value.length>0){c.where_value=e+";"+c.where_value}else{c.where_value=e}}}var a=JxUtil.getPageSize(d);var f=Ext.apply({start:0,limit:a},c);d.getStore().load({params:f})},loadInitData:function(c){if(c!=null&&c.isXType("grid")){var b=c.getStore();var d=c.pageType;var a=JxUtil.getPageSize(c);if(b!=null&&c.isShow=="1"&&(d!="combogrid"&&d.indexOf("sub")<0)){b.load({params:{start:0,limit:a}})}}},loadDataBc:function(a){if(a==null||a.getStore()==null){return}var b=a.getStore().getCount();var c=a.getSelectionModel();var d=Jxstar.getSelectIndex(a);if(d>-1&&b>0&&typeof c.selectRow!="undefined"){c.selectRow(d);if(b>0&&a.pageType!="combogrid"){a.fireEvent("rowclick",a,d)}}Jxstar.viewSumData(a);JxAttach.viewAttachFlag(a)},getSelectIndex:function(d){if(d==null||d.getStore()==null){return 0}var e=d.selectKeyId||"";var f=-1,b=d.getStore();if(e.length>0){var a=d.gridNode.define.pkcol;var c=b.find(a,e);if(c>-1){f=c}}return f},viewSumData:function(b){var a=b.getStore().reader.jsonData.data.sum;if(a!=null&&a.length>0){if(b.jxsum){b.jxsum.refresh({data:a[0]})}else{var c=new Jxstar.JxSum();c.init(b);c.refresh({data:a[0]})}}},findNode:function(a){var b=NodeDefine[a];if(b==null){return{gridpage:"",formpage:""}}b.nodetitle=JxLang.funText(b.nodeid,b.nodetitle);return b},validNode:function(c){if(Jxstar.isone=="1"){return true}var a=this;if(JxUtil.isAdminUser()){return true}for(var b=0;b<a.rightNodes.length;b++){if(a.rightNodes[b]==c){return true}}return false},findComboData:function(b){var a=ComboData[b];if(a==null){a=[["",""]]}return a},createComboMenu:function(b){var a=new Ext.menu.Menu({width:350,height:300});a.parentField=b;return a},createCombo:function(d,a,c){var b=new Ext.form.ComboBox({name:d,store:new Ext.data.SimpleStore({fields:["value","text"],data:a}),emptyText:jx.star.select,mode:"local",triggerAction:"all",valueField:"value",displayField:"text",editable:false,width:c||80,value:a[0][0]});return b},createSimpleQuery:function(b){var a=this;var c=b.page;var d=c.getTopToolbar();d.add("-");a.addBaseQry(b,d);d.add({iconCls:"eb_qryh",tooltip:jx.star.hqry,handler:function(){a.showQuery(b)}});d.doLayout()},addBaseQry:function(g,a){var r=this;var e=g.page;var q=e.getColumnModel();var d=[],o=q.config;for(var t=0,w=0,s=o.length;t<s;t++){var f=o[t],l=f.dataIndex;if(l==null||l.length==0){continue}if(f.colindex>=10000){continue}var u=l.length;if(l.substring(u-2)!="id"||!f.hidden){var v=f.header;if(v.charAt(0)=="*"){v=v.substr(1)}d[w++]=[l,v]}}var p=r.createCombo("field_qf",d,100);a.add(p);var b=ComboData.condtype;var k=r.createCombo("field_qc",b);a.add(k);var m=new Ext.Container({name:"field_qv",width:120,layout:"fit",border:false,items:[{xtype:"textfield"}]});a.add(m);m.on("afterlayout",function(i){var h=i.getComponent(0).getEl();if(h&&h.getHeight()<20){h.setHeight(20)}});p.on("select",function(y){var F,c="",h="string";var H=m.getComponent(0);if(H!=null&&H.isXType("textfield",true)){c=H.getValue()}var D=g.param.cols;for(var B=0,x=D.length;B<x;B++){var E=D[B].col,C=D[B].field;if(C&&C.name==y.getValue()){h=C.type;if(!E.hasOwnProperty("editor")){if(h=="string"){F=new Ext.form.TextField()}else{if(h=="date"){var G=JxUtil.getDateFormat(E.renderer);F=new Ext.form.DateField({format:G})}else{F=new Ext.form.NumberField({maxLength:12})}}}else{var z=E.editor;var A=false;if(z.isXType("combo")&&z.mode=="local"){A=true}Ext.apply(z.initialConfig,{allowBlank:true,editable:!A,cls:""});F=new z.constructor(z.initialConfig);if(A){F.setValue("");F.on("specialkey",function(n,i){if(i.getKey()==i.DELETE||i.getKey()==i.BACKSPACE){n.setValue("")}})}}break}}if(F==null){F=new Ext.form.TextField({allowBlank:false})}if(F.isXType("textfield",true)&&c!=null&&c.length>0){F.setValue(c);H=null;c=""}F.selectOnFocus=true;m.removeAll(true);m.add(F);m.doLayout(true);F.on("specialkey",function(n,i){if(i.getKey()==i.ENTER){r.simpleQuery(e,p,k,m)}});JxQuery.setCondDefault(k,h,F.getXType());m.valueType=h});var j=g.define.first;if(j!=null&&j.length>0){p.setValue(j)}p.fireEvent("select",p);a.add({xtype:"button",iconCls:"eb_qry",tooltip:jx.star.qry,handler:function(){r.simpleQuery(e,p,k,m)}})},simpleQuery:function(h,f,d,e){var g=f.getValue().replace("__",".");var b=d.getValue();var k=e.getComponent(0).getValue();var a=e.valueType;var c=0;var j=e.ownerCt.findByType("checkbox")[0];if(j&&j.getName()=="xx_isarch"&&j.getValue()=="1"){c=1}var i=JxQuery.getWhere(g,b,k,a);Jxstar.myQuery(h,i,c)},myQuery:function(d,f,a){if(f==null){f=new Array("","","")}if(a==null){a="0"}var b=d.jxstarParam.tree_wsql;var e=d.jxstarParam.tree_wtype;var c=d.jxstarParam.tree_wvalue;if(b&&b.length>0){if(f[0]&&f[0].length>0){f[0]=b+" and ("+f[0]+")"}else{f[0]=b}}if(c&&c.length>0){if(f[1]&&f[1].length>0){f[1]=c+";"+f[1]}else{f[1]=c}}if(e&&e.length>0){if(f[2]&&f[2].length>0){f[2]=e+";"+f[2]}else{f[2]=e}}Jxstar.loadData(d,{where_sql:f[0],where_value:f[1],where_type:f[2],is_query:1,query_type:a})}})})();
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxWfGraph={};Ext.apply(JxWfGraph,{editor:null,graphId:"",queryValue:null,isFlag:false,showGraphFun:function(b,e,c,f){var i=this;var d=Jxstar.sysMainTab;var a="wfnav_graph_fun_tab";var h=d.getComponent(a);var g=f||"流程导航图";if(h==null){h=d.add({id:a,title:g,border:false,layout:"fit",closable:true,autoScroll:false,iconCls:"function"})}else{h.setTitle(g)}d.activate(h);i.createGraph(h,b,e,c)},createGraph:function(f,a,g,e){var d=this;d.graphId=a;d.queryValue=g||{};d.isFlag=e||false;var c=f.getComponent(0);if(c==null){var b="wfnav_graph_tab";var h=['<div id="mx_graph_show_nav" style="height:100%;width:100%;background-color:white;overflow:none;">','<center id="mx_splash" style="padding-top:230px;">','<img src="public/lib/graph/images/loading.gif">',"</center>","</div>"];c=new Ext.Panel({id:b,border:true,layout:"fit",html:h.join("")});f.add(c);f.doLayout();c.on("destroy",function(){if(d.editor!=null){d.editor.destroy();mxClient.dispose();d.editor=null}});d.createEdit()}d.readDesign()},isTask:function(a){if(a==null){return false}var b=new mxCodec();var d=b.encode(a);var c=d.getAttribute("nodetype");if(c=="task"){return true}return false},getTaskId:function(a){if(a==null){return""}var b=new mxCodec();var d=b.encode(a);var c=d.getAttribute("nodetype");if(c=="task"){return d.getAttribute("id")}return""},createEdit:function(){var b=this;JxUtil.loadJxGraph();b.editor=new mxCanvas("public/lib/graph/config/showeditor_nav.xml");var c=b.editor.graph;c.setCellsEditable(false);c.setCellsSelectable(false);c.setConnectable(false);c.setCellsMovable(false);var a=new mxCellTracker(c);a.mouseMove=function(e,f){var d=this.getCell(f);if(d&&b.isTask(d)){f.getState().setCursor("pointer");if(this.cur_cell==null){this.cur_cell=d;b.moveNode(d,true)}}else{b.moveNode(this.cur_cell,false);this.cur_cell=null}};c.addListener(mxEvent.CLICK,function(f,e){var d=e.getProperty("cell");var g=b.getTaskId(d);if(g.length>0){b.clickCell(b.graphId,g)}})},clickCell:function(a,e){var b=this;var c=function(g){if(g==null||g.fun_id==null){JxHint.alert("没有找到点击节点的设置属性！");return}var f=g.fun_id;if(!Ext.isEmpty(f)){if(!Jxstar.validNode(f)){JxHint.alert(String.format(jx.star.noright,f));return false}if(!Ext.isEmpty(g.where_sql)){var h={};h.whereSql=g.where_sql;h.whereValue=JxUtil.parseWhereValue(g.where_value,b.queryValue);h.whereType=g.where_type;h.isQuery="1";Jxstar.createNode(f,h)}else{Jxstar.createNode(f)}}};var d="funid=wfnav_graph&eventcode=querynode&pagetype=formdes";d+="&graph_id="+a+"&node_id="+e;Request.dataRequest(d,c)},readDesign:function(){var a=this;var b=function(d){if(d==null||d.length==0){JxHint.alert("没有找到流程导航图设计文件！");return}var e=mxUtils.parseXml(d);var f=new mxCodec(e);f.decode(e.documentElement,a.editor.graph.getModel());a.queryFlag();a.disableFlag()};var c="funid=wfnav_graph&eventcode=readdesign&pagetype=formdes";c+="&graph_id="+a.graphId;Request.dataRequest(c,b,{type:"xml",wait:true})},queryFlag:function(){var b=this;if(!b.isFlag){return}var c=function(h){if(h==null||h.length==0){JxHint.alert("没有找到点击节点对应功能的记录数！");return}for(var f=0,j=h.length;f<j;f++){var e=h[f].cnt;var g=h[f].node_id;if(e>0){b.flagCurNode(g)}}};var a="";if(!Ext.isEmpty(b.queryValue)){a=encodeURIComponent(Ext.urlEncode(b.queryValue))}var d="funid=wfnav_graph&eventcode=queryflag&pagetype=formdes";d+="&graph_id="+b.graphId+"&datavalue="+a;Request.dataRequest(d,c)},disableFlag:function(){var a=this;var b=function(e){var d=a.editor.graph.getModel();Ext.iterate(e,function(g){var f=d.getCell(g.node_id);if(!Jxstar.validNode(g.fun_id)){a.disableNode(f)}});Ext.iterate(d.cells,function(h,f){if(f.is_disabled){return}var g=false;Ext.iterate(e,function(i){if(h==i.node_id){g=true;return}});if(!g&&a.isTask(f)){a.disableNode(f)}})};var c="funid=wfnav_graph&eventcode=queryfun&pagetype=formdes";c+="&graph_id="+a.graphId;Request.dataRequest(c,b)},flagCurNode:function(c){var a=this;var b=a.editor.graph.getModel();var d=b.getCell(c);b.beginUpdate();try{a.editor.graph.setCellStyles("strokeWidth","1",[d]);a.editor.graph.setCellStyles("strokeColor","red",[d]);a.editor.graph.setCellStyles("fillColor","#BB0000",[d])}finally{b.endUpdate()}},disableNode:function(a){var b=this;var c=b.editor.graph.getModel();c.beginUpdate();try{b.editor.graph.setCellStyles("strokeColor","#ECECEC",[a]);b.editor.graph.setCellStyles("fillColor","#BBBBBB",[a]);a.is_disabled=true}finally{c.endUpdate()}},moveNode:function(a,d){if(a==null){return}if(a.is_disabled){return}var b=this;var c=b.editor.graph.getModel();c.beginUpdate();try{b.editor.graph.setCellStyles("strokeColor",d?"#A1A1FF":"#C3D9FF",[a]);b.editor.graph.setCellStyles("fillColor",d?"#A1A1FF":"#C3D9FF",[a])}finally{c.endUpdate()}}});
/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
JxLabelPrint={};(function(){var a=function(f){if(Ext.isIE==false){JxHint.alert("条码标签打印控件不支持非IE浏览器！");return}var d=function(i){var g="";var h=function(k){if(k==null){return}if(k.nodeType==1||k.nodeType==2){g+="<"+k.nodeName+">"}if(k.attributes){for(j=0;j<k.attributes.length;j++){format=(j>0)?" ":":";g+=(format+k.attributes[j].nodeName+"="+k.attributes[j].text)}}if(k.hasChildNodes&&k.firstChild.nodeType!=3){for(var j=0;j<k.childNodes.length;j++){arguments.callee(k.childNodes[j]);if(j==k.childNodes.length-1){g+="</"+k.nodeName+">"}}}else{g+=k.text;g+="</"+k.nodeName+">";return}};h(i);return g};var e=new ActiveXObject("Msxml2.DOMDocument");e.async=false;e.load(f);root=e.documentElement;return d(root)};var b=function(d,p,q){var g=JxUtil.getSelectRows(d);if(!JxUtil.selected(g)){return}var l="";for(var k=0,e=g.length;k<e;k++){l+="<print>";for(var h=0,f=q.length;h<f;h++){var o=g[k].get(p+"__"+q[h]);o=Ext.isDate(o)?o.dateFormat("Y-m-d"):o;l+="<"+q[h]+">"+o+"</"+q[h]+">"}l+="</print>##"}if(l.length>2){l=l.substr(0,l.length-2)}return l};var c=function(){var e=Ext.get("printcodectl");if(Ext.isEmpty(e)){var d='<object id="printcodectl" classid="clsid:7EDC7219-8CEE-451f-9C21-98C812DD8CAE" width="0" height="0"></object>';e=Ext.getBody().insertHtml("beforeEnd",d,true)}return e.dom};Ext.apply(JxLabelPrint,{print:function(d,i,f,j,l,e){if(Ext.isIE==false){JxHint.alert("条码标签打印控件不支持非IE浏览器！");return}var k=a(i);var h=a(f);if(Ext.isEmpty(k)||Ext.isEmpty(h)){JxHint.alert("没有找到条码标签设置文件！");return}var g=b(d,j,l);if(e=="1"){c().printviewByXml(k,h,g)}else{c().printByXml(k,h,g)}}})})();var mxBasePath="public/lib/graph";var onMxInit=function(a){mxConnectionHandler.prototype.connectImage=new mxImage("public/lib/graph/images/connector.gif",16,16);a.graph.setTooltips(false);a.graph.setConnectable(true);a.graph.connectionHandler.setCreateTarget(true)};var mxCanvas=function(b){var a=function(){var g=document.getElementById("mx_splash");if(g!=null){try{mxEvent.release(g);mxEffects.fadeOut(g,100,true)}catch(h){g.parentNode.removeChild(g)}}};try{if(!mxClient.isBrowserSupported()){mxUtils.error("当前浏览器不支持绘图程序！",200,false)}else{var d=mxUtils.load(b).getDocumentElement();var c=new mxEditor(d);a()}}catch(f){a();mxUtils.alert("不能打开绘图程序："+f.message);throw f}return c};